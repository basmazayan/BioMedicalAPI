"use strict";var Nn=Object.defineProperty,Wn=Object.defineProperties,Zn=Object.getOwnPropertyDescriptors,Hi=Object.getOwnPropertySymbols,kn=Object.prototype.hasOwnProperty,Hn=Object.prototype.propertyIsEnumerable,ie=Math.pow,Xi=(ut,H,p)=>H in ut?Nn(ut,H,{enumerable:!0,configurable:!0,writable:!0,value:p}):ut[H]=p,J=(ut,H)=>{for(var p in H||(H={}))kn.call(H,p)&&Xi(ut,p,H[p]);if(Hi)for(var p of Hi(H))Hn.call(H,p)&&Xi(ut,p,H[p]);return ut},bt=(ut,H)=>Wn(ut,Zn(H));(self.webpackChunkbio_medical=self.webpackChunkbio_medical||[]).push([[6390],{71590:(ut,H,p)=>{p.d(H,{ZP:()=>it});var D=p(79076),E=p(6897),At=p(30627),lt=p(60161),C=p(22345),y=p(94911),z=(p(55865),p(96410)),xt=p(24921),mt=p(88031);let V=class extends E.Z{constructor(A){super(A),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=(0,At.Z)("mapview-transitions-duration"),this.effects=[]}set effect(A){if(this._get("effect")!==(A=A||"")){this._set("effect",A);try{this._transitionTo(Wt(A))}catch(R){this._transitionTo([]),C.Z.getLogger(this.declaredClass).warn("Invalid Effect",{effect:A,error:R})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(A){this._updateForScale(A)}get transitioning(){return null!==this._to}canTransitionTo(A){try{return this.scale>0&&ct(this._current,Wt(A),this.scale)}catch(R){return!1}}transitionStep(A,R){this._applyTimeTransition(A),this._updateForScale(R)}end(){this._applyTimeTransition(this.duration)}_transitionTo(A){this.scale>0&&ct(this._current,A,this.scale)?(this._final=A,this._to=(0,lt.d9)(A),function(A,R,U){var k,st;const Q=A.length>R.length?A:R,F=A.length>R.length?R:A,tt=F[F.length-1],rt=null!=(k=null==tt?void 0:tt.scale)?k:U,dt=null!=(st=null==tt?void 0:tt.effects)?st:[];for(let Y=F.length;Y<Q.length;Y++)F.push({scale:rt,effects:[...dt]});for(let Y=0;Y<Q.length;Y++)F[Y].scale=-1===F[Y].scale?U:F[Y].scale,Q[Y].scale=-1===Q[Y].scale?U:Q[Y].scale,(0,mt.uF)(F[Y].effects,Q[Y].effects)}(this._current,this._to,this.scale),this._from=(0,lt.d9)(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=A),this._set("effects",this._current[0]?(0,lt.d9)(this._current[0].effects):[])}_applyTimeTransition(A){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=A;const R=Math.min(1,this._time/this.duration);for(let U=0;U<this._current.length;U++){const k=this._current[U],st=this._from[U],Q=this._to[U];k.scale=Mt(st.scale,Q.scale,R);for(let F=0;F<k.effects.length;F++){const tt=k.effects[F],rt=st.effects[F],dt=Q.effects[F];tt.interpolate(rt,dt,R)}}1===R&&(this._current=this._final,this._set("effects",this._current[0]?(0,lt.d9)(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(A){if(this._set("scale",A),0===this._current.length)return;const R=this._current,U=this._current.length-1;let k,st,Q=1;if(1===R.length||A>=R[0].scale)st=k=R[0].effects;else if(A<=R[U].scale)st=k=R[U].effects;else for(let F=0;F<U;F++){const tt=R[F],rt=R[F+1];if(tt.scale>=A&&rt.scale<=A){Q=(A-tt.scale)/(rt.scale-tt.scale),k=tt.effects,st=rt.effects;break}}for(let F=0;F<this.effects.length;F++)this.effects[F].interpolate(k[F],st[F],Q)}};(0,D._)([(0,y.Cb)()],V.prototype,"_to",void 0),(0,D._)([(0,y.Cb)()],V.prototype,"duration",void 0),(0,D._)([(0,y.Cb)({value:""})],V.prototype,"effect",null),(0,D._)([(0,y.Cb)({readOnly:!0})],V.prototype,"effects",void 0),(0,D._)([(0,y.Cb)({readOnly:!0})],V.prototype,"hasEffects",null),(0,D._)([(0,y.Cb)({value:0})],V.prototype,"scale",null),(0,D._)([(0,y.Cb)({readOnly:!0})],V.prototype,"transitioning",null),V=(0,D._)([(0,z.j)("esri.layers.effects.EffectView")],V);const it=V;function Wt(A){const R=(0,xt.Q)(A)||[];return function(A){const R=A[0];return!!R&&"type"in R}(R)?[{scale:-1,effects:R}]:R}function ct(A,R,U){var k,st,Q,F;return null==(k=A[0])||!k.effects||null==(st=R[0])||!st.effects||!((-1===(null==(Q=A[0])?void 0:Q.scale)||-1===(null==(F=R[0])?void 0:F.scale))&&(A.length>1||R.length>1)&&U<=0)&&(0,mt.AS)(A[0].effects,R[0].effects)}function Mt(A,R,U){return A+(R-A)*U}},99345:(ut,H,p)=>{p.d(H,{W:()=>lt});var D=p(87266),E=p(71590),At=p(17821);class lt extends At.s{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this.children=[],this._effectView=null}get blendMode(){return this._blendMode}set blendMode(y){this._blendMode=y,this.requestRender()}get clips(){return this._clips}set clips(y){this._clips=y,this.children.forEach(I=>I.clips=y)}get computedEffects(){var y,I;return null!=(y=null==(I=this._effectView)?void 0:I.effects)?y:null}get effect(){var y,I;return null!=(y=null==(I=this._effectView)?void 0:I.effect)?y:""}set effect(y){(this._effectView||y)&&(this._effectView||(this._effectView=new E.ZP),this._effectView.effect=y,this.requestRender())}updateTransitionProperties(y,I){super.updateTransitionProperties(y,I),this._effectView&&(this._effectView.transitionStep(y,I),this._effectView.transitioning&&this.requestRender())}doRender(y){const I=this.createRenderParams(y);this.renderChildren(I)}addChild(y){return this.addChildAt(y,this.children.length)}addChildAt(y,I=this.children.length){if(!y||this.contains(y))return y;this._needsSort=!0;const z=y.parent;return z&&z!==this&&z.removeChild(y),I>=this.children.length?this.children.push(y):this.children.splice(I,0,y),this._childrenSet.add(y),y.parent=this,y.stage=this.stage,this!==this.stage&&(y.clips=this.clips),this.requestRender(),y}contains(y){return this._childrenSet.has(y)}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const y of this.children)this!==this.stage&&(y.clips=null),y.stage=null,y.parent=null;this.children.length=0}removeChild(y){return this.contains(y)?this.removeChildAt(this.children.indexOf(y)):y}removeChildAt(y){if(y<0||y>=this.children.length)return null;this._needsSort=!0;const I=this.children.splice(y,1)[0];return this._childrenSet.delete(I),this!==this.stage&&(I.clips=null),I.stage=null,I.parent=null,I}sortChildren(y){this._needsSort&&(this.children.sort(y),this._needsSort=!1)}_createTransforms(){return{dvs:(0,D.c)()}}onAttach(){super.onAttach();const y=this.stage;for(const I of this.children)I.stage=y}onDetach(){super.onDetach();for(const y of this.children)y.stage=null}renderChildren(y){for(const I of this.children)I.beforeRender(y);for(const I of this.children)I.processRender(y);for(const I of this.children)I.afterRender(y)}createRenderParams(y){return bt(J({},y),{blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:y.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition})}}},17821:(ut,H,p)=>{p.d(H,{s:()=>y});var D=p(33380),E=p(30627),At=p(18502),lt=p(7808);const C=1/(0,E.Z)("mapview-transitions-duration");class y extends D.Z{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(z){this._clips=z,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(z){this._opacity!==z&&(this._opacity=Math.min(1,Math.max(z,0)),this.requestRender())}get stage(){return this._stage}set stage(z){if(this._stage===z)return;const xt=this._stage;this._stage=z,z?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):xt.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return(0,At.Wi)(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(z){this._visible!==z&&(this._visible=z,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,lt.hh)(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,lt.hh)(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(z){this.updateTransitionProperties(z.deltaTime,z.state.scale)}afterRender(z){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var z;null==(z=this.parent)||z.removeChild(this)}setTransform(z){}processRender(z){this.stage&&this.computedVisible&&this.doRender(z)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.onDetach(),this.emit("detach")}updateTransitionProperties(z,xt){if(this.fadeTransitionEnabled){const mt=this._fadeOutResolver||!this.visible?0:this.opacity,ht=this.computedOpacity;if(ht===mt)this.computedVisible=this.visible;else{const V=z*C;this.computedOpacity=ht>mt?Math.max(mt,ht-V):Math.min(mt,ht+V),this.computedVisible=this.computedOpacity>0;const it=mt===this.computedOpacity;this.inFadeTransition=!it,it||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(z){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},23155:(ut,H,p)=>{p.d(H,{dk:()=>Zt,Gq:()=>Ut,a:()=>Ht,mE:()=>kt,m2:()=>F,qr:()=>q,jj:()=>st,hF:()=>Q});var D=p(61414),E=p(31620),At=p(44915);function st(N,g){switch(N){case E.LW.FILL:return Zt.from(g);case E.LW.LINE:return Ht.from(g);case E.LW.MARKER:return kt.from(g);case E.LW.TEXT:return q.from(g);case E.LW.LABEL:return Ut.from(g);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${N}`)}}function Q(N){switch(F.load(N).geometryType){case E.LW.MARKER:return new kt(N);case E.LW.FILL:return new Zt(N);case E.LW.LINE:return new Ht(N);case E.LW.TEXT:return new q(N);case E.LW.LABEL:return new Ut(N)}}class F{constructor(g){this._data=0,this._data=g}static load(g){const T=this.shared;return T.data=g,T}set data(g){this._data=g}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(g){this.setBits(g,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(g){this.setBit(20,g)}get sdf(){return!!this.bit(11)}set sdf(g){this.setBit(11,g)}get pattern(){return!!this.bit(12)}set pattern(g){this.setBit(12,g)}get textureBinding(){return this.bits(0,8)}set textureBinding(g){this.setBits(g,0,8)}get geometryTypeString(){switch(this.geometryType){case E.LW.FILL:return"fill";case E.LW.MARKER:return"marker";case E.LW.LINE:return"line";case E.LW.TEXT:return"text";case E.LW.LABEL:return"label";default:throw new D.Z(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(g,T){const et=1<<g;T?this._data|=et:this._data&=~et}bit(g){return(this._data&1<<g)>>g}setBits(g,T,et){for(let Dt=T,zt=0;Dt<et;Dt++,zt++)this.setBit(Dt,0!=(g&1<<zt))}bits(g,T){let et=0;for(let Dt=g,zt=0;Dt<T;Dt++,zt++)et|=this.bit(Dt)<<zt;return et}hasVV(){return!1}setVV(g,T){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf}}getVariationHash(){return this._data&~(7&this.textureBinding)}}F.shared=new F(0);const tt=N=>class extends N{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(g){this.setBit(16,g)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(g){this.setBit(17,g)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(g){this.setBit(18,g)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(g){this.setBit(19,g)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(g,T){super.setVV(g,T);const et=function(N,g){const T=E.X.SIZE_FIELD_STOPS|E.X.SIZE_MINMAX_VALUE|E.X.SIZE_SCALE_STOPS|E.X.SIZE_UNIT_VALUE,et=(N&(E.mf.FIELD_TARGETS_OUTLINE|E.mf.MINMAX_TARGETS_OUTLINE|E.mf.SCALE_TARGETS_OUTLINE|E.mf.UNIT_TARGETS_OUTLINE))>>>4;return g.isOutline||g.isOutlinedFill?T&et:T&~et}(g,T)&g;this.vvSizeMinMaxValue=!!(et&E.X.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(et&E.X.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(et&E.X.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(et&E.X.SIZE_SCALE_STOPS)}},rt=N=>class extends N{get vvRotation(){return 0!==this.bit(15)}set vvRotation(g){this.setBit(15,g)}hasVV(){return super.hasVV()||this.vvRotation}setVV(g,T){super.setVV(g,T),this.vvRotation=!T.isOutline&&!!(g&E.X.ROTATION)}},dt=N=>class extends N{get vvColor(){return 0!==this.bit(13)}set vvColor(g){this.setBit(13,g)}hasVV(){return super.hasVV()||this.vvColor}setVV(g,T){super.setVV(g,T),this.vvColor=!T.isOutline&&!!(g&E.X.COLOR)}},Y=N=>class extends N{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(g){this.setBit(14,g)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(g,T){super.setVV(g,T),this.vvOpacity=!T.isOutline&&!!(g&E.X.OPACITY)}};class Zt extends(dt(Y(tt(F)))){static load(g){const T=this.shared;return T.data=g,T}static from(g){const T=this.load(0);return T.geometryType=E.LW.FILL,T.dotDensity="dot-density"===g.stride.fill,T.simple="simple"===g.stride.fill,T.outlinedFill=g.isOutlinedFill,T.dotDensity||T.setVV(g.vvFlags,g),T.data}getVariation(){return bt(J({},super.getVariation()),{dotDensity:this.dotDensity,outlinedFill:this.outlinedFill,simple:this.simple,vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}get dotDensity(){return!!this.bit(15)}set dotDensity(g){this.setBit(15,g)}get simple(){return!!this.bit(22)}set simple(g){this.setBit(22,g)}get outlinedFill(){return!!this.bit(21)}set outlinedFill(g){this.setBit(21,g)}}Zt.shared=new Zt(0);class kt extends(dt(Y(rt(tt(F))))){static load(g){const T=this.shared;return T.data=g,T}static from(g){const T=this.load(0);return T.geometryType=E.LW.MARKER,T.setVV(g.vvFlags,g),T.data}getVariation(){return bt(J({},super.getVariation()),{vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}kt.shared=new kt(0);class Ht extends(dt(Y(tt(F)))){static load(g){const T=this.shared;return T.data=g,T}static from(g){const T=this.load(0);return T.geometryType=E.LW.LINE,T.setVV(g.vvFlags,g),T.data}getVariation(){return bt(J({},super.getVariation()),{vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}Ht.shared=new Ht(0);class q extends(dt(Y(rt(tt(F))))){static load(g){const T=this.shared;return T.data=g,T}static from(g){const T=this.load(0);return T.geometryType=E.LW.TEXT,T.setVV(g.vvFlags,g),T.data}getVariation(){return bt(J({},super.getVariation()),{vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}q.shared=new q(0);class Ut extends(tt(F)){static load(g){const T=this.shared;return T.data=g,T}static from(g){const T=this.load(0);return T.geometryType=E.LW.LABEL,T.setVV(g.vvFlags,g),T.mapAligned=(0,At.N)(g.placement),T.data}getVariation(){return bt(J({},super.getVariation()),{vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}Ut.shared=new Ut(0)},44915:(ut,H,p)=>{function D(E){switch(E){case"above-along":case"below-along":case"center-along":case"esriServerLinePlacementAboveAlong":case"esriServerLinePlacementBelowAlong":case"esriServerLinePlacementCenterAlong":return!0;default:return!1}}p.d(H,{N:()=>D})},28799:(ut,H,p)=>{p.r(H),p.d(H,{GraphicContainer:()=>gn.Z,GraphicsView2D:()=>mn.Z,LabelManager:()=>pn,MagnifierView2D:()=>An,MapViewNavigation:()=>Mn,Stage:()=>Xr});var D=p(49996),E=p(61414),At=p(37624),lt=p(30627),C=p(18502),y=p(54391),I=p(11652),z=p(15473),xt=p(62039),mt=p(38472),ht=p(87266),V=p(68292),it=p(41558),Wt=p(64345),ct=p(20316),j=p(1907),Mt=p(59450),wt=p(42909),R=(p(30905),p(80541)),U=p(36079),k=p(86550),st=p(3920),Q=p(99345),F=p(31620),tt=p(73886),rt=p(67495),dt=p(10673),Y=p(9927);const Zt={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = mod(v_accumulatedDistance / (v_patternSize.x * v_widthRatio), 1.0);\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = mod((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio), 1.0);\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * v_lineHalfWidth;\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};const Ht=new Y.Z(function(n){let t=Zt;return n.split("/").forEach(e=>{t&&(t=t[e])}),t});function q(n){return Ht.resolveIncludes(n)}const Ut=n=>(0,R.K)({ID:n.id,PATTERN:n.pattern}),N={shaders:n=>({vertexShader:Ut(n)+q("background/background.vert"),fragmentShader:Ut(n)+q("background/background.frag")})},g=n=>(0,R.K)({ID:n.id}),T={shaders:n=>({vertexShader:g(n)+q("circle/circle.vert"),fragmentShader:g(n)+q("circle/circle.frag")})},et=n=>(0,R.K)({ID:n.id,PATTERN:n.pattern}),Dt={shaders:n=>({vertexShader:et(n)+q("fill/fill.vert"),fragmentShader:et(n)+q("fill/fill.frag")})},zt=n=>(0,R.K)({ID:n.id}),ji={shaders:n=>({vertexShader:zt(n)+q("outline/outline.vert"),fragmentShader:zt(n)+q("outline/outline.frag")})},Ke=n=>(0,R.K)({ID:n.id,SDF:n.sdf}),$i={shaders:n=>({vertexShader:Ke(n)+q("icon/icon.vert"),fragmentShader:Ke(n)+q("icon/icon.frag")})},Qe=n=>(0,R.K)({ID:n.id,PATTERN:n.pattern,SDF:n.sdf}),Ki={shaders:n=>({vertexShader:Qe(n)+q("line/line.vert"),fragmentShader:Qe(n)+q("line/line.frag")})},Ye=n=>(0,R.K)({ID:n.id}),Qi={shaders:n=>({vertexShader:Ye(n)+q("text/text.vert"),fragmentShader:Ye(n)+q("text/text.frag")})};class Yi{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(t=>t.dispose()),this._programByKey.clear()}getMaterialProgram(t,e,i){const r=e.key<<3|this._getMaterialOptionsValue(e.type,i);if(this._programByKey.has(r))return this._programByKey.get(r);const a=this._getProgramTemplate(e.type),{shaders:o}=a,{vertexShader:l,fragmentShader:h}=o(i),c=e.getShaderHeader(),f=e.getShaderMain(),d=l.replace("#pragma header",c).replace("#pragma main",f),_=new dt.$(t,d,h,e.getAttributeLocations());return this._programByKey.set(r,_),_}_getMaterialOptionsValue(t,e){switch(t){case 0:{const i=e;return(i.pattern?1:0)<<1|(i.id?1:0)}case 1:{const i=e;return(i.pattern?1:0)<<1|(i.id?1:0)}case 2:return e.id?1:0;case 3:{const i=e;return(i.sdf?1:0)<<2|(i.pattern?1:0)<<1|(i.id?1:0)}case 4:{const i=e;return(i.sdf?1:0)<<1|(i.id?1:0)}case 5:case 6:return e.id?1:0;default:return 0}}_getProgramTemplate(t){switch(t){case 0:return N;case 5:return T;case 1:return Dt;case 4:return $i;case 3:return Ki;case 2:return ji;case 6:return Qi;default:return null}}}var _t=p(22575);const qe={shaders:{vertexShader:(0,_t.w)("bitBlit/bitBlit.vert"),fragmentShader:(0,_t.w)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class Je{constructor(){this._initialized=!1}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}render(t,e,i,r){t&&(this._initialized||this._initialize(t),t.setBlendFunctionSeparate(1,771,1,771),t.bindVAO(this._vertexArrayObject),t.useProgram(this._program),e.setSamplingMode(i),t.bindTexture(e,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",r),t.drawArrays(5,0,4),t.bindTexture(null,0),t.bindVAO())}_initialize(t){if(this._initialized)return!0;const e=qe.attributes,i=(0,R.H)(t,qe);if(!i)return!1;const a=new Int8Array(16);a[0]=-1,a[1]=-1,a[2]=0,a[3]=0,a[4]=1,a[5]=-1,a[6]=1,a[7]=0,a[8]=-1,a[9]=1,a[10]=0,a[11]=1,a[12]=1,a[13]=1,a[14]=1,a[15]=1;const o=new k.Z(t,e,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},{geometry:ct.Z.createVertex(t,35044,a)});return this._program=i,this._vertexArrayObject=o,this._initialized=!0,!0}}var ti=p(61791);const qi=n=>{let t="";t+=n[0].toUpperCase();for(let e=1;e<n.length;e++){const i=n[e];i===i.toUpperCase()?(t+="_",t+=i):t+=i.toUpperCase()}return t},ei=n=>{const t={};for(const e in n)t[qi(e)]=n[e];return(0,R.K)(t)},ii=(n,t,e)=>{const i=n+n.substring(n.lastIndexOf("/")),r=t+t.substring(t.lastIndexOf("/"));return{attributes:e,shaders:a=>({vertexShader:ei(a)+(0,_t.w)(`${i}.vert`),fragmentShader:ei(a)+(0,_t.w)(`${r}.frag`)})}},si=n=>n===F.jx.HITTEST||n===F.jx.LABEL_ALPHA,ts=({rendererInfo:n,drawPhase:t},e,i,r)=>`${e.getVariationHash()}-${r.join(".")}-${(n=>(si(n)?1:0)|(n===F.jx.HIGHLIGHT?2:0))(t)}-${n.getVariationHash()}-${(0,C.pC)(i)&&i.join(".")}`;class is{constructor(t){this._programByKey=new Map,this._programCache=new ti.Z(t)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(t,e,i=[],r=[]){const a=e.vsPath+"."+e.fsPath+JSON.stringify(i)+r.join(".");if(this._programByKey.has(a))return this._programByKey.get(a);const o=r.reduce((_,m)=>bt(J({},_),{[m]:t.context.driverTest[m]}),{}),l=J(J({},i.map(_=>"string"==typeof _?{name:_,value:!0}:_).reduce((_,m)=>bt(J({},_),{[m.name]:m.value}),{})),o),{vsPath:h,fsPath:c,attributes:f}=e,d=this._programCache.getProgram(ii(h,c,f),l);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(a,d),d}getMaterialProgram(t,e,i,r,a,o=["ignoresSamplerPrecision"]){const l=ts(t,e,a,o);if(this._programByKey.has(l))return this._programByKey.get(l);const h=((n,t,e,i)=>{const r=i.reduce((o,l)=>bt(J({},o),{[l]:n.context.driverTest[l]}),{}),a=J(bt(J(J({},t.getVariation()),n.rendererInfo.getVariation()),{highlight:n.drawPhase===F.jx.HIGHLIGHT,id:si(n.drawPhase)}),r);if((0,C.pC)(e))for(const o of e)a[o]=!0;return a})(t,e,a,o),c=this._programCache.getProgram(ii(i,i,r),h);if(!c)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(l,c),c}}var ss=p(76925),se=p(30351),rs=p(40295),re=p(22345),nt=p(7808),Ct=p(75244),ns=p(74181),as=p(20655),$=p(30603);var yt=p(16434);class fe{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new yt.Z(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new yt.Z;let i=null,r=-1;for(let a=0;a<this._free.length;++a){const o=this._free[a];t<=o.width&&e<=o.height&&(null===i||o.y<=i.y&&o.x<=i.x)&&(i=o,r=a)}return null===i?new yt.Z:(this._free.splice(r,1),i.width<i.height?(i.width>t&&this._free.push(new yt.Z(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new yt.Z(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new yt.Z(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new yt.Z(i.x,i.y+e,t,i.height-e))),new yt.Z(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}const fs=n=>Math.floor(n/256);class vs{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=i,this._binPack=new fe(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const t=[117,149,181,207,207,181,149,117],e=[];for(let r=0;r<t.length;r++){const a=t[r];for(let o=0;o<11;o++)e.push(a)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)};this._recordGlyph(i)}getGlyphItems(t,e,i){var r=this;return(0,D.Z)(function*(){const a=r._getGlyphCache(t);return yield r._fetchRanges(t,e,i),e.map(o=>r._getMosaicItem(a,t,o))})()}bind(t,e,i,r){const a=this._getTexture(t,i);a.setSamplingMode(e),this._dirties[i]&&(a.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(a,r)}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,e){return this._textures[e]||(this._textures[e]=new U.Z(t,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[e]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(t,e,i){var r=this;return(0,D.Z)(function*(){const a=function(n){const t=new Set;for(const e of n)t.add(fs(e));return t}(e),o=[];a.forEach(l=>{o.push(r._fetchRange(t,l,i))}),yield Promise.all(o)})()}_fetchRange(t,e,i){var r=this;return(0,D.Z)(function*(){if(e>256)return null;const a=t+e;return function(n,t,e){return n.has(t)||n.set(t,e().then(()=>{n.delete(t)}).catch(i=>{n.delete(t),(0,nt.H9)(i)})),n.get(t)}(r._rangePromises,a,()=>r._glyphSource.getRange(t,e,i))})()}_getMosaicItem(t,e,i){if(!t[i]){const r=this._glyphSource.getGlyph(e,i);if(!r||!r.metrics)return n=i,{rect:new yt.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:n,sdf:!0};const a=this._recordGlyph(r),o=this._currentPage,l=r.metrics;t[i]={rect:a,page:o,metrics:l,code:i,sdf:!0},this._invalidate()}var n;return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(0===e.width)i=new yt.Z(0,0,0,0);else{const r=3,a=e.width+2*r,o=e.height+2*r;i=this._binPack.allocate(a,o),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new fe(this.width-4,this.height-4),i=this._binPack.allocate(a,o));const l=this._glyphData[this._currentPage],h=t.bitmap;let c,f;if(h)for(let d=0;d<o;d++){c=a*d,f=this.width*(i.y+d)+i.x;for(let _=0;_<a;_++)l[f+_]=h[c+_]}(0,lt.Z)("esri-glyph-debug")&&this._showDebugPage(l)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),r=new ImageData(this.width,this.height),a=r.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let o=0;o<t.length;++o)a[4*o+0]=t[o],a[4*o+1]=0,a[4*o+2]=0,a[4*o+3]=255;i.putImageData(r,0,0),document.body.appendChild(e)}}var bs=p(96545);class ys{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const i=e.getMessage();let r,a,o,l,h,c,f;for(;i.next();)switch(i.tag()){case 1:r=i.getUInt32();break;case 2:a=i.getBytes();break;case 3:o=i.getUInt32();break;case 4:l=i.getUInt32();break;case 5:h=i.getSInt32();break;case 6:c=i.getSInt32();break;case 7:f=i.getUInt32();break;default:i.skip()}i.release(),r&&(this._metrics[r]={width:o,height:l,left:h,top:c,advance:f},this._bitmaps[r]=a);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class xs{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class ws{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const r=this._getFontStack(t);if(r.getRange(e))return Promise.resolve();const a=256*e,o=a+255,l=this._baseURL.replace("{fontstack}",t).replace("{range}",a+"-"+o);return(0,se.default)(l,J({responseType:"array-buffer"},i)).then(h=>{r.addRange(e,new ys(new bs.Z(new Uint8Array(h.data),new DataView(h.data))))})}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const r=Math.floor(e/256);if(r>256)return;const a=i.getRange(r);return a?{metrics:a.getMetrics(e),bitmap:a.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new xs),e}}var ri=p(33821);const ne=1e20;class Ts{constructor(t){this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,e,i=31){this._initSVG();const r=this.createSVGString(t);return new Promise((a,o)=>{const l=new Image;l.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(r),l.onload=()=>{l.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(l,0,0,this.size,this.size);const c=this._context.getImageData(0,0,this.size,this.size),f=new Uint8Array(this.size*this.size*4);for(let d=0;d<this.size*this.size;d++){const _=c.data[4*d+3]/255;this._gridOuter[d]=1===_?0:0===_?ne:ie(Math.max(0,.5-_),2),this._gridInner[d]=1===_?ne:0===_?0:ie(Math.max(0,_-.5),2)}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let d=0;d<this.size*this.size;d++){const _=this._gridOuter[d]-this._gridInner[d];(0,ri.I)(.5-_/(2*i),f,4*d)}a(f)};const h=e&&e.signal;h&&(0,nt.fu)(h,()=>o((0,nt.zE)()))})}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}}createSVGString(t){this._initSVG();const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d",t),this._svg.appendChild(e);const i=e.getBBox(),r=i.width/i.height,a=this.size/2;let o,l,h,c;if(r>1){l=o=a/i.width;const m=a*(1/r);h=this.size/4,c=a-m/2}else o=l=a/i.height,h=a-a*r/2,c=this.size/4;const f=-i.x*o+h,d=-i.y*l+c;e.setAttribute("style",`transform: matrix(${o}, 0, 0, ${l}, ${f}, ${d})`);const _=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(e),_}_edt(t,e,i){const r=this._f,a=this._d,o=this._v,l=this._z;for(let h=0;h<e;h++){for(let c=0;c<i;c++)r[c]=t[c*e+h];this._edt1d(r,a,o,l,i);for(let c=0;c<i;c++)t[c*e+h]=a[c]}for(let h=0;h<i;h++){for(let c=0;c<e;c++)r[c]=t[h*e+c];this._edt1d(r,a,o,l,e);for(let c=0;c<e;c++)t[h*e+c]=Math.sqrt(a[c])}}_edt1d(t,e,i,r,a){i[0]=0,r[0]=-ne,r[1]=+ne;for(let o=1,l=0;o<a;o++){let h=(t[o]+o*o-(t[i[l]]+i[l]*i[l]))/(2*o-2*i[l]);for(;h<=r[l];)l--,h=(t[o]+o*o-(t[i[l]]+i[l]*i[l]))/(2*o-2*i[l]);l++,i[l]=o,r[l]=h,r[l+1]=+ne}for(let o=0,l=0;o<a;o++){for(;r[l+1]<o;)l++;e[o]=(o-i[l])*(o-i[l])+t[i[l]]}}}var ni=p(76272);function Xt(n){return n&&"static"===n.type}class Me{constructor(t,e,i,r=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=i,this._requestRender=t,r>0&&(this._maxItemSize=r),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new fe(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),o=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*o)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,r,a,o){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let l,h,c;if(Xt(i))[l,h,c]=this._allocateImage(e[0],e[1]);else{l=new yt.Z(0,0,e[0],e[1]),h=this._mosaicPages.length;const d=void 0;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:d})}if(l.width<=0||l.height<=0)return null;const f={rect:l,width:e[0],height:e[1],sdf:a,simplePattern:o,pixelRatio:1,page:h};return this._mosaicRects.set(t,f),Xt(i)&&this._copy({rect:l,spriteSize:e,spriteData:i.data,page:h,pageSize:c,repeat:r,sdf:a}),f}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const r=e.width,a=e.height,o=$.fL,l=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+o)/l[0],(i.y+o)/l[1]],br:[(i.x+o+r)/l[0],(i.y+o+a)/l[1]],page:e.page}}bind(t,e,i=0,r=0){const a=this._mosaicPages[i],o=a.mosaicsData;let l=a.texture;if(l||(l=function(n,t,e){return Xt(t)?new U.Z(n,{pixelFormat:6408,dataType:5121,width:e[0],height:e[1]},new Uint8Array(t.data.buffer)):new U.Z(n,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:e[0],height:e[1]},null)}(t,o,a.size),a.texture=l),l.setSamplingMode(e),Xt(o))t.bindTexture(l,r),a.dirty&&(l.setData(new Uint8Array(o.data.buffer)),l.generateMipmap());else{const h=o.data,c=h.bindFrame(t,l,r);(0,C.pC)(this._requestRender)&&c&&h.frameCount>0&&this._requestRender.requestRender(),h.bindFrame(t,l,r)}a.dirty=!1}static _copyBits(t,e,i,r,a,o,l,h,c,f,d){let _=r*e+i,m=h*o+l;if(d){m-=o;for(let v=-1;v<=f;v++,_=((v+f)%f+r)*e+i,m+=o)for(let u=-1;u<=c;u++)a[m+u]=t[_+(u+c)%c]}else for(let v=0;v<f;v++){for(let u=0;u<c;u++)a[m+u]=t[_+u];_+=e,m+=o}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!Xt(e.mosaicsData))throw new E.Z("mapview-invalid-resource","unsuitable data type!");const r=t.spriteData,a=i.data;a&&r||console.error("Source or target images are uninitialized!"),Me._copyBits(r,t.spriteSize[0],0,0,a,t.pageSize[0],t.rect.x+$.fL,t.rect.y+$.fL,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*$.fL,e+=2*$.fL;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const a=ie(2,Math.ceil((0,ni.k3)(t))),o=ie(2,Math.ceil((0,ni.k3)(e))),l=new yt.Z(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*o)},size:[a,o],dirty:!0,texture:void 0}),[l,this._mosaicPages.length-1,[a,o]]}const r=this._binPack.allocate(t,e);if(r.width<=0){const a=this._mosaicPages[this._currentPage];return!a.dirty&&Xt(a.mosaicsData)&&(a.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new fe(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[r,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;Xt(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}var at=p(67201);const ai=new Uint32Array(256);for(let n=0;n<256;n++){let t=n;for(let e=0;e<8;e++)t=0!=(1&t)?3988292384^t>>>1:t>>>1;ai[n]=t}const Fs=new E.Z("Not a PNG"),oi=new E.Z("Not an animated PNG"),Ce=new Uint8Array([137,80,78,71,13,10,26,10]);function li(n){const t=n.constructor===Uint8Array?n:new Uint8Array(n);return!Ce.some((e,i)=>e!==t[i])}class Re{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static create(t,e){return(0,D.Z)(function*(){const i=new Re;try{yield i._load(t,e)}catch(r){if(!(0,nt.D_)(r))return new E.Z("invalid-resource",`Could not load PNG: ${r.message}`)}return i})()}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(t,e,i){t.bindTexture(e,i);const r=this.frameChanged();if(!r)return!1;const a=this.currentFrame,o=a.frameData,l=e.descriptor;return(a.left||a.top||a.width!==l.width||a.height!==l.height)&&e.setData(null),e.updateData(0,a.left,a.top,a.width,a.height,o),this.updateUsedFrame(),r}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}_load(t,e){var i=this;return(0,D.Z)(function*(){try{const r=function(n,t){const e=new Uint8Array(t);if(Ce.some((d,_)=>d!==e[_]))return Fs;let i=!1;if(pe(e,d=>!(i="acTL"===d)),!i)return oi;const r=[],a=[];let o=null,l=null,h=0;if(pe(e,(d,_,m,v)=>{const u=new DataView(_.buffer);switch(d){case"IHDR":o=_.subarray(m+8,m+8+v),n.width=u.getUint32(m+8),n.height=u.getUint32(m+12);break;case"acTL":n.numPlays=u.getUint32(m+8+4);break;case"fcTL":{l&&(n.frames.push(l),h++),l=new Cs,l.width=u.getUint32(m+8+4),l.height=u.getUint32(m+8+8),l.left=u.getUint32(m+8+12),l.top=u.getUint32(m+8+16);const b=u.getUint16(m+8+20);let M=u.getUint16(m+8+22);0===M&&(M=100),l.delay=1e3*b/M,l.delay<=10&&(l.delay=100),n.playTime+=l.delay,l.disposeOp=u.getUint8(m+8+24),l.blendOp=u.getUint8(m+8+25),l.dataParts=[],0===h&&2===l.disposeOp&&(l.disposeOp=1);break}case"fdAT":l&&l.dataParts.push(_.subarray(m+8+4,m+8+v));break;case"IDAT":l&&l.dataParts.push(_.subarray(m+8,m+8+v));break;case"IEND":a.push(hi(_,m,12+v));break;default:r.push(hi(_,m,12+v))}}),0===n.frames.length)return oi;n.frameCount=n.frames.length;const c=new Blob(r),f=new Blob(a);return n.frames.forEach(d=>{let _=[];_.push(Ce),o.set(ci(d.width),0),o.set(ci(d.height),4),_.push(ui("IHDR",o)),_.push(c),d.dataParts.forEach(m=>_.push(ui("IDAT",m))),_.push(f),d.data=new Blob(_,{type:"image/png"}),delete d.dataParts,_=null}),n}(i,t);if(r!==i)return r;i._resizeCanvas=document.createElement("canvas"),i._resizeCanvas.width=i.width,i._resizeCanvas.height=i.height,yield Promise.all(i.frames.map(a=>a.createImage(i._resizeCanvas)))}catch(r){if(!(0,nt.D_)(r))return new E.Z("invalid-resource","Could not parse PNG")}i.play()})()}_play(){let t,e;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout(()=>this._play(),t)}}class Cs{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}createImage(t){var e=this;return(0,D.Z)(function*(){if(null===e.imageData)return new Promise((i,r)=>{const a=URL.createObjectURL(e.data),o=document.createElement("img");o.onload=()=>{URL.revokeObjectURL(a),e.imageData=function(n,t){t.width=n.width,t.height=n.height;const e=t.getContext("2d");e.drawImage(n,0,0,n.width,n.height);const i=e.getImageData(0,0,n.width,n.height),r=new Uint8Array(i.data);let a;for(let o=0;o<r.length;o+=4)a=r[o+3]/255,r[o]=r[o]*a,r[o+1]=r[o+1]*a,r[o+2]=r[o+2]*a;return new ImageData(new Uint8ClampedArray(r.buffer),n.width,n.height)}(o,t),i()},o.onerror=()=>{URL.revokeObjectURL(a),e.imageData=null,r(new Error("Image creation error"))},o.src=a})})()}}function pe(n,t){const e=new DataView(n.buffer);let i,r,a,o=8;do{r=e.getUint32(o),i=Os(n,o+4,4),a=t(i,n,o,r),o+=12+r}while(!1!==a&&"IEND"!==i&&o<n.length)}function Os(n,t,e){const i=Array.prototype.slice.call(n.subarray(t,t+e));return String.fromCharCode.apply(String,i)}function hi(n,t,e){const i=new Uint8Array(e);return i.set(n.subarray(t,t+e)),i}function ui(n,t){const e=n.length+t.length,i=new Uint8Array(e+8),r=new DataView(i.buffer);r.setUint32(0,t.length),i.set(function(n){const t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}(n),4),i.set(t,8);const a=function(n,t=0,e=n.length-t){let i=-1;for(let r=t,a=t+e;r<a;r++)i=i>>>8^ai[255&(i^n[r])];return-1^i}(i,4,e);return r.setUint32(e+4,a),i}function ci(n){return new Uint8Array([n>>>24&255,n>>>16&255,n>>>8&255,255&n])}const Kt_GCExt=249,Kt_COMMENT=254,Kt_APPExt=255,Kt_UNKNOWN=1,Kt_IMAGE=44,Kt_EOF=59;function di(n){if(!n||0===n.byteLength)return!1;const t=n.constructor===Uint8Array?n:new Uint8Array(n);return 71===t[0]&&73===t[1]&&70===t[2]&&56===t[3]}class Be{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static create(t,e){return(0,D.Z)(function*(){const i=new Be;try{yield i._load(t,e)}catch(r){if(!(0,nt.D_)(r))return new E.Z("invalid-resource",`Could not load PNG: ${r.message}`)}return i})()}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(t,e,i){t.bindTexture(e,i);const r=this.frameChanged();if(r){const a=this.currentFrame,o=a.frameData;e.updateData(0,0,0,a.width,a.height,o),this.updateUsedFrame()}return r}seekFrame(t){clearTimeout(this.timerID),this.currentFrameNumber=t%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(t){clearTimeout(this.timerID),t<0&&(t=0),t*=1e3,t%=this.length;let e=0;for(;t>this.frames[e].time+this.frames[e].delay&&e<this.frames.length;)e+=1;this.currentFrameNumber=e,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}_load(t,e){var i=this;return(0,D.Z)(function*(){try{i.loading=!0,yield i._parse(t,e),i.loading=!1,i.play()}catch(r){if(!(0,nt.D_)(r))return new E.Z("invalid-resource","Could not parse gif!")}})()}_parse(t,e){const i=new Ds(t);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const r=i.data[i.pos++];return this.globalColourCount=1<<1+(7&r),i.pos++,i.pos++,128&r&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise((a,o)=>{setTimeout(()=>this._parseBlock(i,a,o,e),0)})}_parseBlock(t,e,i,r){var a=this;return(0,D.Z)(function*(){if(r&&r.signal&&(0,nt.Hc)(r.signal))return void i((0,nt.zE)());const o=t.data[t.pos++];if(o===Kt_IMAGE){if(a._parseImg(t),a.firstFrameOnly)return a._finishedLoading(),void e()}else{if(o===Kt_EOF)return a._finishedLoading(),void e();a._parseExt(t)}"function"==typeof a.onprogress&&a.onprogress({bytesRead:t.pos,totalBytes:t.data.length,frame:a.frames.length}),setTimeout(()=>a._parseBlock(t,e,i,r),0)})()}_parseColourTable(t,e){const i=[];for(let r=0;r<t;r++)i.push([e.data[e.pos++],e.data[e.pos++],e.data[e.pos++]]);return i}_parseImg(t){const i={};this.frames.push(i),i.disposalMethod=this.disposalMethod,i.time=this.length,i.delay=10*this.delayTime,this.length+=i.delay,this.transparencyGiven?i.transparencyIndex=this.transparencyIndex:i.transparencyIndex=void 0,i.leftPos=t.data[t.pos++]+(t.data[t.pos++]<<8),i.topPos=t.data[t.pos++]+(t.data[t.pos++]<<8),i.width=t.data[t.pos++]+(t.data[t.pos++]<<8),i.height=t.data[t.pos++]+(t.data[t.pos++]<<8);const r=t.data[t.pos++];i.localColourTableFlag=!!(128&r),i.localColourTableFlag&&(i.localColourTable=this._parseColourTable(1<<1+(7&r),t)),this.pixelBufSize!==i.width*i.height&&(this.pixelBuf=new Uint8Array(i.width*i.height),this.pixelBufSize=i.width*i.height),this._lzwDecode(t.data[t.pos++],t.readSubBlocksB()),64&r?(i.interlaced=!0,(a=>{const o=this.pixelBufSize/a;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let l=0;for(let h=0;h<4;h++)for(let c=this.interlaceOffsets[h];c<o;c+=this.interlaceSteps[h])this.deinterlaceBuf.set(this.pixelBuf.subarray(l,l+a),c*a),l+=a})(i.width)):i.interlaced=!1,this._processFrame(i)}_lzwDecode(t,e){let i,r,a,o,l,h,c,f,d;a=r=0;let _=[];const m=1<<t,v=m+1;for(o=t+1,d=!1;!d;){for(h=l,l=0,i=0;i<o;i++)e[a>>3]&1<<(7&a)&&(l|=1<<i),a++;if(l===m){for(_=[],o=t+1,i=0;i<m;i++)_[i]=[i];_[m]=[],_[v]=null}else{if(l===v)return void(d=!0);for(l>=_.length?_.push(_[h].concat(_[h][0])):h!==m&&_.push(_[h].concat(_[l][0])),c=_[l],f=c.length,i=0;i<f;i++)this.pixelBuf[r++]=c[i];_.length===1<<o&&o<12&&o++}}}_processFrame(t){t.image=document.createElement("canvas"),t.image.width=this.width,t.image.height=this.height,t.ctx=t.image.getContext("2d");const e=t.localColourTableFlag?t.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=t);const i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||t.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const r=t.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),a=t.transparencyIndex,o=r.data,l=t.interlaced?this.deinterlaceBuf:this.pixelBuf,h=l.length;let c,f,d=0;for(let _=0;_<h;_++)c=l[_],f=e[c],a!==c?(o[d++]=f[0],o[d++]=f[1],o[d++]=f[2],o[d++]=255):(i&&(o[d+3]=0),d+=4);t.ctx.putImageData(r,t.leftPos,t.topPos),this.lastFrame=t}_parseExt(t){const e=t.data[t.pos++];e===Kt_GCExt?this._parseGCExt(t):e===Kt_COMMENT?this.comment+=t.readSubBlocks():e===Kt_APPExt?this._parseAppExt(t):(e===Kt_UNKNOWN&&(t.pos+=13),t.readSubBlocks())}_parseAppExt(t){t.pos+=1,"NETSCAPE"===t.getString(8)?t.pos+=8:(t.pos+=3,t.readSubBlocks())}_parseGCExt(t){t.pos++;const e=t.data[t.pos++];this.disposalMethod=(28&e)>>2,this.transparencyGiven=!!(1&e),this.delayTime=t.data[t.pos++]+(t.data[t.pos++]<<8),this.transparencyIndex=t.data[t.pos++],t.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let t,e;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout(()=>this._play(),t)):this.pause()}_setCurrentFrame(t){const e=this.frames[t];this.currentFrame={frameData:e.image,top:0,left:0,width:this.width,height:this.height}}}class Ds{constructor(t){this.pos=0,this.data=new Uint8ClampedArray(t),this.len=this.data.length}getString(t){let e="";for(;t--;)e+=String.fromCharCode(this.data[this.pos++]);return e}readSubBlocks(){let t,e,i="";do{for(e=t=this.data[this.pos++];e--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return i}readSubBlocksB(){let t,e;const i=[];do{for(e=t=this.data[this.pos++];e--;)i.push(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return i}}var Oe=p(81476);var Us=p(28123);const _i=(0,ns.c)(),fi="arial-unicode-ms-regular",pi=re.Z.getLogger("esri.views.2d.engine.webgl.TextureManager");function Ae(){return(Ae=(0,D.Z)(function*(n,t){const e=(0,at.Gr)(n);let i;const r=";base64,";if(e.includes(r)){const a=e.indexOf(r)+r.length,o=e.substring(a),l=atob(o),h=new Uint8Array(l.length);for(let c=0;c<l.length;c++)h[c]=l.charCodeAt(c);i=h.buffer}else try{const{data:a}=yield(0,se.default)(e,J({responseType:"array-buffer"},t));i=a}catch(a){if(!(0,nt.D_)(a))return new E.Z("mapview-invalid-resource",`Could not fetch requested resource at ${e}`)}return i})).apply(this,arguments)}function mi(n,t){const e=Math.round((0,Ct.F2)(t)*window.devicePixelRatio),i=e>=128?2:4;return Math.min(n,e*i)}const De=(n,t,e)=>pi.error(new E.Z(n,t,e));class Ie{constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}static fromMosaic(t,e){return new Ie(t,e.page,e.sdf)}}class Ls{constructor(t,e){var i;this.resourceManager=e,this._invalidFontsMap=new Map,this._sdfConverter=new Ts(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Us.e({concurrency:10,process:(i=(0,D.Z)(function*(r,a){(0,nt.k_)(a);try{return yield(0,se.default)(r,{responseType:"image",signal:a})}catch(o){throw(0,nt.D_)(o)?o:new E.Z("mapview-invalid-resource",`Could not fetch requested resource at ${r}`,o)}}),function(a,o){return i.apply(this,arguments)})}),this._spriteMosaic=new Me(t,2048,2048,500),this._glyphSource=new ws(`${ss.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new vs(1024,1024,this._glyphSource),this._rasterizer=new as.Z(e)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}rasterizeItem(t,e,i,r){var a=this;return(0,D.Z)(function*(){if((0,C.Wi)(t))return De("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const o=yield a._rasterizeText(t,i,r);return o.forEach(l=>a._setTextureBinding(F.Un.GLYPH,l)),{glyphMosaicItems:o}}default:{if((0,at.Ll)(t))return De("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const o=yield a._rasterizeSpriteSymbol(t,e,r);return(0,Oe.ok)(o)&&o&&a._setTextureBinding(F.Un.SPRITE,o),{spriteMosaicItem:o}}}})()}bindTextures(t,e,i,r=!1){if(0===i.textureBinding)return;const a=this._bindingInfos[i.textureBinding-1],o=a.page,l=r?9987:9729;switch(a.mosaicType){case F.Un.SPRITE:{const h=this.sprites.getWidth(o),c=this.sprites.getHeight(o),f=(0,V.s)(_i,h,c);return this._spriteMosaic.bind(t,l,o,$.D3),e.setUniform1i("u_texture",$.D3),void e.setUniform2fv("u_mosaicSize",f)}case F.Un.GLYPH:{const h=this.glyphs.width,c=this.glyphs.height,f=(0,V.s)(_i,h,c);return this._glyphMosaic.bind(t,l,o,$.Al),e.setUniform1i("u_texture",$.Al),void e.setUniform2fv("u_mosaicSize",f)}default:pi.error("mapview-texture-manager",`Cannot handle unknown type ${a.mosaicType}`)}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const r=Ie.fromMosaic(t,e),a=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,a),this._bindingInfos.push(r)}e.textureBinding=this._hashToBindingIndex.get(i)}_rasterizeText(t,e,i){var r=this;return(0,D.Z)(function*(){let a,o;if("cim"in t){const c=t;a=c.fontName,o=c.text}else{const c=t;a=function(n){const t=function(n){if(!n.weight)return"";switch(n.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(n)+function(n){if(!n.style)return"";switch(n.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}(n);return function(n){const t=n.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}(n.family)+(t.length>0?t:"-regular")}(c.font),o=c.text}const l=r._invalidFontsMap.has(a),h=e||(0,at.Jq)((0,rs.E)(o)[0]);try{return yield r._glyphMosaic.getGlyphItems(l?fi:a,h,i)}catch(c){return De("mapview-invalid-resource",`Couldn't find font ${a}. Falling back to Arial Unicode MS Regular`),r._invalidFontsMap.set(a,!0),r._glyphMosaic.getGlyphItems(fi,h,i)}})()}_rasterizeSpriteSymbol(t,e,i){var r=this;return(0,D.Z)(function*(){if((0,at.Gg)(t))return null;const a=function(n){switch(n.type){case"esriSMS":return`${n.style}.${n.path}`;case"esriSLS":return`${n.style}.${n.cap}`;case"esriSFS":return`${n.style}`;case"esriPFS":case"esriPMS":return n.imageData?`${n.imageData}${n.width}${n.height}`:`${n.url}${n.width}${n.height}`;default:return"mosaicHash"in n?n.mosaicHash:JSON.stringify(n)}}(t);if(r._spriteMosaic.has(a))return r._spriteMosaic.getSpriteItem(a);if((0,at.sG)(t)||(0,at.HX)(t))return r._handleAsyncResource(a,t,i);const l=r._rasterizer.rasterizeJSONResource(t,1);if(l){const{size:h,image:c,sdf:f,simplePattern:d}=l;return r._addItemToMosaic(a,h,{type:"static",data:c},(0,at.js)(t),f,d)}return new E.Z("TextureManager","unrecognized or null rasterized image")})()}_handleAsyncResource(t,e,i){var r=this;return(0,D.Z)(function*(){if(r._ongoingRasterizations.has(t))return r._ongoingRasterizations.get(t);let a;a=(0,at.sG)(e)?r._handleSVG(e,t,i):r._handleImage(e,t,i),r._ongoingRasterizations.set(t,a);try{yield a,r._ongoingRasterizations.delete(t)}catch(o){r._ongoingRasterizations.delete(t)}return a})()}_handleSVG(t,e,i){var r=this;return(0,D.Z)(function*(){const a=[126,126],o=yield r._sdfConverter.draw(t.path,i);return r._addItemToMosaic(e,a,{type:"static",data:new Uint32Array(o.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(t,e,i){var r=this;return(0,D.Z)(function*(){const a=yield function(n,t){return Ae.apply(this,arguments)}(t,i);if((0,Oe.ok)(a)){const o=di(a),l=li(a);if(!o&&!l)return new E.Z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let h;try{o&&function(n){if(!n||0===n.byteLength)return!1;const t=new Uint8Array(n);if(!di(t))return!1;let e=0;for(let i=0,r=t.length-9;i<r&&(0!==t[i]||33!==t[i+1]||249!==t[i+2]||4!==t[i+3]||0!==t[i+8]||44!==t[i+9]&&33!==t[i+9]||(e++,!(e>1)));++i);return e>1}(a)?h=yield Be.create(a,i):l&&function(n){const t=new Uint8Array(n);if(!li(t))return!1;let e=!1;return pe(t,i=>!(e="acTL"===i)),e}(a)&&(h=yield Re.create(a,i))}catch(d){if(!(0,nt.D_)(d))return new E.Z("mapview-invalid-resource","Could not fetch requested resource!")}if(h&&(0,Oe.ok)(h))return r._addItemToMosaic(e,[h.width,h.height],{type:"animated",data:h},(0,at.js)(t),!1,!1);const c=new Blob([a],{type:o?"image/gif":"image/png"}),f=yield r._imageFromBlob(c);if(f&&f instanceof HTMLImageElement){let d=f.width,_=f.height;"esriPMS"===t.type&&(d=Math.round(mi(f.width,(0,at.Ub)(t))),_=Math.round(f.height*(d/f.width)));const m="cim"in t?t.cim.colorSubstitutions:void 0,{size:v,sdf:u,image:b}=r._rasterizer.rasterizeImageResource(d,_,f,m);return r._addItemToMosaic(e,v,{type:"static",data:b},(0,at.js)(t),u,!1)}}return new E.Z("mapview-invalid-resource","Could not handle resource!")})()}_handleImage(t,e,i){var r=this;return(0,D.Z)(function*(){if((0,at.DQ)(t)||(0,at.iw)(t))return r._handleGIFOrPNG(t,e,i);const a=(0,at.Gr)(t);try{let l;const h=r.resourceManager.getResource(a);if((0,C.pC)(h))l=h;else{const{data:u}=yield r._imageRequestQueue.push(a,J({},i));l=u}if((0,at.TB)(a))if("width"in t&&"height"in t)l.width=(0,Ct.F2)(t.width),l.height=(0,Ct.F2)(t.height);else if("cim"in t){var o;const u=t.cim;l.width=(0,Ct.F2)(null!=(o=u.width)?o:u.scaleX*u.size),l.height=(0,Ct.F2)(u.size)}if(!l.width||!l.height)return null;let c=l.width,f=l.height;"esriPMS"===t.type&&(c=Math.round(mi(l.width,(0,at.Ub)(t))),f=Math.round(l.height*(c/l.width)));const d="cim"in t?t.cim.colorSubstitutions:void 0,{size:_,sdf:m,image:v}=r._rasterizer.rasterizeImageResource(c,f,l,d);return r._addItemToMosaic(e,_,{type:"static",data:v},(0,at.js)(t),m,!1)}catch(l){if(!(0,nt.D_)(l))return new E.Z("mapview-invalid-resource",`Could not fetch requested resource at ${a}. ${l.message}`)}})()}_imageFromBlob(t){var e=this;return(0,D.Z)(function*(){const i=window.URL.createObjectURL(t);try{const{data:r}=yield e._imageRequestQueue.push(i);return window.URL.revokeObjectURL(i),r}catch(r){if(window.URL.revokeObjectURL(i),!(0,nt.D_)(r))return new E.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`);throw r}})()}_addItemToMosaic(t,e,i,r,a,o){return this._spriteMosaic.addSpriteItem(t,e,i,r,a,o)}}var Qt=p(33559);class me{constructor(){this.name=this.constructor.name}}class Vs extends me{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(t,e){if(!e.size)return;const{context:i,renderingOptions:r}=t;this._quad||(this._quad=new Qt.Z(i,[0,0,1,0,0,1,1,1]));const a=i.getBoundFramebufferObject(),{x:o,y:l,width:h,height:c}=i.getViewport();e.bindTextures(i);const f=e.getBlock($.xl);if((0,C.Wi)(f))return;const d=f.getFBO(i),_=f.getFBO(i,1);i.setViewport(0,0,e.size,e.size),this._computeDelta(t,_,r.labelsAnimationTime),this._updateAnimationState(t,_,d),i.bindFramebuffer(a),i.setViewport(o,l,h,c)}_computeDelta(t,e,i){const{context:r,painter:a,displayLevel:o}=t,l=a.materialManager.getProgram(t,this._desc,["delta"]);r.bindFramebuffer(e),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.useProgram(l),l.setUniform1i("u_maskTexture",$.iJ),l.setUniform1i("u_sourceTexture",$.nM),l.setUniform1f("u_timeDelta",t.deltaTime),l.setUniform1f("u_animationTime",i),l.setUniform1f("u_zoomLevel",Math.round(10*o)),this._quad.draw()}_updateAnimationState(t,e,i){const{context:r,painter:a}=t,o=a.materialManager.getProgram(t,this._desc,["update"]);r.bindTexture(e.colorTexture,1),r.useProgram(o),o.setUniform1i("u_sourceTexture",1),r.bindFramebuffer(i),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const gi=n=>`#define ${(n=>n.replace("-","_").toUpperCase())(n)}\n`,vi={attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:n=>({vertexShader:gi(n)+(0,_t.w)("blend/blend.vert"),fragmentShader:gi(n)+(0,_t.w)("blend/blend.frag")})},bi=re.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Ns{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(t,e,i,r,a){const{context:o,drawPhase:l}=t;if(this._setupShader(o),r&&"normal"!==r&&l!==F.jx.LABEL)return void this._drawBlended(t,e,i,r,a);const h=this._programCache.getProgram(vi,"normal");if(!h)return void bi.error(new E.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));o.useProgram(h),e.setSamplingMode(i),o.bindTexture(e,0),h.setUniform1i("u_layerTexture",0),h.setUniform1f("u_opacity",a),o.setBlendingEnabled(!0),o.setBlendFunction(1,771);const c=this._quad;c.draw(),c.unbind()}_drawBlended(t,e,i,r,a){const{context:o,state:l,pixelRatio:h,inFadeTransition:c}=t,{size:f}=l,d=o.getBoundFramebufferObject();let _,m;if((0,C.pC)(d)){const M=d.descriptor;_=M.width,m=M.height}else _=Math.round(h*f[0]),m=Math.round(h*f[1]);this._createOrResizeTexture(t,_,m);const v=this._backBufferTexture;d.copyToTexture(0,0,_,m,0,0,v),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const u=this._programCache.getProgram(vi,r);if(!u)return void bi.error(new E.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${r}`));o.useProgram(u),v.setSamplingMode(i),o.bindTexture(v,0),u.setUniform1i("u_backbufferTexture",0),e.setSamplingMode(i),o.bindTexture(e,1),u.setUniform1i("u_layerTexture",1),u.setUniform1f("u_opacity",a),u.setUniform1f("u_inFadeOpacity",c?1:0),o.setBlendFunction(1,0);const b=this._quad;b.draw(),b.unbind(),o.setBlendFunction(1,771)}_setupShader(t){this._programCache||(this._programCache=new ti.Z(t),this._quad||(this._quad=new Qt.Z(t,[-1,-1,1,-1,-1,1,1,1])))}_createOrResizeTexture(t,e,i){const{context:r}=t;null!==this._backBufferTexture&&e===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(e,i):this._backBufferTexture=new U.Z(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:e,height:i}),this._size[0]=e,this._size[1]=i)}}class yi extends me{constructor(t){super(),this.name=this.constructor.name,this.defines=[t]}dispose(){}bind({context:t,painter:e}){this._prev=t.getBoundFramebufferObject();const{width:i,height:r}=t.getViewport(),a=e.getFbos(i,r).effect0;t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}draw(t,e){const{context:i,painter:r}=t,a=r.getPostProcessingEffects(e),o=i.getBoundFramebufferObject();for(const{postProcessingEffect:l,effect:h}of a)l.draw(t,o,h);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),r.blitTexture(i,o.colorTexture,9728),i.setStencilTestEnabled(!0)}}const Ws=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],Zs=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Lt_outlineWidth=.7,Lt_outerHaloWidth=.7,Lt_innerHaloWidth=.7,Lt_outlinePosition=0,ze=re.Z.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");const Hs=[0,0,0,0];class Xs{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:Lt_outlinePosition,outlineWidth:Lt_outlineWidth,innerHaloWidth:Lt_innerHaloWidth,outerHaloWidth:Lt_outerHaloWidth},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}setHighlightOptions(t){const e=this._convertedHighlightOptions;!function(n,t){t.fillColor[0]=n.color.r/255,t.fillColor[1]=n.color.g/255,t.fillColor[2]=n.color.b/255,t.fillColor[3]=n.color.a,n.haloColor?(t.outlineColor[0]=n.haloColor.r/255,t.outlineColor[1]=n.haloColor.g/255,t.outlineColor[2]=n.haloColor.b/255,t.outlineColor[3]=n.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=n.fillOpacity,t.outlineColor[3]*=n.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=Lt_outlineWidth,t.outerHaloWidth=Lt_outerHaloWidth,t.innerHaloWidth=Lt_innerHaloWidth,t.outlinePosition=Lt_outlinePosition}(t,e);const i=e.outlinePosition-e.outlineWidth/2-e.outerHaloWidth,r=e.outlinePosition-e.outlineWidth/2,a=e.outlinePosition+e.outlineWidth/2,o=e.outlinePosition+e.outlineWidth/2+e.innerHaloWidth,l=1*Math.sqrt(Math.PI/2),h=Math.abs(i)>l?Math.round(10*(Math.abs(i)-l))/10:0,c=Math.abs(o)>l?Math.round(10*(Math.abs(o)-l))/10:0;let f;h&&!c?ze.error("The outer rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!h&&c?ze.error("The inner rim of the highlight is "+c+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):h&&c&&ze.error("The highlight is "+Math.max(h,c)+"px away from the edge of the feature; consider reducing some width values.");const d=[void 0,void 0,void 0,void 0];function _(v,u,b){d[0]=(1-b)*v[0]+b*u[0],d[1]=(1-b)*v[1]+b*u[1],d[2]=(1-b)*v[2]+b*u[2],d[3]=(1-b)*v[3]+b*u[3]}const{texelData:m}=this;for(let v=0;v<256;++v)f=i+v/255*(o-i),f<i?(d[4*v+0]=0,d[4*v+1]=0,d[4*v+2]=0,d[4*v+3]=0):f<r?_(Hs,e.outlineColor,(f-i)/(r-i)):f<a?[d[0],d[1],d[2],d[3]]=e.outlineColor:f<o?_(e.outlineColor,e.fillColor,(f-a)/(o-a)):[d[4*v+0],d[4*v+1],d[4*v+2],d[4*v+3]]=e.fillColor,m[4*v+0]=255*d[0],m[4*v+1]=255*d[1],m[4*v+2]=255*d[2],m[4*v+3]=255*d[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=o,this.shadeTexChanged=!0}applyHighlightOptions(t,e){this.shadeTex||(this.shadeTex=new U.Z(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),t.bindTexture(this.shadeTex,$.Jw),e.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const js={shaders:{vertexShader:(0,_t.w)("highlight/textured.vert"),fragmentShader:(0,_t.w)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},$s={shaders:{vertexShader:(0,_t.w)("highlight/textured.vert"),fragmentShader:(0,_t.w)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class Ks{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(t,e){t.bindTexture(e,$.QU),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ws),t.bindVAO(this._resources.quadVAO),t.drawArrays(5,0,4),t.bindVAO()}finalBlur(t,e){t.bindTexture(e,$.QU),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Zs),t.bindVAO(this._resources.quadVAO),t.drawArrays(5,0,4),t.bindVAO()}renderHighlight(t,e,i){t.bindTexture(e,$.QU),t.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(t,this._resources.highlightProgram),t.bindVAO(this._resources.quadVAO),t.setBlendingEnabled(!0),t.setBlendFunction(1,771),t.drawArrays(5,0,4),t.bindVAO()}_initialize(t,e,i){this._width=e,this._height=i;const r=ct.Z.createVertex(t,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),a=new k.Z(t,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:r}),o=(0,R.H)(t,js),l=(0,R.H)(t,$s);o.setUniform1i("u_texture",$.QU),o.setUniform1i("u_shade",$.Jw),o.setUniform1f("u_sigma",1),l.setUniform1i("u_texture",$.QU),l.setUniform1f("u_sigma",1),this._resources={quadGeometry:r,quadVAO:a,highlightProgram:o,blurProgram:l}}setup(t,e,i){this._resources?(this._width=e,this._height=i):this._initialize(t,e,i)}}function xi(n,t,e){const i=new U.Z(n,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:t,height:e,samplingMode:9729});return[i,new j.Z(n,{colorTarget:0,depthStencilTarget:2},i)]}class Qs{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(t,e,i){this._width=e,this._height=i;const[r,a]=xi(t,e,i),[o,l]=xi(t,e,i);this._resources={sharedBlur1Tex:r,sharedBlur1Fbo:a,sharedBlur2Tex:o,sharedBlur2Fbo:l}}setup(t,e,i){!this._resources||this._width===e&&this._height===i||this.dispose(),this._resources||this._initialize(t,e,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class Ys extends me{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new Ks,this._hlGradient=new Xs,this._width=void 0,this._height=void 0,this._hlSurfaces=new Qs,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new Je}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(t){const{context:e,painter:i}=t,{width:r,height:a}=e.getViewport(),o=i.getFbos(r,a).effect0;this.setup(t,r,a),e.bindFramebuffer(o),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:t},e,i){this._width=e,this._height=i;const r=e%4,a=i%4;e+=r<2?-r:4-r,i+=a<2?-a:4-a,this._adjustedWidth=e,this._adjustedHeight=i,this._boundFBO=t.getBoundFramebufferObject();const o=Math.round(1*e),l=Math.round(1*i);this._hlRenderer.setup(t,o,l),this._hlSurfaces.setup(t,o,l)}draw({context:t}){const e=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,e.colorTexture,9728,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(t){this._hlGradient.setHighlightOptions(t)}}class qs extends me{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){(0,C.pC)(this._fbo)&&this._fbo.dispose()}bind({context:t,painter:e}){const{width:i,height:r}=t.getViewport();this._boundFBO=t.getBoundFramebufferObject();const a=e.getFbos(i,r).effect0;t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind({context:t}){t.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:t,state:e,pixelRatio:i},r,a=$.Jc){const o=t.getBoundFramebufferObject(),l=e.size[1]*i,h=Math.round(a*i),c=h/2,f=h/2;this._ensureBuffer(h),r.forEach((d,_)=>{const m=new Map,v=Math.floor(_.x*i-h/2),u=Math.floor(l-_.y*i-h/2);o.readPixels(v,u,h,h,6408,5121,this._buf);for(let M=0;M<this._buf32.length;M++){const w=this._buf32[M];if(4294967295!==w&&0!==w){const S=M%h,x=h-Math.floor(M/h),B=(c-S)*(c-S)+(f-x)*(f-x),O=m.has(w)?m.get(w):4294967295;m.set(w,Math.min(B,O))}}const b=Array.from(m).sort((M,w)=>M[1]-w[1]).map(M=>M[0]);d.resolve(b),r.delete(_)})}_ensureBuffer(t){this._lastSize!==t&&(this._lastSize=t,this._buf=new Uint8Array(4*t*t),this._buf32=new Uint32Array(this._buf.buffer))}}const Js=[1,0],tr=[0,1],er=[1,.8,.6,.4,.2],ir=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class sr{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let t=0;t<this._nMips;t++)this._mipsFBOs[t]&&(this._mipsFBOs[t].horizontal.dispose(),this._mipsFBOs[t].vertical.dispose());this._mipsFBOs=null}}draw(t,e,i){const{width:r,height:a}=e,{context:o,painter:l}=t,{materialManager:h}=l,c=o.gl,f=this._programDesc,{strength:d,radius:_,threshold:m}=i;this._quad||(this._quad=new Qt.Z(o,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(t,r,a),o.setStencilTestEnabled(!1),o.setBlendingEnabled(!0),o.setBlendFunction(1,771),o.setStencilWriteMask(0);const v=this._quad;v.bind(),o.bindFramebuffer(this._intensityFBO);const u=h.getProgram(t,f.luminosityHighPass);o.useProgram(u),o.bindTexture(e.colorTexture,0),u.setUniform1i("u_texture",0),u.setUniform3fv("u_defaultColor",[0,0,0]),u.setUniform1f("u_defaultOpacity",0),u.setUniform1f("u_luminosityThreshold",m),u.setUniform1f("u_smoothWidth",.01);const b=[Math.round(r/2),Math.round(a/2)];o.setViewport(0,0,b[0],b[1]),o.setClearColor(0,0,0,0),o.clear(c.COLOR_BUFFER_BIT),v.draw(),o.setBlendingEnabled(!1);let M=this._intensityFBO.colorTexture;for(let x=0;x<this._nMips;x++){const B=h.getProgram(t,f.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[x]}]);o.useProgram(B),o.bindTexture(M,x+1),B.setUniform1i("u_colorTexture",x+1),B.setUniform2fv("u_texSize",b),B.setUniform2fv("u_direction",Js),o.setViewport(0,0,b[0],b[1]);const O=this._mipsFBOs[x];o.bindFramebuffer(O.horizontal),v.draw(),M=O.horizontal.colorTexture,o.bindFramebuffer(O.vertical),o.bindTexture(M,x+1),B.setUniform2fv("u_direction",tr),v.draw(),M=O.vertical.colorTexture,b[0]=Math.round(b[0]/2),b[1]=Math.round(b[1]/2)}o.setViewport(0,0,r,a);const w=h.getProgram(t,f.composite,[{name:"nummips",value:5}]);o.bindFramebuffer(this._compositeFBO),o.useProgram(w),w.setUniform1f("u_bloomStrength",d),w.setUniform1f("u_bloomRadius",_),w.setUniform1fv("u_bloomFactors",er),w.setUniform3fv("u_bloomTintColors",ir),o.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),w.setUniform1i("u_blurTexture1",1),o.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),w.setUniform1i("u_blurTexture2",2),o.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),w.setUniform1i("u_blurTexture3",3),o.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),w.setUniform1i("u_blurTexture4",4),o.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),w.setUniform1i("u_blurTexture5",5),v.draw(),o.bindFramebuffer(e),o.setBlendingEnabled(!0);const S=h.getProgram(t,f.blit);o.useProgram(S),o.bindTexture(this._compositeFBO.colorTexture,6),S.setUniform1i("u_texture",6),o.setBlendFunction(1,1),v.draw(),v.unbind(),o.setBlendFunction(1,771),o.setStencilTestEnabled(!0)}_createOrResizeResources(t,e,i){const{context:r}=t;if(this._compositeFBO&&this._size[0]===e&&this._size[1]===i)return;this._size[0]=e,this._size[1]=i;const a=[Math.round(e/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(e,i):this._compositeFBO=new j.Z(r,{colorTarget:0,depthStencilTarget:0,width:e,height:i}),this._intensityFBO?this._intensityFBO.resize(a[0],a[1]):this._intensityFBO=new j.Z(r,{colorTarget:0,depthStencilTarget:0,width:a[0],height:a[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:a[0],height:a[1]});for(let o=0;o<this._nMips;o++)this._mipsFBOs[o]?(this._mipsFBOs[o].horizontal.resize(a[0],a[1]),this._mipsFBOs[o].vertical.resize(a[0],a[1])):this._mipsFBOs[o]={horizontal:new j.Z(r,{colorTarget:0,depthStencilTarget:0,width:a[0],height:a[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:a[0],height:a[1]}),vertical:new j.Z(r,{colorTarget:0,depthStencilTarget:0,width:a[0],height:a[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:a[0],height:a[1]})},a[0]=Math.round(a[0]/2),a[1]=Math.round(a[1]/2)}}const rr=[1,0],nr=[0,1];class ar{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(t,e,i){const{context:r}=t,{type:a,radius:o}=i;if(0===o)return;this._createOrResizeResources(t),this._quad||(this._quad=new Qt.Z(r,[-1,-1,1,-1,-1,1,1,1]));const l=this._quad;l.bind(),"blur"===a?this._gaussianBlur(t,e,o):this._radialBlur(t,e),l.unbind()}_gaussianBlur(t,e,i){const{context:r,state:a,painter:o,pixelRatio:l}=t,{size:h}=a,{materialManager:c}=o,f=this._programDesc,d=this._quad,_=[Math.round(l*h[0]),Math.round(l*h[1])],m=this._blurFBO,v=c.getProgram(t,f.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);r.useProgram(v),r.setBlendingEnabled(!1),r.bindFramebuffer(m),r.bindTexture(e.colorTexture,4),v.setUniform1i("u_colorTexture",4),v.setUniform2fv("u_texSize",_),v.setUniform2fv("u_direction",rr),v.setUniform1f("u_sigma",i),d.draw(),r.bindFramebuffer(e),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.bindTexture(m.colorTexture,5),v.setUniform1i("u_colorTexture",5),v.setUniform2fv("u_direction",nr),d.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.setStencilTestEnabled(!0)}_radialBlur(t,e){const{context:i,painter:r}=t,{materialManager:a}=r,o=this._programDesc,l=this._quad,h=this._blurFBO;i.bindFramebuffer(h);const c=a.getProgram(t,o.radialBlur);i.useProgram(c),i.setBlendingEnabled(!1),i.bindTexture(e.colorTexture,4),c.setUniform1i("u_colorTexture",4),l.draw(),i.bindFramebuffer(e),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const f=a.getProgram(t,o.blit);i.useProgram(f),i.bindTexture(h.colorTexture,5),f.setUniform1i("u_texture",5),i.setBlendFunction(1,771),l.draw()}_createOrResizeResources(t){const{context:e,state:i,pixelRatio:r}=t,{size:a}=i,o=Math.round(r*a[0]),l=Math.round(r*a[1]);this._blurFBO&&this._size[0]===o&&this._size[1]===l||(this._size[0]=o,this._size[1]=l,this._blurFBO?this._blurFBO.resize(o,l):this._blurFBO=new j.Z(e,{colorTarget:0,depthStencilTarget:0,width:o,height:l},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:o,height:l}))}}class or{constructor(){this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(t,e,i){const{width:r,height:a}=e;this._createOrResizeResources(t,r,a);const{context:o,painter:l}=t,{materialManager:h}=l,c=this._programDesc,f=this._quad,d=i.colorMatrix;f.bind();const _=this._layerFBOTexture;o.bindFramebuffer(e),e.copyToTexture(0,0,r,a,0,0,_),o.setBlendingEnabled(!1),o.setStencilTestEnabled(!1);const m=h.getProgram(t,c);o.useProgram(m),o.bindTexture(_,2),m.setUniformMatrix4fv("u_coefficients",d),m.setUniform1i("u_colorTexture",2),f.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(1,771),o.setStencilTestEnabled(!0),f.unbind()}_createOrResizeResources(t,e,i){const{context:r}=t;this._layerFBOTexture&&this._size[0]===e&&this._size[1]===i||(this._size[0]=e,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(e,i):this._layerFBOTexture=new U.Z(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:e,height:i}),this._quad||(this._quad=new Qt.Z(r,[-1,-1,1,-1,-1,1,1,1])))}}const lr=[1,0],hr=[0,1];class ur{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/drop-shadow",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(t,e,i){const{context:r,state:a,painter:o}=t,{materialManager:l}=o,h=this._programDesc,c=e.width,f=e.height,d=[Math.round(c/2),Math.round(f/2)],{blurRadius:_,offsetX:m,offsetY:v,color:u}=i,b=[(0,Ct.F2)(m/2),(0,Ct.F2)(v/2)];this._createOrResizeResources(t,c,f,d);const M=this._horizontalBlurFBO,w=this._verticalBlurFBO;r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1);const S=this._layerFBOTexture;e.copyToTexture(0,0,c,f,0,0,S),this._quad||(this._quad=new Qt.Z(r,[-1,-1,1,-1,-1,1,1,1])),r.setViewport(0,0,d[0],d[1]);const x=this._quad;x.bind(),r.setBlendingEnabled(!1);const B=l.getProgram(t,h.blur,[{name:"radius",value:Math.ceil(_)}]);r.useProgram(B),r.bindFramebuffer(M),r.bindTexture(e.colorTexture,4),B.setUniformMatrix3fv("u_displayViewMat3",a.displayMat3),B.setUniform2fv("u_offset",b),B.setUniform1i("u_colorTexture",4),B.setUniform2fv("u_texSize",d),B.setUniform2fv("u_direction",lr),B.setUniform1f("u_sigma",_),x.draw(),r.bindFramebuffer(w),r.bindTexture(M.colorTexture,5),B.setUniformMatrix3fv("u_displayViewMat3",a.displayMat3),B.setUniform2fv("u_offset",[0,0]),B.setUniform1i("u_colorTexture",5),B.setUniform2fv("u_direction",hr),x.draw(),r.bindFramebuffer(e),r.setViewport(0,0,c,f);const O=l.getProgram(t,h.composite);r.useProgram(O),r.bindTexture(w.colorTexture,2),O.setUniform1i("u_blurTexture",2),r.bindTexture(S,3),O.setUniform1i("u_layerFBOTexture",3),O.setUniform4fv("u_shadowColor",[u[3]*(u[0]/255),u[3]*(u[1]/255),u[3]*(u[2]/255),u[3]]),x.draw(),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!0),r.setBlendFunction(1,771),x.unbind()}_createOrResizeResources(t,e,i,r){const{context:a}=t;this._horizontalBlurFBO&&this._size[0]===e&&this._size[1]===i||(this._size[0]=e,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(r[0],r[1]):this._horizontalBlurFBO=new j.Z(a,{colorTarget:0,depthStencilTarget:0,width:r[0],height:r[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:r[0],height:r[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(r[0],r[1]):this._verticalBlurFBO=new j.Z(a,{colorTarget:0,depthStencilTarget:0,width:r[0],height:r[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:r[0],height:r[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(e,i):this._layerFBOTexture=new U.Z(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:e,height:i}))}}class cr{constructor(){this._size=[0,0]}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(t,e,i){const{width:r,height:a}=e;this._createOrResizeResources(t,r,a);const{context:o,painter:l}=t,{amount:h}=i,c=o.gl,f=this._layerFBOTexture;o.bindFramebuffer(e),e.copyToTexture(0,0,r,a,0,0,f),o.setBlendingEnabled(!0),o.setStencilTestEnabled(!1),o.setDepthTestEnabled(!1),o.setClearColor(0,0,0,0),o.clear(c.COLOR_BUFFER_BIT),l.blitTexture(o,f,9728,h)}_createOrResizeResources(t,e,i){const{context:r}=t;this._layerFBOTexture&&this._size[0]===e&&this._size[1]===i||(this._size[0]=e,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(e,i):this._layerFBOTexture=new U.Z(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!1,width:e,height:i}))}}function dr(n){switch(n){case"bloom":case"blur":case"opacity":case"drop-shadow":return n;default:return"colorize"}}const _r={colorize:()=>new or,blur:()=>new ar,bloom:()=>new sr,opacity:()=>new cr,"drop-shadow":()=>new ur};class fr{constructor(t){this._requestRender=t,this._effectMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach(t=>t.dispose()),this._effectMap.clear()}getPostProcessingEffects(t){if(!t||0===t.length)return[];const e=[];for(const i of t){const r=dr(i.type);let a=this._effectMap.get(r);a||(a=_r[r](),this._effectMap.set(r,a)),e.push({postProcessingEffect:a,effect:i})}return e}}var pr=p(45072);class mr{constructor(t,e){var i;this.brushes=t,this.name=e.name,this.drawPhase=e.drawPhase||F.jx.MAP,this._targetFn=e.target,this.effects=e.effects||[],this.enableDefaultDraw=null!=(i=e.enableDefaultDraw)?i:()=>!0}render(t){const{context:e,profiler:i}=t,r=this._targetFn(),a=this.drawPhase&t.drawPhase;if(i.recordPassStart(this.name),a){this.enableDefaultDraw()&&this._doRender(t,r),i.recordPassEnd();for(const o of this.effects){if(!o.enable())continue;const l=o.apply;i.recordPassStart(this.name+"."+l.name),i.recordBrushStart(l.name);const h=o.args&&o.args(),{x:c,y:f,width:d,height:_}=e.getViewport(),m=e.getBoundFramebufferObject();l.bind(t,h),this._doRender(t,r,l.defines),l.draw(t,h),l.unbind(t,h),e.bindFramebuffer(m),e.setViewport(c,f,d,_),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(t,e,i){if(!(0,C.Wi)(e))if((0,pr.zG)(e)){for(const r of e)if(r.visible)for(const a of this.brushes)t.profiler.recordBrushStart(a.name),a.prepareState(t,r,i),a.draw(t,r,i),t.profiler.recordBrushEnd()}else for(const r of this.brushes)t.profiler.recordBrushStart(r.name),r.prepareState(t,e,i),r.draw(t,e,i),t.profiler.recordBrushEnd()}}const gr={[F.LW.FILL]:rt.U.fill,[F.LW.LINE]:rt.U.line,[F.LW.MARKER]:rt.U.marker,[F.LW.TEXT]:rt.U.text};class vr{constructor(t,e,i){this.context=t,this._blitRenderer=new Je,this._brushCache=new Map,this._vtlMaterialManager=new Yi,this._blendEffect=new Ns,this.effects={highlight:new Ys,hittest:new qs,integrate:new Vs,insideEffect:new yi("inside"),outsideEffect:new yi("outside")},this.materialManager=new is(t),this.textureManager=new Ls(e,i),this._effectsManager=new fr(e)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(t){this._renderTarget=t}getFbos(t,e){if(t!==this._lastWidth||e!==this._lastHeight){if(this._lastWidth=t,this._lastHeight=e,this._fbos){for(const o in this._fbos)this._fbos[o].resize(t,e);return this._fbos}const i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:t,height:e},r={colorTarget:0,depthStencilTarget:3},a=new tt.Z(this.context,{width:t,height:e,internalFormat:34041});this._stencilBuf=a,this._fbos={output:new j.Z(this.context,r,i,a),blend:new j.Z(this.context,r,i,a),effect0:new j.Z(this.context,r,i,a)}}return this._fbos}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(t,e=null){const{width:i,height:r}=t.getViewport();this._prevFBO=t.getBoundFramebufferObject();const a=this.getFbos(i,r);if(t.bindFramebuffer(a.output),t.setColorMask(!0,!0,!0,!0),t.setDepthWriteEnabled(!0),(0,C.pC)(e)){const{r:o,g:l,b:h,a:c}=e.color;t.setClearColor(c*o/255,c*l/255,c*h/255,c)}else t.setClearColor(0,0,0,0);t.setClearDepth(1),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT),t.setDepthWriteEnabled(!1)}beforeRenderLayer(t,e,i){const{context:r,blendMode:a,effects:o,requireFBO:l,drawPhase:h}=t;if(l||wi(h,a,o,i))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setDepthWriteEnabled(!0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);else{const c=this._getOutputFBO();r.bindFramebuffer(c)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(e),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)}compositeLayer(t,e){const{context:i,blendMode:r,effects:a,requireFBO:o,drawPhase:l}=t;if(o||wi(l,r,a,e)){(0,C.pC)(a)&&a.length>0&&l===F.jx.MAP&&this._applyEffects(t,a);const h=this._getOutputFBO();i.bindFramebuffer(h),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),i.setColorMask(!0,!0,!0,!0);const c=(0,C.Wi)(r)||l===F.jx.HIGHLIGHT?"normal":r;this._blendEffect.draw(t,this._fbos.blend.colorTexture,9728,c,e)}}renderLayers(t){if(t.bindFramebuffer(this._prevFBO),!this._fbos)return;const e=this._getOutputFBO();t.setStencilTestEnabled(!1),t.setStencilWriteMask(0),this.blitTexture(t,e.colorTexture,9728)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach(t=>t.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const t in this._fbos)this._fbos[t]&&this._fbos[t].dispose();if(this.effects)for(const t in this.effects)this.effects[t]&&this.effects[t].dispose();this._effectsManager.dispose(),this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(t){const e=gr[t];let i=this._brushCache.get(e);return void 0===i&&(i=new e,this._brushCache.set(e,i)),this._brushCache.get(e)}renderObject(t,e,i,r){const a=rt.U[i];if(!a)return null;let o=this._brushCache.get(a);void 0===o&&(o=new a,this._brushCache.set(a,o)),o.prepareState(t,e,r),o.draw(t,e,r)}renderObjects(t,e,i,r){const a=rt.U[i];if(!a)return null;let o=this._brushCache.get(a);void 0===o&&(o=new a,this._brushCache.set(a,o)),o.drawMany(t,e,r)}registerRenderPass(t){const e=t.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new mr(e,t)}setHighlightOptions(t){this.effects.highlight.setHighlightOptions(t)}blitTexture(t,e,i,r=1){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),t.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(t,e,i,r)}getPostProcessingEffects(t){return this._effectsManager.getPostProcessingEffects(t)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(t,e){const{context:i}=t,r=this._effectsManager.getPostProcessingEffects(e);for(const{postProcessingEffect:a,effect:o}of r)i.bindFramebuffer(this._fbos.blend),a.draw(t,this._fbos.blend,o)}}function wi(n,t,e,i){return n!==F.jx.HIGHLIGHT&&(1!==i||(0,C.pC)(t)&&"normal"!==t||(0,C.pC)(e)&&e.length>0)}var br=p(94546),yr=p(33380),Tt=p(31555);class Ti{constructor(t,e,i,r,a,o,l,h){this.createQuery=t,this.resultAvailable=e,this.getResult=i,this.disjoint=r,this.beginTimeElapsed=a,this.endTimeElapsed=o,this.createTimestamp=l,this.timestampBits=h}}function Ei(n,t){if(t.disjointTimerQuery)return null;let e=n.getExtension("EXT_disjoint_timer_query_webgl2");return e&&(0,Tt.Z)(n)?new Ti(()=>n.createQuery(),i=>n.getQueryParameter(i,n.QUERY_RESULT_AVAILABLE),i=>n.getQueryParameter(i,n.QUERY_RESULT),()=>n.getParameter(e.GPU_DISJOINT_EXT),i=>n.beginQuery(e.TIME_ELAPSED_EXT,i),()=>n.endQuery(e.TIME_ELAPSED_EXT),i=>e.queryCounterEXT(i,e.TIMESTAMP_EXT),()=>n.getQuery(e.TIMESTAMP_EXT,e.QUERY_COUNTER_BITS_EXT)):(e=n.getExtension("EXT_disjoint_timer_query"),e?new Ti(()=>e.createQueryEXT(),i=>e.getQueryObjectEXT(i,e.QUERY_RESULT_AVAILABLE_EXT),i=>e.getQueryObjectEXT(i,e.QUERY_RESULT_EXT),()=>n.getParameter(e.GPU_DISJOINT_EXT),i=>e.beginQueryEXT(e.TIME_ELAPSED_EXT,i),()=>e.endQueryEXT(e.TIME_ELAPSED_EXT),i=>e.queryCounterEXT(i,e.TIMESTAMP_EXT),()=>e.getQueryEXT(e.TIMESTAMP_EXT,e.QUERY_COUNTER_BITS_EXT)):null)}const Et=(0,lt.Z)("esri-2d-profiler");class xr{constructor(t,e){if(this._events=new yr.Z,this._entries=new Map,this._timings=new br.Z(10),!Et)return;this._ext=Ei(t.gl,{}),this._debugOutput=e;const i=t.gl;if(this.enableCommandLogging)for(const r in i)if("function"==typeof i[r]){const a=i[r],o=-1!==r.indexOf("draw");i[r]=(...l)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:r,args:l,isDrawCommand:o}),this._currentSummary&&(this._currentSummary.commands++,o&&this._currentSummary.drawCommands++),a.apply(i,l))}}get enableCommandLogging(){return!("object"==typeof Et&&Et.disableCommands)}recordContainerStart(t){Et&&(this._currentContainer=t)}recordContainerEnd(){Et&&(this._currentContainer=null)}recordPassStart(t){Et&&(this._currentPass=t,this._initSummary())}recordPassEnd(){Et&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){Et&&(this._currentBrush=t)}recordBrushEnd(){Et&&(this._currentBrush=null)}recordStart(t){if(Et&&(0,C.pC)(this._ext)){if(this._entries.has(t)){const i=this._entries.get(t),r=this._ext.resultAvailable(i.query),a=this._ext.disjoint();if(r&&!a){const o=this._ext.getResult(i.query)/1e6;let l=0;if((0,C.pC)(this._timings.enqueue(o))){const f=this._timings.entries,d=f.length;let _=0;for(const m of f)_+=m;l=_/d}const h=o.toFixed(2),c=l?l.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${h} ms (${c} last 10 avg)\n${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${h} ms (${c} last 10 avg)`),this._debugOutput.innerHTML=`${h} (${c})`}for(const o of i.handles)o.remove();this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",i=>{e.commandsLen++,e.commands.push(i),i.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",i=>{e.summaries.push(i)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){Et&&(0,C.pC)(this._ext)&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}const Si={shaders:{vertexShader:(0,_t.w)("stencil/stencil.vert"),fragmentShader:(0,_t.w)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};var wr=p(15205),Ve=p(70629);class Tr{constructor(t){this._allocations=new Map,t?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(t){this._allocations.set(t,(new Error).stack)}remove(t){this._allocations.delete(t)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const t=new Map;this._allocations.forEach(e=>{var i;t.set(e,(null!=(i=t.get(e))?i:0)+1)}),t.forEach((e,i)=>{const r=i.split("\n");r.shift(),r.shift(),console.log(`${e}: ${r.shift()}`),r.forEach(a=>console.log("   ",a))})}}}class Sr{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new Tr(false);this._current.length<wt._g.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(t,e){const i=++this._current[t];this._max[t]=Math.max(i,this._max[t]),this._allocations.add(e)}decrement(t,e){--this._current[t],this._allocations.remove(e)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((t,e)=>t+e,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let t=0;t<wt._g.COUNT;++t){const e=this._current[t];e>0&&console.log(`${wt._g[t]}: ${e}`)}}this._allocations.print()}}var Fi=p(89501),oe=p(33989),Mi=p(46117);function Ci(n,t){const e=new j.Z(n,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1});const r=ct.Z.createVertex(n,35044,new Uint16Array([0,0,1,0,0,1,1,1])),a=new k.Z(n,new Map([["position",0]]),{geometry:[{name:"position",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:r}),o=(0,oe.f)(5633261.287538229,2626832.878767164,1434988.0495278358),l=(0,oe.f)(5633271.46742708,2626873.6381334523,1434963.231608387),h=function(M,w){const S=new dt.$(n,`\n\n  precision highp float;\n\n  attribute vec2 position;\n\n  uniform vec3 u_highA;\n  uniform vec3 u_lowA;\n  uniform vec3 u_highB;\n  uniform vec3 u_lowB;\n\n  varying vec4 v_color;\n\n  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}\n\n  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION\n\n  vec3 dpPlusFrc(vec3 a, vec3 b) {\n    return mix(a, a + b, vec3(notEqual(b, vec3(0))));\n  }\n\n  vec3 dpMinusFrc(vec3 a, vec3 b) {\n    return mix(vec3(0), a - b, vec3(notEqual(a, b)));\n  }\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = dpPlusFrc(hiA, hiB);\n    vec3 e = dpMinusFrc(t1, hiA);\n    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;\n    return t1 + t2;\n  }\n\n  #else\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = hiA + hiB;\n    vec3 e = t1 - hiA;\n    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;\n    return t1 + t2;\n  }\n\n  #endif\n\n  const float MAX_RGBA_FLOAT =\n    255.0 / 256.0 +\n    255.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 / 256.0;\n\n  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n\n  vec4 float2rgba(const float value) {\n    // Make sure value is in the domain we can represent\n    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);\n\n    // Decompose value in 32bit fixed point parts represented as\n    // uint8 rgba components. Decomposition uses the fractional part after multiplying\n    // by a power of 256 (this removes the bits that are represented in the previous\n    // component) and then converts the fractional part to 8bits.\n    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);\n\n    // Convert uint8 values (from 0 to 255) to floating point representation for\n    // the shader\n    const float toU8AsFloat = 1.0 / 255.0;\n\n    return fixedPointU8 * toU8AsFloat;\n  }\n\n  void main() {\n    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);\n\n    v_color = float2rgba(val.z / 25.0);\n\n    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);\n  }\n  `,"\n  precision highp float;\n\n  varying vec4 v_color;\n\n  void main() {\n    gl_FragColor = v_color;\n  }\n  ",new Map([["position",0]])),x=new Float32Array(6);(0,Mi.LF)(M,x,3);const B=new Float32Array(6);return(0,Mi.LF)(w,B,3),n.useProgram(S),S.setUniform3f("u_highA",x[0],x[2],x[4]),S.setUniform3f("u_lowA",x[1],x[3],x[5]),S.setUniform3f("u_highB",B[0],B[2],B[4]),S.setUniform3f("u_lowB",B[1],B[3],B[5]),S}(o,l),c=n.getBoundFramebufferObject(),{x:f,y:d,width:_,height:m}=n.getViewport();n.bindFramebuffer(e),n.setViewport(0,0,1,1),n.bindVAO(a),n.drawArrays(5,0,4);const v=new Uint8Array(4);e.readPixels(0,0,1,1,6408,5121,v),h.dispose(),a.dispose(!1),r.dispose(),e.dispose(),n.setViewport(f,d,_,m),n.bindFramebuffer(c);const u=(o[2]-l[2])/25,b=(0,ri.v)(v);return Math.abs(u-b)}var Ri,Oi,Fr=p(81269),Pi={exports:{}};Ri=Pi,void 0!==(Oi=function(){var t=function(u){window.console&&window.console.error?window.console.error(u):function(u){window.console&&window.console.log&&window.console.log(u)}(u)},e={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,r=null;function a(u){if(null==i)for(var b in i={},r={},u)"number"==typeof u[b]&&(i[u[b]]=b,r[b]=u[b])}function o(){if(null==i)throw"WebGLDebugUtils.init(ctx) not called"}function h(u){o();var b=i[u];return void 0!==b?"gl."+b:"/*UNKNOWN WebGL ENUM*/ 0x"+u.toString(16)}function c(u,b,M,w){var S;if(void 0!==(S=e[u])&&void 0!==(S=S[b])&&S[M]){if("object"==typeof S[M]&&void 0!==S[M].enumBitwiseOr){for(var x=S[M].enumBitwiseOr,B=0,O=[],X=0;X<x.length;++X){var L=r[x[X]];0!=(w&L)&&(B|=L,O.push(h(L)))}return B===w?O.join(" | "):h(w)}return h(w)}return null===w?"null":void 0===w?"undefined":w.toString()}function d(u,b,M){u.__defineGetter__(M,function(){return b[M]}),u.__defineSetter__(M,function(w){b[M]=w})}function m(u){var b=u.getParameter(u.MAX_VERTEX_ATTRIBS),M=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,M);for(var w=0;w<b;++w)u.disableVertexAttribArray(w),u.vertexAttribPointer(w,4,u.FLOAT,!1,0,0),u.vertexAttrib1f(w,0);u.deleteBuffer(M);var S=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(w=0;w<S;++w)u.activeTexture(u.TEXTURE0+w),u.bindTexture(u.TEXTURE_CUBE_MAP,null),u.bindTexture(u.TEXTURE_2D,null);for(u.activeTexture(u.TEXTURE0),u.useProgram(null),u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.disable(u.BLEND),u.disable(u.CULL_FACE),u.disable(u.DEPTH_TEST),u.disable(u.DITHER),u.disable(u.SCISSOR_TEST),u.blendColor(0,0,0,0),u.blendEquation(u.FUNC_ADD),u.blendFunc(u.ONE,u.ZERO),u.clearColor(0,0,0,0),u.clearDepth(1),u.clearStencil(-1),u.colorMask(!0,!0,!0,!0),u.cullFace(u.BACK),u.depthFunc(u.LESS),u.depthMask(!0),u.depthRange(0,1),u.frontFace(u.CCW),u.hint(u.GENERATE_MIPMAP_HINT,u.DONT_CARE),u.lineWidth(1),u.pixelStorei(u.PACK_ALIGNMENT,4),u.pixelStorei(u.UNPACK_ALIGNMENT,4),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),u.UNPACK_COLORSPACE_CONVERSION_WEBGL&&u.pixelStorei(u.UNPACK_COLORSPACE_CONVERSION_WEBGL,u.BROWSER_DEFAULT_WEBGL),u.polygonOffset(0,0),u.sampleCoverage(1,!1),u.scissor(0,0,u.canvas.width,u.canvas.height),u.stencilFunc(u.ALWAYS,0,4294967295),u.stencilMask(4294967295),u.stencilOp(u.KEEP,u.KEEP,u.KEEP),u.viewport(0,0,u.canvas.width,u.canvas.height),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);u.getError(););}return{init:a,mightBeEnum:function(u){return o(),void 0!==i[u]},glEnumToString:h,glFunctionArgToString:c,glFunctionArgsToString:function(u,b){for(var M="",w=b.length,S=0;S<w;++S)M+=(0==S?"":", ")+c(u,w,S,b[S]);return M},makeDebugContext:function _(u,b,M,w){w=w||u,a(u),b=b||function(L,Z,Ft){for(var Ot="",Pt=Ft.length,Gt=0;Gt<Pt;++Gt)Ot+=(0==Gt?"":", ")+c(Z,Pt,Gt,Ft[Gt]);t("WebGL error "+h(L)+" in "+Z+"("+Ot+")")};var S={};function x(L,Z){return function(){M&&M(Z,arguments);var Ft=L[Z].apply(L,arguments),Ot=w.getError();return 0!=Ot&&(S[Ot]=!0,b(Ot,Z,arguments)),Ft}}var B={};for(var O in u)if("function"==typeof u[O])if("getExtension"!=O)B[O]=x(u,O);else{var X=x(u,O);B[O]=function(){return _(X.apply(u,arguments),b,M,w)}}else d(B,u,O);return B.getError=function(){for(var L in S)if(S.hasOwnProperty(L)&&S[L])return S[L]=!1,L;return u.NO_ERROR},B},makeLostContextSimulatingCanvas:function(u){var b,M,w=[],S=[],x={},B=1,O=!1,X=[],L=0,Z=0,Ft=!1,Ot=0,Pt={};function Gt(P){return"function"==typeof P?P:function(G){P.handleEvent(G)}}u.getContext=(M=u.getContext,function(){var P=M.apply(u,arguments);if(P instanceof WebGLRenderingContext){if(P!=b){if(b)throw"got different context";x=Gn(b=P)}return x}return P});var P,G,Dn=function(P){w.push(Gt(P))},In=function(P){S.push(Gt(P))};function Nt(){++Z,O||L==Z&&u.loseContext()}function Ln(P,G){var ft=P[G];return function(){if(Nt(),!O)return ft.apply(P,arguments)}}function Wi(P){return{statusMessage:P,preventDefault:function(){Ft=!0}}}return G=(P=u).addEventListener,P.addEventListener=function(ft,pt,It){switch(ft){case"webglcontextlost":Dn(pt);break;case"webglcontextrestored":In(pt);break;default:G.apply(P,arguments)}},u.loseContext=function(){if(!O){for(O=!0,L=0,++B;b.getError(););(function(){for(var P=Object.keys(Pt),G=0;G<P.length;++G)delete Pt[P]})(),Pt[b.CONTEXT_LOST_WEBGL]=!0;var P=Wi("context lost"),G=w.slice();setTimeout(function(){for(var ft=0;ft<G.length;++ft)G[ft](P);Ot>=0&&setTimeout(function(){u.restoreContext()},Ot)},0)}},u.restoreContext=function(){O&&S.length&&setTimeout(function(){if(!Ft)throw"can not restore. webglcontestlost listener did not call event.preventDefault";(function(){for(var P=0;P<X.length;++P){var G=X[P];G instanceof WebGLBuffer?b.deleteBuffer(G):G instanceof WebGLFramebuffer?b.deleteFramebuffer(G):G instanceof WebGLProgram?b.deleteProgram(G):G instanceof WebGLRenderbuffer?b.deleteRenderbuffer(G):G instanceof WebGLShader?b.deleteShader(G):G instanceof WebGLTexture&&b.deleteTexture(G)}})(),m(b),O=!1,Z=0,Ft=!1;for(var P=S.slice(),G=Wi("context restored"),ft=0;ft<P.length;++ft)P[ft](G)},0)},u.loseContextInNCalls=function(P){if(O)throw"You can not ask a lost contet to be lost";L=Z+P},u.getNumCalls=function(){return Z},u.setRestoreTimeout=function(P){Ot=P},u;function Gn(P){for(var G in P)"function"==typeof P[G]?x[G]=Ln(P,G):d(x,P,G);x.getError=function(){if(Nt(),!O)for(;ot=b.getError();)Pt[ot]=!0;for(var ot in Pt)if(Pt[ot])return delete Pt[ot],ot;return x.NO_ERROR};for(var ft=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],pt=0;pt<ft.length;++pt){var It=ft[pt];x[It]=function(ot){return function(){if(Nt(),O)return null;var $e=ot.apply(P,arguments);return $e.__webglDebugContextLostId__=B,X.push($e),$e}}(P[It])}var Zi=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(pt=0;pt<Zi.length;++pt)It=Zi[pt],x[It]=function(ot){return function(){return Nt(),O?null:ot.apply(P,arguments)}}(x[It]);var ot,ki=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(pt=0;pt<ki.length;++pt)It=ki[pt],x[It]=function(ot){return function(){return Nt(),!O&&ot.apply(P,arguments)}}(x[It]);return x.checkFramebufferStatus=(ot=x.checkFramebufferStatus,function(){return Nt(),O?x.FRAMEBUFFER_UNSUPPORTED:ot.apply(P,arguments)}),x.getAttribLocation=function(ot){return function(){return Nt(),O?-1:ot.apply(P,arguments)}}(x.getAttribLocation),x.getVertexAttribOffset=function(ot){return function(){return Nt(),O?0:ot.apply(P,arguments)}}(x.getVertexAttribOffset),x.isContextLost=function(){return O},x}},resetToInitialState:m}}())&&(Ri.exports=Oi);const Cr=re.Z.getLogger("esri.views.WebGLDriverTest");function Ge(){return(Ge=(0,D.Z)(function*(n){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,yield t.decode(),!n.gl)return!0;const e=new j.Z(n,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=ct.Z.createVertex(n,35044,new Uint16Array([0,0,1,0,0,1,1,1])),r=new k.Z(n,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:i}),a=new dt.$(n,"\n  precision highp float;\n\n  attribute vec2 a_pos;\n  varying vec2 v_uv;\n\n  void main() {\n    v_uv = a_pos;\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n  precision highp float;\n\n  varying vec2 v_uv;\n  uniform sampler2D u_texture;\n\n  void main() {\n    gl_FragColor = texture2D(u_texture, v_uv);\n  }\n  ",new Map([["a_pos",0]]));n.useProgram(a);const o=new U.Z(n,{dataType:5121,pixelFormat:6408,preMultiplyAlpha:!1,wrapMode:33071,samplingMode:9729},t);n.bindTexture(o,0),a.setUniform1i("u_texture",0);const l=n.getBoundFramebufferObject(),{x:h,y:c,width:f,height:d}=n.getViewport();n.bindFramebuffer(e),n.setViewport(0,0,1,1),n.setClearColor(0,0,0,0),n.setBlendingEnabled(!1),n.clearSafe(16384),n.bindVAO(r),n.drawArrays(5,0,4);const _=new Uint8Array(4);return e.readPixels(0,0,1,1,6408,5121,_),a.dispose(),r.dispose(!1),i.dispose(),e.dispose(),o.dispose(),n.setViewport(h,c,f,d),n.bindFramebuffer(l),t.src="",255===_[0]})).apply(this,arguments)}class Or{constructor(t){this.context=t,this._floatBufferBlendWorking=function(n){var t,e,i,r,a;if(!n.gl)return!1;if("webgl"===n.webglVersion)return(null==(r=n.capabilities.textureFloat)?void 0:r.textureFloat)&&(null==(a=n.capabilities.colorBufferFloat)?void 0:a.textureFloat);if(!((null==(t=n.capabilities.textureFloat)?void 0:t.textureFloat)&&(null==(e=n.capabilities.colorBufferFloat)?void 0:e.textureFloat)&&(null==(i=n.capabilities.colorBufferFloat)?void 0:i.floatBlend)))return!1;const o=new j.Z(n,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5126,internalFormat:34836,samplingMode:9728,width:1,height:1}),l=ct.Z.createVertex(n,35044,new Uint16Array([0,0,1,0,0,1,1,1])),h=new k.Z(n,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:l}),c=new dt.$(n,"\n  precision highp float;\n  attribute vec2 a_pos;\n\n  void main() {\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n   precision highp float;\n\n   void main() {\n    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n   }\n  ",new Map([["a_pos",0]]));n.useProgram(c);const f=n.getBoundFramebufferObject(),{x:d,y:_,width:m,height:v}=n.getViewport();n.bindFramebuffer(o),n.setViewport(0,0,1,1),n.bindVAO(h),n.drawArrays(5,0,4);const u=(0,Fi.sm)({blending:Fr.IB});n.setPipelineState(u),n.drawArrays(5,0,4),Pi.exports.init(n);const b=n.gl.getError();return n.setViewport(d,_,m,v),n.bindFramebuffer(f),c.dispose(),h.dispose(!1),l.dispose(),o.dispose(),1282!==b||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}(t),function(n){return Ge.apply(this,arguments)}(t).then(e=>this._svgAlwaysPremultipliesAlpha=!e)}get floatBufferBlendWorking(){if((0,C.Wi)(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if((0,C.Wi)(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if((0,C.Wi)(this._doublePrecisionRequiresObfuscation)){const t=Ci(this.context,!1),e=Ci(this.context,!0);this._doublePrecisionRequiresObfuscation=0!==t&&(0===e||t/e>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return(0,C.Wi)(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=(n=>{const t=new j.Z(n,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),r=new Uint8Array(4),a=ct.Z.createVertex(n,35044,new Uint16Array([0,0,1,0,0,1,1,1])),o=new k.Z(n,new Map([["a_position",0]]),{geometry:[{name:"a_position",count:2,type:5122,offset:0,stride:4,normalized:!1}]},{geometry:a}),l=new dt.$(n,"\nprecision highp float;\nattribute vec2 a_pos;\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",new Map([["a_pos",0]])),h=new U.Z(n,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));l.setUniform1i("u_texture",0),n.bindTexture(h,0);const c=n.getBoundFramebufferObject();n.bindFramebuffer(t),n.useProgram(l);const{x:f,y:d,width:_,height:m}=n.getViewport();n.setViewport(0,0,1,1),n.bindVAO(o),n.drawArrays(5,0,4),n.setViewport(f,d,_,m),t.readPixels(0,0,1,1,6408,5121,r),l.dispose(),o.dispose(!1),a.dispose(),t.dispose();const v=255!==r[0]||255!==r[1]||255!==r[2]||255!==r[3];return v&&Cr.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${r[0]}.${r[1]}.${r[2]}.${r[3]}]`),n.bindFramebuffer(c),v})(this.context)),this._ignoresSamplerPrecision}}function Ur(n,t){const e=t.disabledExtensions||{},i=t.debugWebGLExtensions||{};let r,a,o,l,h,c,f,d,_,m,v,u,b=null,M=null,w=null,S=null;return{get drawBuffers(){return v||(v=function(n,t){if(t.disjointTimerQuery)return null;if((0,Tt.Z)(n))return{drawBuffers:n.drawBuffers.bind(n),MAX_DRAW_BUFFERS:n.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:n.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const e=n.getExtension("WEBGL_draw_buffers");return e?{drawBuffers:e.drawBuffersWEBGL.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS_WEBGL}:null}(n,e)),v},get instancing(){return r||(r=function(n){if((0,Tt.Z)(n))return{drawArraysInstanced:n.drawArraysInstanced.bind(n),drawElementsInstanced:n.drawElementsInstanced.bind(n),vertexAttribDivisor:n.vertexAttribDivisor.bind(n)};const t=n.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}(n)),r},get vao(){return a||(a=function(n,t){if((0,Tt.Z)(n))return{createVertexArray:n.createVertexArray.bind(n),deleteVertexArray:n.deleteVertexArray.bind(n),bindVertexArray:n.bindVertexArray.bind(n)};if(t.vao)return null;const e=n.getExtension("OES_vertex_array_object")||n.getExtension("MOZ_OES_vertex_array_object")||n.getExtension("WEBKIT_OES_vertex_array_object");return e?{createVertexArray:e.createVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),bindVertexArray:e.bindVertexArrayOES.bind(e)}:null}(n,e)),a},get compressedTextureETC(){return o||(o=function(n,t){if(t.compressedTextureETC)return null;const e=n.getExtension("WEBGL_compressed_texture_etc");return e?{COMPRESSED_R11_EAC:e.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:e.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:e.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:e.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:e.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:e.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:e.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}(n,e)),o},get compressedTextureS3TC(){return l||(l=function(n,t){if(t.compressedTextureS3TC)return null;const e=n.getExtension("WEBGL_compressed_texture_s3tc");return e?{COMPRESSED_RGB_S3TC_DXT1:e.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:e.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:e.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:e.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}(n,e)),l},get textureFilterAnisotropic(){return h||(h=function(n,t){if(t.textureFilterAnisotropic)return null;const e=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return e?{MAX_TEXTURE_MAX_ANISOTROPY:e.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:e.TEXTURE_MAX_ANISOTROPY_EXT}:null}(n,e)),h},get disjointTimerQuery(){return c||(c=Ei(n,e)),c},get textureFloat(){return f||(f=function(n,t){if((0,Tt.Z)(n))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!n.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!n.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:n.HALF_FLOAT};if(n instanceof WebGLRenderingContext){const e=!t.textureHalfFloat&&n.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!n.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!n.getExtension("OES_texture_float_linear"),textureHalfFloat:!!e,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!n.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:e?e.HALF_FLOAT_OES:void 0}}return null}(n,e)),f},get colorBufferFloat(){return d||(d=function(n,t){if((0,Tt.Z)(n)){const e=!t.colorBufferFloat&&n.getExtension("EXT_color_buffer_half_float"),i=!t.colorBufferFloat&&n.getExtension("EXT_color_buffer_float"),r=!t.colorBufferFloat&&n.getExtension("EXT_float_blend");return e||i||r?{textureFloat:!!i,textureHalfFloat:!!e,floatBlend:!!r,R16F:n.R16F,RG16F:n.RG16F,RGBA16F:n.RGBA16F,R32F:n.R32F,RG32F:n.RG32F,RGBA32F:n.RGBA32F,R11F_G11F_B10F:n.R11F_G11F_B10F,RGB16F:n.RGB16F}:null}if(n instanceof WebGLRenderingContext){const e=!t.colorBufferFloat&&n.getExtension("EXT_color_buffer_half_float"),i=!t.colorBufferFloat&&n.getExtension("WEBGL_color_buffer_float"),r=!t.colorBufferFloat&&n.getExtension("EXT_float_blend");return e||i||r?{textureFloat:!!i,textureHalfFloat:!!e,floatBlend:!!r,RGBA16F:e?e.RGBA16F_EXT:void 0,RGB16F:e?e.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}(n,e)),d},get blendMinMax(){return _||(_=function(n,t){if((0,Tt.Z)(n))return{MIN:n.MIN,MAX:n.MAX};if(t.blendMinMax)return null;{const e=n.getExtension("EXT_blend_minmax");return e?{MIN:e.MIN_EXT,MAX:e.MAX_EXT}:null}}(n,e)),_},get depthTexture(){return null===b&&(b=ve(n,e,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),b},get standardDerivatives(){return null===M&&(M=ve(n,e,"standardDerivatives",!0,["OES_standard_derivatives"])),M},get shaderTextureLOD(){return null===w&&(w=ve(n,e,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),w},get fragDepth(){return null===S&&(S=ve(n,e,"fragDepth",!0,["EXT_frag_depth"])),S},get loseContext(){return m||(m=function(n,t){const e=t.loseContext&&n.getExtension("WEBGL_lose_context");return e?{loseRenderingContext:()=>e.loseContext()}:null}(n,i)),m},get textureNorm16(){return u||(u=function(n,t){if(!(0,Tt.Z)(n)||t.textureNorm16)return null;const e=n.getExtension("EXT_texture_norm16");return e?{R16:e.R16,RG16:e.RG16,RGB16:e.RGB16,RGBA16:e.RGBA16,R16_SNORM:e.R16_SNORM,RG16_SNORM:e.RG16_SNORM,RGB16_SNORM:e.RGB16_SNORM,RGBA16_SNORM:e.RGBA16_SNORM}:null}(n,e)),u},enable(x){return this[x]}}}function ve(n,t,e,i,r){if(i&&(0,Tt.Z)(n))return!0;if(t[e])return!1;for(const a of r)if(n.getExtension(a))return!0;return!1}class kr{constructor(t,e){this.gl=t,this.instanceCounter=new Sr,this._blendEnabled=!1,this._blendColorState={r:0,g:0,b:0,a:0},this._blendFunctionState={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this._blendEquationState={mode:32774,modeAlpha:32774},this._colorMaskState={r:!0,g:!0,b:!0,a:!0},this._polygonCullingEnabled=!1,this._cullFace=1029,this._frontFace=2305,this._scissorTestEnabled=!1,this._scissorRect={x:0,y:0,width:0,height:0},this._depthTestEnabled=!1,this._depthFunction=513,this._clearDepth=1,this._depthWriteEnabled=!0,this._depthRange={zNear:0,zFar:1},this._viewport=null,this._stencilTestEnabled=!1,this._polygonOffsetFillEnabled=!1,this._polygonOffset=[0,0],this._stencilFunction={face:1032,func:519,ref:0,mask:1},this._clearStencil=0,this._stencilWriteMask=1,this._stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this._clearColor={r:0,g:0,b:0,a:0},this._activeShaderProgram=null,this._activeVertexBuffer=null,this._activeIndexBuffer=null,this._activeFramebuffer=null,this._activeRenderbuffer=null,this._activeTextureUnit=0,this._textureUnitMap=new Array,this._numOfDrawCalls=0,this._numOfTriangles=0,this.webglVersion=(0,Tt.Z)(t)?"webgl2":"webgl","webgl"===this.webglVersion&&this.gl.getExtension("OES_element_index_uint"),this._capabilities=Ur(t,e),this._parameters=this._loadParameters(e);const i=this.gl.getParameter(this.gl.VIEWPORT);this._viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new Fi.jp({setBlending:r=>{if(r){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(r.opRgb,r.opAlpha),this.setBlendFunctionSeparate(r.srcRgb,r.dstRgb,r.srcAlpha,r.dstAlpha);const a=r.color;this.setBlendColor(a.r,a.g,a.b,a.a)}else this.setBlendingEnabled(!1)},setCulling:r=>{r?(this.setFaceCullingEnabled(!0),this.setCullFace(r.face),this.setFrontFace(r.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:r=>{r?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(r.factor,r.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:r=>{r?(this.setDepthTestEnabled(!0),this.setDepthFunction(r.func)):this.setDepthTestEnabled(!1)},setStencilTest:r=>{if(r){this.setStencilTestEnabled(!0);const a=r.function;this.setStencilFunction(a.func,a.ref,a.mask);const o=r.operation;this.setStencilOp(o.fail,o.zFail,o.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:r=>{r?(this.setDepthWriteEnabled(!0),this.setDepthRange(r.zNear,r.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:r=>{r?this.setColorMask(r.r,r.g,r.b,r.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:r=>{r?this.setStencilWriteMask(r.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this.driverTest=new Or(this)}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this._textureUnitMap.length=0,(0,Mt.hZ)()&&this.instanceCounter.printResourceCount()}setPipelineState(t){this._stateTracker.setPipeline(t)}setBlendingEnabled(t){this._blendEnabled!==t&&(!0===t?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._blendEnabled=t,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var t;null==(t=this._activeShaderProgram)||t.stop(),this._activeShaderProgram=null}externalTextureUnitUpdate(t,e){for(let i=0;i<t.length;++i)this._textureUnitMap[t[i]]=null;e>=0&&(this._activeTextureUnit=e)}externalVertexArrayObjectUpdate(){const t=this.capabilities.vao;t&&(t.bindVertexArray(null),this._activeVertexArrayObject=null),this._activeVertexBuffer=null,this._activeIndexBuffer=null}externalVertexBufferUpdate(){this._activeVertexBuffer=null}externalIndexBufferUpdate(){this._activeIndexBuffer=null}setBlendColor(t,e,i,r){t===this._blendColorState.r&&e===this._blendColorState.g&&i===this._blendColorState.b&&r===this._blendColorState.a||(this.gl.blendColor(t,e,i,r),this._blendColorState.r=t,this._blendColorState.g=e,this._blendColorState.b=i,this._blendColorState.a=r,this._stateTracker.invalidateBlending())}setBlendFunction(t,e){t===this._blendFunctionState.srcRGB&&e===this._blendFunctionState.dstRGB||(this.gl.blendFunc(t,e),this._blendFunctionState.srcRGB=t,this._blendFunctionState.srcAlpha=t,this._blendFunctionState.dstRGB=e,this._blendFunctionState.dstAlpha=e,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(t,e,i,r){this._blendFunctionState.srcRGB===t&&this._blendFunctionState.srcAlpha===i&&this._blendFunctionState.dstRGB===e&&this._blendFunctionState.dstAlpha===r||(this.gl.blendFuncSeparate(t,e,i,r),this._blendFunctionState.srcRGB=t,this._blendFunctionState.srcAlpha=i,this._blendFunctionState.dstRGB=e,this._blendFunctionState.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendEquation(t){this._blendEquationState.mode!==t&&(this.gl.blendEquation(t),this._blendEquationState.mode=t,this._blendEquationState.modeAlpha=t,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(t,e){this._blendEquationState.mode===t&&this._blendEquationState.modeAlpha===e||(this.gl.blendEquationSeparate(t,e),this._blendEquationState.mode=t,this._blendEquationState.modeAlpha=e,this._stateTracker.invalidateBlending())}setColorMask(t,e,i,r){this._colorMaskState.r===t&&this._colorMaskState.g===e&&this._colorMaskState.b===i&&this._colorMaskState.a===r||(this.gl.colorMask(t,e,i,r),this._colorMaskState.r=t,this._colorMaskState.g=e,this._colorMaskState.b=i,this._colorMaskState.a=r,this._stateTracker.invalidateColorWrite())}setClearColor(t,e,i,r){this._clearColor.r===t&&this._clearColor.g===e&&this._clearColor.b===i&&this._clearColor.a===r||(this.gl.clearColor(t,e,i,r),this._clearColor.r=t,this._clearColor.g=e,this._clearColor.b=i,this._clearColor.a=r)}setFaceCullingEnabled(t){this._polygonCullingEnabled!==t&&(!0===t?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._polygonCullingEnabled=t,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(t){this._polygonOffsetFillEnabled!==t&&(!0===t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._polygonOffsetFillEnabled=t,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(t,e){this._polygonOffset[0]===t&&this._polygonOffset[1]===e||(this._polygonOffset[0]=t,this._polygonOffset[1]=e,this.gl.polygonOffset(t,e),this._stateTracker.invalidatePolygonOffset())}setCullFace(t){this._cullFace!==t&&(this.gl.cullFace(t),this._cullFace=t,this._stateTracker.invalidateCulling())}setFrontFace(t){this._frontFace!==t&&(this.gl.frontFace(t),this._frontFace=t,this._stateTracker.invalidateCulling())}setScissorTestEnabled(t){this._scissorTestEnabled!==t&&(!0===t?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._scissorTestEnabled=t)}setScissorRect(t,e,i,r){this._scissorRect.x===t&&this._scissorRect.y===e&&this._scissorRect.width===i&&this._scissorRect.height===r||(this.gl.scissor(t,e,i,r),this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=i,this._scissorRect.height=r)}setDepthTestEnabled(t){this._depthTestEnabled!==t&&(!0===t?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._depthTestEnabled=t,this._stateTracker.invalidateDepthTest())}setClearDepth(t){this._clearDepth!==t&&(this.gl.clearDepth(t),this._clearDepth=t)}setDepthFunction(t){this._depthFunction!==t&&(this.gl.depthFunc(t),this._depthFunction=t,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(t){this._depthWriteEnabled!==t&&(this.gl.depthMask(t),this._depthWriteEnabled=t,this._stateTracker.invalidateDepthWrite())}setDepthRange(t,e){this._depthRange.zNear===t&&this._depthRange.zFar===e||(this.gl.depthRange(t,e),this._depthRange.zNear=t,this._depthRange.zFar=e,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(t){this._stencilTestEnabled!==t&&(!0===t?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._stencilTestEnabled=t,this._stateTracker.invalidateStencilTest())}setClearStencil(t){t!==this._clearStencil&&(this.gl.clearStencil(t),this._clearStencil=t)}setStencilFunction(t,e,i){this._stencilFunction.func===t&&this._stencilFunction.ref===e&&this._stencilFunction.mask===i||(this.gl.stencilFunc(t,e,i),this._stencilFunction.face=1032,this._stencilFunction.func=t,this._stencilFunction.ref=e,this._stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(t,e,i,r){this._stencilFunction.face===t&&this._stencilFunction.func===e&&this._stencilFunction.ref===i&&this._stencilFunction.mask===r||(this.gl.stencilFuncSeparate(t,e,i,r),this._stencilFunction.face=t,this._stencilFunction.func=e,this._stencilFunction.ref=i,this._stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(t){this._stencilWriteMask!==t&&(this.gl.stencilMask(t),this._stencilWriteMask=t,this._stateTracker.invalidateStencilWrite())}setStencilOp(t,e,i){this._stencilOperation.fail===t&&this._stencilOperation.zFail===e&&this._stencilOperation.zPass===i||(this.gl.stencilOp(t,e,i),this._stencilOperation.face=1032,this._stencilOperation.fail=t,this._stencilOperation.zFail=e,this._stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(t,e,i,r){this._stencilOperation.face===t&&this._stencilOperation.fail===e&&this._stencilOperation.zFail===i&&this._stencilOperation.zPass===r||(this.gl.stencilOpSeparate(t,e,i,r),this._stencilOperation.face=t,this._stencilOperation.face=t,this._stencilOperation.fail=e,this._stencilOperation.zFail=i,this._stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setActiveTexture(t,e=!1){const i=this._activeTextureUnit;return t>=0&&(e||t!==this._activeTextureUnit)&&(this.gl.activeTexture(wt.Ld+t),this._activeTextureUnit=t),i}clear(t){t&&this.gl.clear(t)}clearSafe(t,e=255){t&&(16384&t&&this.setColorMask(!0,!0,!0,!0),256&t&&this.setDepthWriteEnabled(!0),1024&t&&this.setStencilWriteMask(e),this.gl.clear(t))}drawArrays(t,e,i){(0,Mt.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=Ai(t,i)),this.gl.drawArrays(t,e,i)}drawElements(t,e,i,r){(0,Mt.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=Ai(t,e)),this.gl.drawElements(t,e,i,r)}logIno(){(0,Mt.hZ)()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(t,e,i,r){i=Math.max(Math.round(i),1),r=Math.max(Math.round(r),1);const a=this._viewport;a.x===t&&a.y===e&&a.width===i&&a.height===r||(a.x=t,a.y=e,a.width=i,a.height=r,this.gl.viewport(t,e,i,r))}getViewport(){return{x:this._viewport.x,y:this._viewport.y,width:this._viewport.width,height:this._viewport.height}}useProgram(t){var e,i;this._activeShaderProgram!==t&&(null==(e=this._activeShaderProgram)||e.stop(),this._activeShaderProgram=t,this.gl.useProgram(null!=(i=null==t?void 0:t.glName)?i:null))}bindTexture(t,e,i=!1){(e>=this.parameters.maxTextureImageUnits||e<0)&&console.error("Input texture unit is out of range of available units!");const r=this._textureUnitMap[e];return(0,C.Wi)(t)||null==t.glName?((0,C.pC)(r)&&(this.setActiveTexture(e,i),this.gl.bindTexture(r.descriptor.target,null)),this._textureUnitMap[e]=null,r):i||r!==t?(this.setActiveTexture(e,i),this.gl.bindTexture(t.descriptor.target,t.glName),t.applyChanges(),this._textureUnitMap[e]=t,r):(t.isDirty&&(this.setActiveTexture(e,i),t.applyChanges()),r)}unbindTextureAllUnits(t){for(let e=0;e<this.parameters.maxTextureImageUnits;e++)this._textureUnitMap[e]===t&&(this.bindTexture(null,e),this._textureUnitMap[e]=null)}bindFramebuffer(t,e=!1,i=3553){if((0,C.Wi)(t))return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),void(this._activeFramebuffer=null);(e||this._activeFramebuffer!==t)&&(t.initializeAndBind(i),this._activeFramebuffer=t)}bindBuffer(t){t&&(34962===t.bufferType?this._activeVertexBuffer=be(this.gl,t,t.bufferType,this._activeVertexBuffer):this._activeIndexBuffer=be(this.gl,t,t.bufferType,this._activeIndexBuffer))}bindRenderbuffer(t){const e=this.gl;t||(e.bindRenderbuffer(e.RENDERBUFFER,null),this._activeRenderbuffer=null),this._activeRenderbuffer!==t&&(e.bindRenderbuffer(e.RENDERBUFFER,t.glName),this._activeRenderbuffer=t)}unbindBuffer(t){34962===t?this._activeVertexBuffer=be(this.gl,null,t,this._activeVertexBuffer):this._activeIndexBuffer=be(this.gl,null,t,this._activeIndexBuffer)}bindVAO(t=null){(0,C.Wi)(t)?this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null):this._activeVertexArrayObject!==t&&(t.bind(),this._activeVertexArrayObject=t)}getBoundFramebufferObject(){return this._activeFramebuffer}getBoundVAO(){return this._activeVertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null),this.unbindBuffer(34962),this.unbindBuffer(34963);for(let t=0;t<this.parameters.maxTextureImageUnits;++t)this.bindTexture(null,t);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var t,e,i,r;const a=this.gl,o=this.capabilities.vao;o&&o.bindVertexArray(null);for(let l=0;l<this.parameters.maxVertexAttributes;l++)a.disableVertexAttribArray(l);if(this._activeVertexBuffer?a.bindBuffer(this._activeVertexBuffer.bufferType,this._activeVertexBuffer.glName):a.bindBuffer(34962,null),this._activeIndexBuffer?a.bindBuffer(this._activeIndexBuffer.bufferType,this._activeIndexBuffer.glName):a.bindBuffer(34963,null),o&&this._activeVertexArrayObject){const l=this._activeVertexArrayObject;this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null),this.bindVAO(l)}a.bindFramebuffer(a.FRAMEBUFFER,null!=(t=null==(e=this._activeFramebuffer)?void 0:e.glName)?t:null),a.useProgram(null!=(i=null==(r=this._activeShaderProgram)?void 0:r.glName)?i:null),a.blendColor(this._blendColorState.r,this._blendColorState.g,this._blendColorState.b,this._blendColorState.a),a.bindRenderbuffer(a.RENDERBUFFER,this._activeRenderbuffer?this._activeRenderbuffer.glName:null),!0===this._blendEnabled?a.enable(this.gl.BLEND):a.disable(this.gl.BLEND),a.blendEquationSeparate(this._blendEquationState.mode,this._blendEquationState.modeAlpha),a.blendFuncSeparate(this._blendFunctionState.srcRGB,this._blendFunctionState.dstRGB,this._blendFunctionState.srcAlpha,this._blendFunctionState.dstAlpha),a.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),a.clearDepth(this._clearDepth),a.clearStencil(this._clearStencil),a.colorMask(this._colorMaskState.r,this._colorMaskState.g,this._colorMaskState.b,this._colorMaskState.a),a.cullFace(this._cullFace),a.depthFunc(this._depthFunction),a.depthRange(this._depthRange.zNear,this._depthRange.zFar),!0===this._depthTestEnabled?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),a.depthMask(this._depthWriteEnabled),a.frontFace(this._frontFace),a.lineWidth(1),!0===this._polygonCullingEnabled?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),a.polygonOffset(this._polygonOffset[0],this._polygonOffset[1]),!0===this._polygonOffsetFillEnabled?a.enable(a.POLYGON_OFFSET_FILL):a.disable(a.POLYGON_OFFSET_FILL),a.scissor(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height),!0===this._scissorTestEnabled?a.enable(a.SCISSOR_TEST):a.disable(a.SCISSOR_TEST),a.stencilFunc(this._stencilFunction.func,this._stencilFunction.ref,this._stencilFunction.mask),a.stencilOpSeparate(this._stencilOperation.face,this._stencilOperation.fail,this._stencilOperation.zFail,this._stencilOperation.zPass),!0===this._stencilTestEnabled?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),a.stencilMask(this._stencilWriteMask);for(let l=0;l<this.parameters.maxTextureImageUnits;l++){a.activeTexture(wt.Ld+l),a.bindTexture(3553,null),a.bindTexture(34067,null),(0,Tt.Z)(a)&&a.bindTexture(32879,null);const h=this._textureUnitMap[l];(0,C.pC)(h)&&a.bindTexture(h.descriptor.target,h.glName)}a.activeTexture(wt.Ld+this._activeTextureUnit),a.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height),(0,Mt.hZ)()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadParameters(t){var e;const i=this.capabilities.textureFilterAnisotropic,r=null!=(e=t.maxAnisotropy)?e:1/0,a={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:i?Math.min(this.gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),r):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)};return U.Z.TEXTURE_UNIT_FOR_UPDATES=a.maxTextureImageUnits-1,a}}function be(n,t,e,i){return t?i!==t&&n.bindBuffer(e,t.glName):n.bindBuffer(e,null),t}function Ai(n,t){switch(n){case 0:return 2*t;case 4:return t/3;case 5:case 6:return t-2;default:return 0}}class Xr extends Q.W{constructor(t,e){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=(0,it.a)(),this._upperRight=(0,it.a)(),this._lowerLeft=(0,it.a)(),this._lowerRight=(0,it.a)(),this._mat2=(0,mt.c)(),this._clipRendererInitialized=!1,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:r=!0,stencil:a=!0,contextOptions:o={}}=e;this._canvas=i;const l=(0,st.s)(i,1,{alpha:r,antialias:!1,depth:!0,stencil:a});this.context=new kr((0,C.pC)(l)?l:null,o),this.resourceManager=new Wt.Z,this.painter=new vr(this.context,this,this.resourceManager),(0,lt.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),t.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:e.timeline||new wr.T,renderingOptions:e.renderingOptions,requireFBO:!1,profiler:new xr(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=(0,y.A)({render:h=>this.renderFrame(h)}),this._taskHandle.pause(),this._lostWebGLContextHandle=(0,At.on)(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new E.Z("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),t.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(t){this._background=t,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(t){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=t,this._highlightOptions&&(this._highlightOptionsHandle=(0,I.S1)(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(t),this.requestRender()}))}get renderingOptions(){return this._renderingOptions}set renderingOptions(t){this._renderingOptions=t,this.requestRender()}get state(){return this._state}set state(t){this._state=t,this.requestRender()}get stationary(){return this._stationary}set stationary(t){this._stationary!==t&&(this._stationary=t,this.requestRender())}trashDisplayObject(t){this._trash.add(t),this.requestRender()}untrashDisplayObject(t){return this._trash.delete(t)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(t){const e=this._lastFrameRenderTime?t.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=e,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=t.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=t.time,this._renderParameters.deltaTime=t.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:(0,ht.c)()}}renderChildren(t){for(const e of this.children)e.beforeRender(t);this._renderChildren(this.children,t);for(const e of this.children)e.afterRender(t)}_renderChildren(t,e){const i=this.context;e.profiler.recordStart("drawLayers"),e.dataUploadCounter=0,this._beforeRenderChildren(e),e.drawPhase=F.jx.MAP,this.painter.beforeRenderLayers(i,this.background);for(const r of t)r.processRender(e);this.painter.renderLayers(i),e.drawPhase=F.jx.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const r of t)r.processRender(e);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(t)){e.drawPhase=F.jx.LABEL,this.painter.beforeRenderLayers(i);for(const r of t)r.processRender(e);this.painter.renderLayers(i)}if((0,lt.Z)("esri-tiles-debug")){e.drawPhase=F.jx.DEBUG,this.painter.beforeRenderLayers(i);for(const r of t)r.processRender(e);this.painter.renderLayers(i)}e.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(t){const{context:e}=this,{state:i,pixelRatio:r}=t;e.enforceState(),e.setClearDepth(1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT);const{size:a,rotation:o}=i,l=Math.round(a[0]*r),h=Math.round(a[1]*r);if(this._boundFBO=e.getBoundFramebufferObject(),!i.spatialReference||!(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable))return void(this._clipFrame=!1);const c=(0,z.t)(o),f=Math.abs(Math.cos(c)),d=Math.abs(Math.sin(c)),_=Math.round(l*f+h*d),m=Math.round(i.worldScreenWidth);if(_<=m)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===l&&this._clipFBO.height===h||(this._clipFBO=new j.Z(e,{colorTarget:0,depthStencilTarget:3,width:l,height:h}));const v=(this.state.padding.left-this.state.padding.right)/2,u=(this.state.padding.bottom-this.state.padding.top)/2,b=.5*l,M=.5*h,w=1/l,S=1/h,x=m*r*.5,B=.5*(l*d+h*f),O=this._upperLeft,X=this._upperRight,L=this._lowerLeft,Z=this._lowerRight;(0,V.s)(O,-x,-B),(0,V.s)(X,x,-B),(0,V.s)(L,-x,B),(0,V.s)(Z,x,B),(0,xt.i)(this._mat2),(0,xt.t)(this._mat2,this._mat2,[b+v,M-u]),0!==o&&(0,xt.r)(this._mat2,this._mat2,c),(0,V.t)(O,O,this._mat2),(0,V.t)(X,X,this._mat2),(0,V.t)(L,L,this._mat2),(0,V.t)(Z,Z,this._mat2);const Ft=this._clipData;Ft.set([2*L[0]*w-1,2*(h-L[1])*S-1,2*Z[0]*w-1,2*(h-Z[1])*S-1,2*O[0]*w-1,2*(h-O[1])*S-1,2*X[0]*w-1,2*(h-X[1])*S-1]),this._clipRendererInitialized||this._initializeClipRenderer(e),this._clipVBO.setData(Ft),this._boundFBO=e.getBoundFramebufferObject(),e.bindFramebuffer(this._clipFBO),e.setDepthWriteEnabled(!0),e.setStencilWriteMask(255),e.setClearColor(0,0,0,0),e.setClearDepth(1),e.setClearStencil(0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT|e.gl.STENCIL_BUFFER_BIT),e.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const t=this.context;if(t.logIno(),this._clipFrame&&this._clipRendererInitialized){if(t.bindFramebuffer(this._boundFBO),this._boundFBO=null,t.bindVAO(this._clipVAO),t.useProgram(this._clipStencilProgram),t.setDepthWriteEnabled(!1),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!1),t.setStencilOp(7680,7680,7681),t.setStencilWriteMask(255),t.setStencilFunction(519,1,255),t.drawElements(4,6,5123,0),t.bindVAO(),t.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:e,g:i,b:r,a}=this.background.color;t.setClearColor(a*e/255,a*i/255,a*r/255,a)}else t.setClearColor(0,0,0,0);t.clear(t.gl.COLOR_BUFFER_BIT),t.setBlendingEnabled(!0),t.setStencilFunction(514,1,255),this.painter.blitTexture(t,this._clipFBO.colorTexture,9728,1),t.setStencilTestEnabled(!1)}}doRender(t){const e=this.context,{state:i,pixelRatio:r}=t;this._resizeCanvas(t),this.context.enforceState(),e.setViewport(0,0,r*i.size[0],r*i.size[1]),e.setDepthWriteEnabled(!0),e.setStencilWriteMask(255),super.doRender(t)}takeScreenshot(t){var e=this;return(0,D.Z)(function*(){const{framebufferWidth:i,framebufferHeight:r}={framebufferWidth:Math.round(e._renderParameters.state.size[0]*t.resolutionScale),framebufferHeight:Math.round(e._renderParameters.state.size[1]*t.resolutionScale)},o=e.context,l=e._state.clone();if(null!=t.rotation){const v=l.viewpoint;l.viewpoint.rotation=t.rotation,l.viewpoint=v}const h=bt(J({},e._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:l,pixelRatio:1,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),c=new j.Z(o,{colorTarget:0,depthStencilTarget:3,width:i,height:r}),f=o.getBoundFramebufferObject(),d=o.getViewport();o.bindFramebuffer(c),o.setViewport(0,0,i,r),e._renderChildren(t.children,h);const _=e._readbackScreenshot(bt(J({},t.cropArea),{y:r-(t.cropArea.y+t.cropArea.height)}));let m;return o.bindFramebuffer(f),o.setViewport(d.x,d.y,d.width,d.height),e.requestRender(),1===t.outputScale?m=_:(m=new ImageData(Math.round(_.width*t.outputScale),Math.round(_.height*t.outputScale)),(0,Ve.TT)(_,m,!0)),(0,Ve.gH)(m,{format:t.format,quality:t.quality,rotation:0,disableDecorations:!1},document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})})()}_readbackScreenshot(t){const e=this.context.gl,i=(0,Ve.r7)(t.width,t.height,document.createElement("canvas"));return e.readPixels(t.x,t.y,t.width,t.height,6408,5121,new Uint8Array(i.data.buffer)),i}_resizeCanvas(t){const e=this._canvas,i=e.style,{state:{size:r},pixelRatio:a}=t,o=r[0],l=r[1],h=Math.round(o*a),c=Math.round(l*a);e.width===h&&e.height===c||(e.width=h,e.height=c),i.width=o+"px",i.height=l+"px"}_initializeClipRenderer(t){if(this._clipRendererInitialized)return!0;const e=Si.attributes,i=(0,R.H)(t,Si);if(!i)return!1;const r=ct.Z.createVertex(t,35040,32),a=new Uint16Array([0,1,2,2,1,3]),o=ct.Z.createIndex(t,35044,a),l=new k.Z(t,e,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:r},o);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=l,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const t=Array.from(this._trash);this._trash.clear();for(const e of t)e.processDetach()}}_isLabelDrawPhaseRequired(t){let e=!1;for(const i of t){if(!(i instanceof Q.W)){e=e||!1;break}if(i.hasLabels)return!0;e=e||this._isLabelDrawPhaseRequired(i.children)}return e}}var W=p(79076),Yt=p(6897),jr=p(62091),$r=p(81876),K=p(94911),qt=(p(55865),p(96410)),gt=p(88415),Kr=p(30592);class Qr{constructor(t,e){this.width=t,this.height=e;const i=Math.ceil(t/1),r=Math.ceil(e/1);this._cols=i,this._rows=r,this._cells=Kr.p.create(i*r)}insertMetrics(t){const e=this._hasCollision(t);return 0===e&&this._markMetrics(t),e}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_hasCollision(t){const e=t.id;let i=0,r=0;t.save();do{const a=t.boundsCount;i+=a;for(let o=0;o<a;o++){const l=t.boundsComputedAnchorX(o),h=t.boundsComputedAnchorY(o),c=t.boundsWidth(o)+2,f=t.boundsHeight(o)+2;switch(this._collide(l,h,c,f)){case 2:return 2;case 1:r++}}}while(t.peekId()===e&&t.next());return t.restore(),i===r?1:0}_collide(t,e,i,r){const a=t-i/2,o=e-r/2,l=a+i,h=o+r;if(l<0||h<0||a>this.width||o>this.height)return 1;const c=(0,gt.uZ)(Math.floor(a/1),0,this._cols),f=(0,gt.uZ)(Math.floor(o/1),0,this._rows),d=(0,gt.uZ)(Math.ceil(l/1),0,this._cols),_=(0,gt.uZ)(Math.ceil(h/1),0,this._rows);for(let m=f;m<=_;m++)for(let v=c;v<=d;v++){const u=this.getCellId(v,m);if(this.has(u))return 2}return 0}_mark(t,e,i,r){const a=t-i/2,o=e-r/2,l=a+i,h=o+r,c=(0,gt.uZ)(Math.floor(a/1),0,this._cols),f=(0,gt.uZ)(Math.floor(o/1),0,this._rows),d=(0,gt.uZ)(Math.ceil(l/1),0,this._cols),_=(0,gt.uZ)(Math.ceil(h/1),0,this._rows);for(let m=f;m<=_;m++)for(let v=c;v<=d;v++){const u=this.getCellId(v,m);this.set(u)}return!1}_markMetrics(t){const e=t.id;do{const i=t.boundsCount;for(let r=0;r<i;r++){const a=t.boundsComputedAnchorX(r),o=t.boundsComputedAnchorY(r),l=t.boundsWidth(r)+2,h=t.boundsHeight(r)+2;this._mark(a,o,l,h)}}while(t.peekId()===e&&t.next())}}var Yr=p(76766);const qr=Math.PI;function Di(n,t){switch(t.transformationType){case"additive":return function(n,t){return n+(St(t.minSize,n)||t.minDataValue)}(n,t);case"constant":return function(n,t){const e=n.stops;let i=e&&e.length&&e[0].size;return null==i&&(i=n.minSize),St(i,t)}(t,n);case"clamped-linear":return function(n,t){const e=(n-t.minDataValue)/(t.maxDataValue-t.minDataValue),i=St(t.minSize,n),r=St(t.maxSize,n);return n<=t.minDataValue?i:n>=t.maxDataValue?r:i+e*(r-i)}(n,t);case"proportional":return function(n,t){const e=n/t.minDataValue,i=St(t.minSize,n),r=St(t.maxSize,n);let a=null;return a=e*i,(0,gt.uZ)(a,i,r)}(n,t);case"stops":return function(n,t){const[e,i,r]=function(n,t){if(!t)return;let e=0,i=t.length-1;return t.some((r,a)=>n<r?(i=a,!0):(e=a,!1)),[e,i,(n-t[e])/(t[i]-t[e])]}(n,t.cache.ipData);if(e===i)return St(t.stops[e].size,n);{const a=St(t.stops[e].size,n);return a+(St(t.stops[i].size,n)-a)*r}}(n,t);case"real-world-size":return function(n,t){const e=Yr.a[t.valueUnit],i=St(t.minSize,n),r=St(t.maxSize,n),{valueRepresentation:a}=t;let o=null;return o="area"===a?2*Math.sqrt(n/qr)/e:"radius"===a||"distance"===a?2*n/e:n/e,(0,gt.uZ)(o,i,r)}(n,t);case"identity":return n;case"unknown":return null}}function St(n,t){return"number"==typeof n?n:Di(t,n)}function Jt(n,t){const e=[];n.forEachTile(i=>e.push(i)),e.sort((i,r)=>i.instanceId-r.instanceId),e.forEach(i=>{(0,C.pC)(i.labelMetrics)&&i.isReady&&t(i,i.labelMetrics.getCursor())})}function ln(n){return t=>(0,Ct.F2)(Di(t,n))}function cn(n,t){if(!function(n){return"feature"===n.layer.type||"csv"===n.layer.type||"geojson"===n.layer.type||"ogc-feature"===n.layer.type||"stream"===n.layer.type||"subtype-group"===n.layer.type||"wfs"===n.layer.type}(t))return;const e="subtype-group"===t.layer.type?t.layer.sublayers.items:[t.layer],i=t.layer.geometryType,r=!function(n){for(const e of n){var t;const i="featureReduction"in e&&"cluster"===(null==(t=e.featureReduction)?void 0:t.type)&&e.featureReduction,r=[...e.labelingInfo||[],...i.labelingInfo||[]];if(e.labelsVisible&&r.length&&r.some(a=>"none"===a.deconflictionStrategy))return!0}return!1}(e),a={};if("subtype-group"!==t.layer.type){if("heatmap"===t.layer.renderer.type)return;const h=function(n){const t="visualVariables"in n&&n.visualVariables;if(!t)return null;for(const e of t)if("size"===e.type)return ln(e);return null}(t.layer.renderer);a[0]=h}const o=t.tileRenderer;if((0,C.Wi)(o))return;const l=t.layer.visible&&!t.suspended;n.push({tileRenderer:o,vvEvaluators:a,deconflictionEnabled:r,geometryType:i,visible:l})}class dn{run(t,e,i){const r=[];for(let a=t.length-1;a>=0;a--)cn(r,t[a]);this._transformMetrics(r,e),this._runCollision(r,e,i)}_runCollision(t,e,i){const[r,a]=e.state.size,o=new Qr(r*e.pixelRatio,a*e.pixelRatio);for(const{tileRenderer:l,deconflictionEnabled:h,visible:c}of t){const f=l.featuresView.attributeView;h?c?(this._prepare(l),this._collideVisible(o,l,i),this._collideInvisible(o,l)):Jt(l,(d,_)=>{for(;_.nextId();)f.setLabelMinZoom(_.id,255)}):Jt(l,(d,_)=>{for(;_.nextId();)f.setLabelMinZoom(_.id,0)})}}_isFiltered(t,e,i){const r=e.getFilterFlags(t),a=!i.hasFilter||!!(r&$.Zd),o=!(0,C.pC)(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(r&$.iV);return!(a&&o)}_prepare(t){const e=t.featuresView.attributeView,i=new Set;Jt(t,(r,a)=>{for(;a.nextId();)if(!i.has(a.id)){if(i.add(a.id),this._isFiltered(a.id,e,t.layerView)){e.setLabelMinZoom(a.id,254);continue}0!==e.getLabelMinZoom(a.id)?e.setLabelMinZoom(a.id,255):e.setLabelMinZoom(a.id,0)}})}_collideVisible(t,e,i){const r=e.featuresView.attributeView,a=new Set;Jt(e,(o,l)=>{for(;l.nextId();)if(!a.has(l.id))if(o.key.level===i){if(0===r.getLabelMinZoom(l.id))switch(t.insertMetrics(l)){case 1:break;case 2:r.setLabelMinZoom(l.id,254),a.add(l.id);break;case 0:r.setLabelMinZoom(l.id,0),a.add(l.id)}}else r.setLabelMinZoom(l.id,254)})}_collideInvisible(t,e){const i=e.featuresView.attributeView,r=new Set;Jt(e,(a,o)=>{for(;o.nextId();)if(!r.has(o.id)&&255===i.getLabelMinZoom(o.id))switch(t.insertMetrics(o)){case 1:break;case 2:i.setLabelMinZoom(o.id,255),r.add(o.id);break;case 0:i.setLabelMinZoom(o.id,0),r.add(o.id)}})}_transformMetrics(t,e){for(const{tileRenderer:i,geometryType:r,vvEvaluators:a}of t)Jt(i,(o,l)=>{const h=i.featuresView.attributeView,c=o.transforms.labelMat2d;c[4]=Math.round(c[4]),c[5]=Math.round(c[5]);const f=c[4],d=c[5],_="polyline"===r;for(;l.next();){const m=l.boundsCount,v=l.anchorX,u=l.anchorY;let b=l.size;const M=a[0];if((0,C.pC)(M)){const x=M(h.getVVSize(l.id));b=isNaN(x)||null==x||x===1/0?b:x}const w=l.directionX*(b/2),S=l.directionY*(b/2);for(let x=0;x<m;x++){let B=v,O=l.anchorY;if(_){let X=B+l.boundsX(x)+w,L=O+l.boundsY(x)+S;e.state.rotation?(X=c[0]*X+c[2]*L+c[4],L=c[1]*X+c[3]*L+c[5]):(X+=f,L+=d),l.setBoundsComputedAnchorX(x,Math.floor(X)),l.setBoundsComputedAnchorY(x,Math.floor(L))}else{e.state.rotation?(B=c[0]*v+c[2]*u+c[4],O=c[1]*v+c[3]*u+c[5]):(B+=f,O+=d);const X=B+l.boundsX(x)+w,L=O+l.boundsY(x)+S;l.setBoundsComputedAnchorX(x,X),l.setBoundsComputedAnchorY(x,L)}}}})}}const fn=re.Z.getLogger("esri.views.2d.layers.labels.LabelManager");let $t=class extends((0,jr.p)(Yt.Z)){constructor(n){super(n),this._applyVisibilityPassThrottled=(0,$r.P)(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new dn}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(n){this._applyVisibilityPassThrottled(n)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(n){this._set("updateParameters",n),this.updateRequested&&(this.updateRequested=!1,this.update(n))}_applyVisibilityPass(n){try{const t=this.view.featuresTilingScheme.getClosestInfoForScale(n.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,n,t)}catch(t){fn.error(new E.Z("mapview-labeling","Encountered an error during label decluttering",t))}}};(0,W._)([(0,K.Cb)()],$t.prototype,"updateRequested",void 0),(0,W._)([(0,K.Cb)({readOnly:!0})],$t.prototype,"updateParameters",void 0),(0,W._)([(0,K.Cb)()],$t.prototype,"updating",null),(0,W._)([(0,K.Cb)()],$t.prototype,"view",void 0),$t=(0,W._)([(0,qt.j)("esri.views.2d.layers.labels.LabelManager")],$t);const pn=$t;var mn=p(42302),gn=p(84853),we=p(40166),Te=p(36262),vt=p(55008),Ii=p(2704);const Ee_container="esri-zoom-box__container",Ee_overlay="esri-zoom-box__overlay",Ee_background="esri-zoom-box__overlay-background",Ee_box="esri-zoom-box__outline",We_zoom="Shift",We_counter="Ctrl";let de=class extends Yt.Z{constructor(n){super(n),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(n){this._handles&&this._handles.forEach(t=>{t.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",n),n&&(n.on("drag",[We_zoom],t=>this._handleDrag(t,1),Ii.f.INTERNAL),n.on("drag",[We_zoom,We_counter],t=>this._handleDrag(t,-1),Ii.f.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(n,t,e,i){this._box.x=n,this._box.y=t,this._box.width=e,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(n,t,e,i,r){const a=this.view,o=a.toMap((0,Ct.vW)(n+.5*e,t+.5*i));let l=Math.max(e/a.width,i/a.height);-1===r&&(l=1/l),this._destroyOverlay(),this.navigation.end(),a.goTo({center:o,scale:a.scale*l})}_updateBox(n,t,e,i){const r=this._boxShape;r.setAttributeNS(null,"x",""+n),r.setAttributeNS(null,"y",""+t),r.setAttributeNS(null,"width",""+e),r.setAttributeNS(null,"height",""+i),r.setAttributeNS(null,"class",Ee_box)}_updateBackground(n,t,e,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(n,t,e,i,this.view.width,this.view.height))}_createContainer(){const n=document.createElement("div");n.className=Ee_container,this.view.root.appendChild(n),this._container=n}_createOverlay(){const n=this.view.width,t=this.view.height,e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttributeNS(null,"d","M 0 0 L "+n+" 0 L "+n+" "+t+" L 0 "+t+" Z"),e.setAttributeNS(null,"class",Ee_background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttributeNS(null,"class",Ee_overlay),r.appendChild(e),r.appendChild(i),this._container.appendChild(r),this._backgroundShape=e,this._boxShape=i,this._overlay=r}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(n,t,e,i,r,a){const o=n+e,l=t+i;return"M 0 0 L "+r+" 0 L "+r+" "+a+" L 0 "+a+" ZM "+n+" "+t+" L "+n+" "+l+" L "+o+" "+l+" L "+o+" "+t+" Z"}_handleDrag(n,t){const e=n.x,i=n.y,r=n.origin.x,a=n.origin.y;let o,l,h,c;switch(e>r?(o=r,h=e-r):(o=e,h=r-e),i>a?(l=a,c=i-a):(l=i,c=a-i),n.action){case"start":this._start();break;case"update":this._update(o,l,h,c);break;case"end":this._end(o,l,h,c,t)}n.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:n,y:t,width:e,height:i}=this._box;this._updateBox(n,t,e,i),this._updateBackground(n,t,e,i),this._rafId=requestAnimationFrame(this._redraw)}};(0,W._)([(0,K.Cb)()],de.prototype,"navigation",void 0),(0,W._)([(0,K.Cb)()],de.prototype,"view",null),de=(0,W._)([(0,qt.j)("esri.views.2d.navigation.ZoomBox")],de);const vn=de;p(61243);var Se=p(63702);class Vt{constructor(t){this.gain=t}update(t){if(this.hasLastValue){const e=this.computeDelta(t);this.updateDelta(e)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(t){return t-this.lastValue}updateDelta(t){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*t:this.filteredDelta=t}}class Ze{constructor(t,e,i){this._initialVelocity=t,this._stopVelocity=e,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,e){const i=this.value(t);return this.value(t+e)-i}valueFromInitialVelocity(t,e){e=Math.min(e,this.duration);const i=1-this.friction;return t*(ie(i,e)-1)/Math.log(i)}}class bn extends Ze{constructor(t,e,i,r,a){super(t,e,i),this.sceneVelocity=r,this.direction=a}value(t){return super.valueFromInitialVelocity(this.sceneVelocity,t)}}class yn{constructor(t=300,e=12,i=.84){this.minimumInitialVelocity=t,this.stopVelocity=e,this.friction=i,this.enabled=!0,this.time=new Vt(.6),this.screen=[new Vt(.4),new Vt(.4)],this.scene=[new Vt(.6),new Vt(.6),new Vt(.6)],this.tmpDirection=(0,oe.c)()}add(t,e,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.scene[0].update(e[0]),this.scene[1].update(e[1]),this.scene[2].update(e[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,e=this.screen[1].filteredDelta,i=Math.sqrt(t*t+e*e)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(t,e,i){(0,Se.s)(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const r=(0,Se.l)(this.tmpDirection);r>0&&(0,Se.a)(this.tmpDirection,this.tmpDirection,1/r);const a=r/this.time.filteredDelta;return new bn(t,e,i,a,this.tmpDirection)}}let te=class extends Yt.Z{constructor(n){super(n),this.animationTime=0,this.momentumEstimator=new yn(500,6,.92),this.momentum=null,this.tmpMomentum=(0,oe.c)(),this.momentumFinished=!1,this.viewpoint=new we.Z({targetGeometry:new Te.Z,scale:0,rotation:0}),this.watch("momentumFinished",t=>{t&&this.navigation.stop()})}begin(n,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}update(n,t){this.addToEstimator(t);let e=t.center.x,i=t.center.y;const r=this.previousDrag;e=r?r.center.x-e:-e,i=r?i-r.center.y:i,n.viewpoint=(0,vt.Rx)(this.viewpoint,n.viewpoint,[e||0,i||0]),this.previousDrag=t}end(n,t){this.addToEstimator(t);const e=n.navigation.momentumEnabled;this.momentum=e?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(n),this.previousDrag=null,this.navigation.end()}addToEstimator(n){const t=n.center.x,e=n.center.y,i=(0,Ct.s1)(-t,e),r=(0,oe.f)(-t,e,0);this.momentumEstimator.add(i,r,.001*n.timestamp)}onAnimationUpdate(n){this.navigation.animationManager.animateContinous(n.viewpoint,(t,e)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const i=.001*e;if(!this.momentumFinished){const r=this.momentum.valueDelta(this.animationTime,i);(0,Se.a)(this.tmpMomentum,this.momentum.direction,r),(0,vt.Rx)(t,t,this.tmpMomentum),n.constraints.constrainByGeometry(t)}this.animationTime+=i})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};(0,W._)([(0,K.Cb)()],te.prototype,"momentumFinished",void 0),(0,W._)([(0,K.Cb)()],te.prototype,"viewpoint",void 0),(0,W._)([(0,K.Cb)()],te.prototype,"navigation",void 0),te=(0,W._)([(0,qt.j)("esri.views.2d.navigation.actions.Pan")],te);const xn=te;class Ui{constructor(t=2.5,e=.01,i=.95,r=12){this.minimumInitialVelocity=t,this.stopVelocity=e,this.friction=i,this.maxVelocity=r,this.enabled=!0,this.value=new Vt(.8),this.time=new Vt(.3)}add(t,e){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(e)<.01)return;if(this.value.hasFilteredDelta){const i=this.value.computeDelta(t);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(e),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=(0,gt.uZ)(t,-this.maxVelocity,this.maxVelocity),Math.abs(t)<this.minimumInitialVelocity?null:this.createMomentum(t,this.stopVelocity,this.friction)}createMomentum(t,e,i){return new Ze(t,e,i)}}class wn extends Ui{constructor(t=3,e=.01,i=.95,r=12){super(t,e,i,r)}add(t,e){if(this.value.hasLastValue){const i=this.value.lastValue;let r=t-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;t=i+r}super.add(t,e)}}class Tn extends Ze{constructor(t,e,i){super(t,e,i)}value(t){const e=super.value(t);return Math.exp(e)}valueDelta(t,e){const i=super.value(t),r=super.value(t+e)-i;return Math.exp(r)}}class En extends Ui{constructor(t=2.5,e=.01,i=.95,r=12){super(t,e,i,r)}add(t,e){super.add(Math.log(t),e)}createMomentum(t,e,i){return new Tn(t,e,i)}}let ee=class extends Yt.Z{constructor(n){super(n),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new wn(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new En,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new we.Z({targetGeometry:new Te.Z,scale:0,rotation:0}),this.watch("_momentumFinished",t=>{t&&this.navigation.stop()})}begin(n,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,n.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(n,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);const e=t.angle,i=t.radius,r=t.center,a=Math.abs(180*(e-this._startAngle)/Math.PI),o=Math.abs(i-this._startRadius),l=this._startRadius/i;if(this._previousRadius){const h=i/this._previousRadius;let c=180*(e-this._previousAngle)/Math.PI;this._rotationDirection=c>=0?1:-1,this._zoomDirection=h>=1?1:-1,n.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=o-a>0),null===this._zoomOnly||this._zoomOnly?c=0:this.addToRotateEstimator(e-this._startAngle,t.timestamp)):c=0,this.addToZoomEstimator(t,l),this.navigation.setViewpoint([r.x,r.y],1/h,c,[this._previousCenter.x-r.x,r.y-this._previousCenter.y])}this._previousAngle=e,this._previousRadius=i,this._previousCenter=r}end(n){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(n),this.navigation.end()}addToRotateEstimator(n,t){this._rotationMomentumEstimator.add(n,.001*t)}addToZoomEstimator(n,t){this._zoomMomentumEstimator.add(t,.001*n.timestamp)}canZoomIn(n){const t=n.scale,e=n.constraints.effectiveMaxScale;return 0===e||t>e}canZoomOut(n){const t=n.scale,e=n.constraints.effectiveMinScale;return 0===e||t<e}onAnimationUpdate(n){this.navigation.animationManager.animateContinous(n.viewpoint,(t,e)=>{const i=!this.canZoomIn(n)&&this._zoomDirection>1||!this.canZoomOut(n)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),a=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),o=.001*e;if(this._momentumFinished=r&&a,!this._momentumFinished){const l=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,o))*this._rotationDirection*180/Math.PI:0;let h=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,o)):1;const c=(0,it.a)(),f=(0,it.a)();if(this._previousCenter){(0,V.s)(c,this._previousCenter.x,this._previousCenter.y),(0,vt.Dq)(f,n.size,n.padding),(0,V.m)(c,c,f);const{constraints:d,scale:_}=n,m=_*h;h<1&&!d.canZoomInTo(m)?(h=_/d.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):h>1&&!d.canZoomOutTo(m)&&(h=_/d.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),(0,vt.UZ)(t,n.viewpoint,h,l,c,n.size),n.constraints.constrainByGeometry(t)}}this._animationTime+=o})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};(0,W._)([(0,K.Cb)()],ee.prototype,"_momentumFinished",void 0),(0,W._)([(0,K.Cb)()],ee.prototype,"viewpoint",void 0),(0,W._)([(0,K.Cb)()],ee.prototype,"navigation",void 0),ee=(0,W._)([(0,qt.j)("esri.views.2d.navigation.actions.Pinch")],ee);const Sn=ee,ke=(0,it.a)(),zi=(0,it.a)();let _e=class extends Yt.Z{constructor(n){super(n),this._previousCenter=(0,it.a)(),this.viewpoint=new we.Z({targetGeometry:new Te.Z,scale:0,rotation:0})}begin(n,t){this.navigation.begin(),(0,V.s)(this._previousCenter,t.center.x,t.center.y)}update(n,t){const{state:{size:e,padding:i}}=n;(0,V.s)(ke,t.center.x,t.center.y),(0,vt.ni)(zi,e,i),n.viewpoint=(0,vt.$H)(this.viewpoint,n.state.paddedViewState.viewpoint,(0,vt.dI)(zi,this._previousCenter,ke)),(0,V.c)(this._previousCenter,ke)}end(){this.navigation.end()}};(0,W._)([(0,K.Cb)()],_e.prototype,"viewpoint",void 0),(0,W._)([(0,K.Cb)()],_e.prototype,"navigation",void 0),_e=(0,W._)([(0,qt.j)("esri.views.2d.actions.Rotate")],_e);const Fn=_e,He=new we.Z({targetGeometry:new Te.Z}),Xe=[0,0];let Bt=class extends Yt.Z{constructor(n){super(n),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new xn({navigation:this}),this.rotate=new Fn({navigation:this}),this.pinch=new Sn({navigation:this}),this.zoomBox=new vn({view:this.view,navigation:this})}destroy(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}zoom(n,t=this._getDefaultAnchor()){var e=this;return(0,D.Z)(function*(){if(e.stop(),e.begin(),e.view.constraints.snapToZoom&&e.view.constraints.effectiveLODs)return n<1?e.zoomIn(t):e.zoomOut(t);e.setViewpoint(t,n,0,[0,0])})()}zoomIn(n){var t=this;return(0,D.Z)(function*(){const e=t.view,i=e.constraints.snapToNextScale(e.scale);return t._zoomToScale(i,n)})()}zoomOut(n){var t=this;return(0,D.Z)(function*(){const e=t.view,i=e.constraints.snapToPreviousScale(e.scale);return t._zoomToScale(i,n)})()}setViewpoint(n,t,e,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,n,t,e,i),this.end()}setViewpointImmediate(n,t=0,e=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,n,t,e)}continousRotateClockwise(){const n=this.get("view.viewpoint");this.animationManager.animateContinous(n,t=>{(0,vt.$H)(t,t,-1)})}continousRotateCounterclockwise(){const n=this.get("view.viewpoint");this.animationManager.animateContinous(n,t=>{(0,vt.$H)(t,t,1)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(n){const t=this.get("view.viewpoint");this.animationManager.animateContinous(t,e=>{(0,vt.Rx)(e,e,n),this.view.constraints.constrainByGeometry(e)})}_startTimer(n){return null!==this._endTimer||(this._endTimer=setTimeout(()=>{this._endTimer=null;const t=performance.now()-this._lastEventTimestamp;t<250?this._endTimer=this._startTimer(t):this._set("interacting",!1)},n)),this._endTimer}_getDefaultAnchor(){const{size:n,padding:{left:t,right:e,top:i,bottom:r}}=this.view;return Xe[0]=.5*(n[0]-e+t),Xe[1]=.5*(n[1]-r+i),Xe}_zoomToScale(n,t=this._getDefaultAnchor()){var e=this;return(0,D.Z)(function*(){const{view:i}=e,{constraints:r,scale:a,viewpoint:o,size:l,padding:h}=i,c=r.canZoomInTo(n),f=r.canZoomOutTo(n);if(!(n<a&&!c||n>a&&!f))return(0,vt.gG)(He,o,n/a,0,t,l,h),r.constrainByGeometry(He),i.goTo(He,{animate:!0})})()}_scaleRotateTranslateViewpoint(n,t,e,i,r){const{view:a}=this,{size:o,padding:l,constraints:h,scale:c,viewpoint:f}=a,d=c*e,_=h.canZoomInTo(d),m=h.canZoomOutTo(d);return(e<1&&!_||e>1&&!m)&&(e=1),(0,vt.Rx)(f,f,r),(0,vt.gG)(n,f,e,i,t,o,l),h.constrainByGeometry(n)}};(0,W._)([(0,K.Cb)()],Bt.prototype,"animationManager",void 0),(0,W._)([(0,K.Cb)({type:Boolean,readOnly:!0})],Bt.prototype,"interacting",void 0),(0,W._)([(0,K.Cb)()],Bt.prototype,"pan",void 0),(0,W._)([(0,K.Cb)()],Bt.prototype,"pinch",void 0),(0,W._)([(0,K.Cb)()],Bt.prototype,"rotate",void 0),(0,W._)([(0,K.Cb)()],Bt.prototype,"view",void 0),(0,W._)([(0,K.Cb)()],Bt.prototype,"zoomBox",void 0),Bt=(0,W._)([(0,qt.j)("esri.views.2d.navigation.MapViewNavigation")],Bt);const Mn=Bt;var Cn=p(65333),Rn=p(30164),Bn=p(17821);const Gi={shaders:{vertexShader:(0,_t.w)("magnifier/magnifier.vert"),fragmentShader:(0,_t.w)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};var Ni=p(55481);function je(){return(je=(0,D.Z)(function*(n){const t=p.e(4811).then(p.bind(p,94811)),e=p.e(7875).then(p.bind(p,7875)),i=(0,Ni.t)((yield t).default,{signal:n}),r=(0,Ni.t)((yield e).default,{signal:n}),a={mask:yield i,overlay:yield r};return(0,nt.k_)(n),a})).apply(this,arguments)}class An extends Bn.s{constructor(){super(),this._handles=new Cn.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(t){this._background=t,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(t){this._magnifier=t,this._handles.removeAll(),this._handles.add([(0,I.S1)(t,"version",()=>{this.visible=t.visible&&(0,C.pC)(t.position)&&t.size>0,this.requestRender()}),t.watch(["mask","overlay"],()=>this._reloadResources()),t.watch("size",()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:(0,ht.c)()}}doRender(t){var e;const i=t.context;if(!this._resourcesTask)return void this._reloadResources();if(t.drawPhase!==F.jx.MAP||!this._canRender())return;this._updateResources(t);const r=this._magnifier;if((0,C.Wi)(r.position))return;const a=t.pixelRatio,o=r.size*a,l=1/r.factor,h=Math.ceil(l*o);this._readbackTexture.resize(h,h);const{size:c}=t.state,f=a*c[0],d=a*c[1],_=.5*h,m=.5*h,v=(0,gt.uZ)(a*r.position.x,_,f-_-1),u=(0,gt.uZ)(d-a*r.position.y,m,d-m-1);i.setBlendingEnabled(!0);const b=v-_,M=u-m,w=this._readbackTexture;i.bindTexture(w,0),i.gl.copyTexImage2D(w.descriptor.target,0,w.descriptor.pixelFormat,b,M,h,h,0);const S=null==(e=this.background)?void 0:e.color,x=S?[S.a*S.r/255,S.a*S.g/255,S.a*S.b/255,S.a]:[1,1,1,1],B=(v+r.offset.x*a)/f*2-1,O=(u-r.offset.y*a)/d*2-1,X=o/f*2,L=o/d*2,Z=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(Z),Z.setUniform4fv("u_background",x),Z.setUniform1i("u_readbackTexture",0),Z.setUniform1i("u_overlayTexture",6),Z.setUniform1i("u_maskTexture",7),Z.setUniform4f("u_drawPos",B,O,X,L),Z.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),Z.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){var t=this;this._resourcesTask&&this._resourcesTask.abort();const e=(0,C.pC)(this._magnifier)?this._magnifier.maskUrl:null,i=(0,C.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,nt.vr)(function(){var r=(0,D.Z)(function*(a){const o=(0,C.Wi)(e)||(0,C.Wi)(i)?function(n){return je.apply(this,arguments)}(a):null,l=(0,C.pC)(e)?(0,se.default)(e,{responseType:"image",signal:a}).then(d=>d.data):o.then(d=>d.mask),h=(0,C.pC)(i)?(0,se.default)(i,{responseType:"image",signal:a}).then(d=>d.data):o.then(d=>d.overlay),[c,f]=yield Promise.all([l,h]);t.mask=c,t.overlay=f,t._disposeRenderResources(),t.requestRender()});return function(a){return r.apply(this,arguments)}}())}_disposeRenderResources(){this._readbackTexture=(0,C.O3)(this._readbackTexture),this._overlayTexture=(0,C.O3)(this._overlayTexture),this._maskTexture=(0,C.O3)(this._maskTexture),this._vertexArrayObject=(0,C.O3)(this._vertexArrayObject),this._program=(0,C.O3)(this._program)}_updateResources(t){if(t.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const e=t.context;this._resourcePixelRatio=t.pixelRatio;const i=Math.ceil(this._magnifier.size*t.pixelRatio);var n;this._program=(n=e,(0,R.H)(n,Gi));const a=new Uint16Array([0,1,0,0,1,1,1,0]),o=Gi.attributes;this._vertexArrayObject=new k.Z(e,o,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:ct.Z.createVertex(e,35044,a)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new U.Z(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!(0,Rn.zd)(this.overlay.src)||!t.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new U.Z(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);const l=1/this._magnifier.factor;this._readbackTexture=new U.Z(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(l*i),height:Math.ceil(l*i)})}}}}]);
//# sourceMappingURL=6390.01c0cb295702d7c7c82e.js.map