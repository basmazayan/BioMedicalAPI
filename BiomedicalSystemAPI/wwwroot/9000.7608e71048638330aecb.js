"use strict";var Be=Object.defineProperty,Ae=Object.defineProperties,Le=Object.getOwnPropertyDescriptors,fe=Object.getOwnPropertySymbols,Ne=Object.prototype.hasOwnProperty,je=Object.prototype.propertyIsEnumerable,pe=(J,M,S)=>M in J?Be(J,M,{enumerable:!0,configurable:!0,writable:!0,value:S}):J[M]=S,re=(J,M)=>{for(var S in M||(M={}))Ne.call(M,S)&&pe(J,S,M[S]);if(fe)for(var S of fe(M))je.call(M,S)&&pe(J,S,M[S]);return J},oe=(J,M)=>Ae(J,Le(M));(self.webpackChunkbio_medical=self.webpackChunkbio_medical||[]).push([[9e3],{70599:(J,M,S)=>{S.d(M,{Z:()=>U});var G=S(7808);class U{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(T,P,x){this._layerById[P]=x,this._layerByName[T]=x}featureSetByName(T,P=!0,x=["*"]){return void 0===this._layerByName[T]?this.resolvePromise(null):this.resolvePromise(this._layerByName[T])}featureSetById(T,P=!0,x=["*"]){return void 0===this._layerById[T]?this.resolvePromise(null):this.resolvePromise(this._layerById[T])}castToText(){return"object, FeatureSetCollection"}resolvePromise(T){return(0,G.DB)(T)}}},99e3:(J,M,S)=>{S.r(M),S.d(M,{constructAssociationMetaDataFeatureSetFromUrl:()=>be,constructFeatureSet:()=>ee,constructFeatureSetFromPortalItem:()=>Oe,constructFeatureSetFromRelationship:()=>Ce,constructFeatureSetFromUrl:()=>ae,convertToFeatureSet:()=>xe,createFeatureSetCollectionFromMap:()=>Ee,createFeatureSetCollectionFromService:()=>Re,getPortal:()=>Te,initialiseMetaDataCache:()=>we,lookupUser:()=>Pe});var G=S(77871),U=S(30351),k=S(70599),T=S(61634),P=S(99326),x=S(31863),I=S(89899),b=S(59235),A=S(66189),_=S(17695),F=S(30914),y=S(24642),w=S(18817),f=S(61330),C=S(36403);class s{clone(){const e=new s;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,r){const n=new s;n.field=e;const u=C.WhereClause.create(t,r),a=function(v){if("function"===v.parseTree.type){if(0===v.parseTree.args.value.length)return{name:v.parseTree.name,expr:null};if(v.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=C.WhereClause.create((0,w.XF)(v.parseTree.args.value[0],y.Bj.Standardised,v.parameters),v.fieldsIndex);return{name:v.parseTree.name,expr:e}}return null}(u);if(null===a)throw new Error("Invalid Statistic Function");const l=a.name.toUpperCase().trim();if("MIN"===l){if(n.typeofstat="MIN",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===l){if(n.typeofstat="MAX",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===l)n.typeofstat="COUNT",n.workingexpr=a.expr;else if("STDEV"===l){if(n.typeofstat="STDDEV",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===l){if(n.typeofstat="SUM",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===l){if(n.typeofstat="AVG",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===l){if(n.typeofstat="AVG",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==l)throw new Error("Invalid Statistic Function");if(n.typeofstat="VAR",n.workingexpr=a.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}return n}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var c=S(22404),i=S(7808),d=S(96583),o=S(66536),p=S(62419);function g(v){if(!v)return"COUNT";switch(v.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class N extends A.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then(t=>(this._wset=t,this._wset)):(0,i.DB)(this._wset)}_isInFeatureSet(){return y.dj.InFeatureSet}nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,r=1;const n=this._parent?this._parent.getFieldsIndex():new p.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let a=!1;for(let l=0;l<this._config.groupbyfields.length;l++)if(this._config.groupbyfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}if(!1===a)for(let l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}!1===a?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}for(const a of this._config.statsfields){const l=new s;l.field=a.name,l.tofieldname=a.name,l.workingexpr=a.expression instanceof C.WhereClause?a.expression:C.WhereClause.create(a.expression,n),l.typeofstat=g(a.statistic),this._decodedStatsfield.push(l)}this._decodedGroupbyfield=[];for(const a of this._config.groupbyfields){const l={name:a.name,singlefield:null,tofieldname:a.name,expression:a.expression instanceof C.WhereClause?a.expression:C.WhereClause.create(a.expression,n)};this._decodedGroupbyfield.push(l)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const a of this._parent.fields)e[a.name.toUpperCase()]=1;this.types=null}else this.geometryType=y.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new d.Z({wkid:4326});this.fields=[];const u=new s;u.field=this.nextUniqueName(e),u.tofieldname=this.objectIdField,u.workingexpr=C.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),u.typeofstat="MIN",this._decodedStatsfield.push(u);for(const a of this._decodedGroupbyfield){const l=new o.Z;if(a.name=this.nextUniqueName(e),l.name=a.tofieldname,l.alias=l.name,(0,w.y5)(a.expression)){const h=this._parent.getField((0,w.zR)(a.expression,y.Bj.Standardised));if(!h)throw new Error("Field is not present for Aggregation");a.name=h.name,a.singlefield=h.name,this.phsyicalgroupbyfields.push(h.name),l.type=h.type}else{l.type=this.convertToEsriFieldType((0,w.DT)(a.expression,this._parent.fields));const h=new o.Z;h.name=a.name,h.alias=h.name,this.phsyicalgroupbyfields.push(a.name),this._adaptedFields.push(new I.yN(h,a.expression)),this._candosimplegroupby=!1}this.fields.push(l)}if(this._adaptedFields.length>0)for(const a of this._parent.fields)this._adaptedFields.push(new I.$X(a));for(let a=0;a<this._decodedStatsfield.length;a++){const l=new o.Z;let h=null;const m=this._decodedStatsfield[a];m.field=this.nextUniqueName(e),m.tofieldname===this.objectIdField&&(this._internalObjectIdField=m.field),l.name=m.tofieldname,l.alias=l.name;const R=null!==m.workingexpr&&(0,w.y5)(m.workingexpr)?(0,w.zR)(m.workingexpr,y.Bj.Standardised):"";switch(this._decodedStatsfield[a].typeofstat){case"SUM":if(""!==R){if(h=this._parent.getField(R),!h)throw new Error("Field is not present for Aggregation");l.type=h.type}else l.type="double";break;case"MIN":case"MAX":if(""!==R){if(h=this._parent.getField(R),!h)throw new Error("Field is not present for Aggregation");l.type=h.type}else l.type="double";break;case"COUNT":l.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==R&&(h=this._parent.getField(R),!h))throw new Error("Field is not present for Aggregation");l.type="double"}this.fields.push(l)}}_canDoAggregates(){return(0,i.DB)(!1)}_getFeatures(e,t,r,n){-1!==t&&this._featureCache[t];const u=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,u)?this._expandPagedSet(e,u,0,0,n).then(()=>this._getFeatures(e,t,r,n)):(0,i.DB)("success")}_getFilteredSet(e,t,r,n,u){if(""!==e)return(0,i.DB)(new _.Z([],[],!0,null));let a=null;const l={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then(()=>{if(null!==r)for(let h=0;h<this._decodedStatsfield.length;h++)if(!0===(0,w.hq)(r,this._decodedStatsfield[h].tofieldname)){l.nowhereclause=!0,r=null;break}if(null!==n){l.ordered=!0;for(let h=0;h<this._decodedStatsfield.length;h++)if(!0===n.scanForField(this._decodedStatsfield[h].tofieldname)){n=null,l.ordered=!1;break}if(null!==n)for(const h of this._decodedGroupbyfield)if(null===h.singlefield&&!0===n.scanForField(h.tofieldname)){n=null,l.ordered=!1;break}}return!1===this._candosimplegroupby?(0,i.DB)(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)}).then(h=>{if(h){let R=null;r&&(R=this._reformulateWhereClauseWithoutGroupByFields(r));let L=null;return n&&(L=this._reformulateOrderClauseWithoutGroupByFields(n)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,R,L,this._internalObjectIdField).then(O=>(this._checkCancelled(u),a=!0===l.nowhereclause?new _.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],!0===l.ordered&&O._ordered,this._clonePageDefinition(O.pagesDefinition)):new _.Z(O._candidates.slice(0),O._known.slice(0),!0===l.ordered&&O._ordered,this._clonePageDefinition(O.pagesDefinition)),a))}let m=this._parent;if(this._adaptedFields.length>0&&(m=new I.Xx({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===l.nowhereclause)a=new _.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new b.Z({parentfeatureset:m,orderbyclause:new F.Z(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let R=m;if(null!==r){let L=null;r&&(L=this._reformulateWhereClauseWithoutGroupByFields(r)),R=new T.Z({parentfeatureset:R,whereclause:L})}a=new _.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new b.Z({parentfeatureset:R,orderbyclause:new F.Z(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return a})}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,w.bB)(e,t.tofieldname,(0,w.zR)(t.workingexpr,y.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,w.bB)(e,t.tofieldname,(0,w.zR)(t.expression,y.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const r of this._decodedGroupbyfield)r.tofieldname!==r.name&&t.push({field:r.tofieldname,newfield:r.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,r){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,r).then(()=>this._refineSetBlock(e,t,r));this._checkCancelled(r);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,(0,i.DB)(e)}catch(n){return(0,i.d1)(n)}}_expandPagedSet(e,t,r,n,u){return this._expandPagedSetFeatureSet(e,t,r,n,u)}_getPhysicalPage(e,t,r){return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?(0,i.Ue)((n,u)=>{this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then(a=>{n(a)},u)}):this._getAgregagtePhysicalPage(e,t,r).then(n=>{for(const u of n){const a={geometry:u.geometry,attributes:{}};for(const l of this._decodedGroupbyfield)a.attributes[l.tofieldname]=u.attributes[l.name];for(const l of this._decodedStatsfield)a.attributes[l.tofieldname]=u.attributes[l.field];this._featureCache[a.attributes[this.objectIdField]]=new P.Z(a)}return n.length})}_sequentialGetPhysicalItem(e,t,r,n){return(0,i.Ue)((u,a)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?u(n.length):this._nextAggregateItem(e,t,r,n,l=>{null===l?u(n.length):(t-=1,u(this._sequentialGetPhysicalItem(e,t,r,n)))},a)})}_nextAggregateItem(e,t,r,n,u,a){try{(0,x.U)(e.pagesDefinition.internal.iterator.next()).then(l=>{if(null===l)if(null!==e.pagesDefinition.internal.workingItem){const h=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);n.push(h),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(h.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,u(null)}else e.pagesDefinition.internal.fullyResolved=!0,u(null);else{const h=this._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:h};else{if(h!==e.pagesDefinition.internal.workingItem.id){const m=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return n.push(m),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(m.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:h},void u(m)}e.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(e,t,r,n,u,a)}},a)}catch(l){a(l)}}_calculateFieldStat(e,t,r){const n=[];for(let u=0;u<e.features.length;u++)if(null!==t.workingexpr){const a=t.workingexpr.calculateValue(e.features[u]);null!==a&&n.push(a)}else n.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=(0,f.tj)("min",n,-1);break;case"MAX":r.attributes[t.tofieldname]=(0,f.tj)("max",n,-1);break;case"SUM":r.attributes[t.tofieldname]=(0,f.tj)("sum",n,-1);break;case"COUNT":r.attributes[t.tofieldname]=n.length;break;case"VAR":r.attributes[t.tofieldname]=(0,f.tj)("var",n,-1);break;case"STDDEV":r.attributes[t.tofieldname]=(0,f.tj)("stddev",n,-1);break;case"AVG":r.attributes[t.tofieldname]=(0,f.tj)("avg",n,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const n of this._decodedGroupbyfield){const u=n.singlefield?e.features[0].attributes[n.singlefield]:n.expression.calculateValue(e.features[0]);t.attributes[n.tofieldname]=u}for(const n of this._decodedStatsfield)this._calculateFieldStat(e,n,t);const r=[];for(let n=0;n<this._decodedStatsfield.length;n++)r.push(this._calculateFieldStat(e,this._decodedStatsfield[n],t));return this._featureCache[t.attributes[this.objectIdField]]=new P.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const r of this._decodedGroupbyfield){const n=r.singlefield?e.attributes[r.singlefield]:r.expression.calculateValue(e);t+=null==n?":":":"+n.toString()}return(0,c.F)(t,c.M.String)}_stat(){return(0,i.DB)({calculated:!1})}getFeatureByObjectId(){return(0,i.DB)(null)}static registerAction(){A.Z._featuresetFunctions.groupby=function(e,t){return new N({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var B=S(70295),E=S(27414),j=S(64749),Q=S(70279),V=S(33830),te=S(42187),$=S(86315),ie=S(42762),H=S(37995),ue=S(2022),de=S(75330),_e=S(36351),ye=S(41490);class se extends A.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return y.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,y.hd)(e.toJSON());return(0,c.F)(t,c.M.String)}load(){return null===this._loadPromise&&(this._loadPromise=(0,i.Ue)((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),e(this)}catch(r){t(r)}},t),this._layer.load()}catch(r){t(r)}})),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const r of this._layer.outFields)if(r.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const n of this._overrideFields)if(n.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=y.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=y.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=y.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=y.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return y.dj.InFeatureSet}_refineSetBlock(e){return(0,i.DB)(e)}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(t=>(this._wset=t,t)):(0,i.DB)(this._wset)}_runDatabaseProbe(e){return(0,i.Ue)((t,r)=>{try{this._ensureLoaded().then(()=>{try{const n=new H.Z;n.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(n).then(()=>{t(!0)},()=>{try{t(!1)}catch(u){r(u)}})}catch(n){r(n)}})}catch(n){r(n)}})}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){return e.quantizationParameters={mode:"edit"},(0,_e.executeQueryPBF)(this._layer.parsedUrl,e,new $.J({})).then(t=>ie.default.fromJSON((0,te.cn)(t.data)).unquantize())}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const r=new de.Z({url:this._layer.parsedUrl.path}),n="execute"===t&&this.pbfSupportedForQuery(e);let u=null;if(this.recentlyUsedQueries){const a=this.convertQueryToLruCacheKey(e);u=this.recentlyUsedQueries.getFromCache(a),null===u&&(u=!0!==n?r[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(a,u),u=u.catch(l=>{throw this.recentlyUsedQueries.removeFromCache(a),l}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===u&&(u=!0!==n?r[t](e):this.queryPBF(e)),u}_getFilteredSet(e,t,r,n,u){return this.databaseType().then(a=>{if(this.isTable()&&t&&null!==e&&""!==e)return new _.Z([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,r,n,u);let l="",h=!1;null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=n.constructClause(),h=!0);const m=new H.Z;return m.where=null===r?null===t?"1=1":"":(0,w.zR)(r,a),this._requestStandardised&&(m.sqlFormat="standard"),m.spatialRelationship=this._makeRelationshipEnum(e),m.outSpatialReference=this.spatialReference,m.orderByFields=""!==l?l.split(","):null,m.geometry=null===t?null:t,m.relationParameter=this._makeRelationshipParam(e),this.executeQuery(m,"executeForIds").then(R=>(null===R&&(R=[]),this._checkCancelled(u),new _.Z([],R,h,null)))})}_expandPagedSet(e,t,r,n,u){return this._expandPagedSetFeatureSet(e,t,r,n,u)}_getFilteredSetUsingPaging(e,t,r,n,u){try{let a="",l=!1;return null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(a=n.constructClause(),l=!0),this.databaseType().then(h=>{let m=null===r?null===t?"1=1":"":(0,w.zR)(r,h);this._layer.definitionExpression&&this._useDefinitionExpression&&(m=""!==m?"(("+this._layer.definitionExpression+") AND ("+m+"))":this._layer.definitionExpression);let R=this._maxQueryRate();const L=this._layer.capabilities.query.maxRecordCount;void 0!==L&&L<R&&(R=L);let O=null;if(!0===this._pageJustIds)O=new _.Z([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:R,resultOffset:0,geometry:null===t?null:t,where:m,orderByFields:a,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let K=!0;!0===this._removeGeometry&&(K=!1);const W=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);O=new _.Z([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:W.join(","),resultRecordCount:R,resultOffset:0,geometry:null===t?null:t,where:m,orderByFields:a,returnGeometry:K,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(O,R,0,1,u).then(()=>O)})}catch(a){return(0,i.d1)(a)}}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,r){try{const n=e.pagesDefinition.internal.lastRetrieved,u=n,a=e.pagesDefinition.internal.lastPage,l=new H.Z;return this._requestStandardised&&(l.sqlFormat="standard"),l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields.split(","),l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.geometry=e.pagesDefinition.geometry,l.where=e.pagesDefinition.where,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=e.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference,this.executeQuery(l,"execute").then(h=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==a)return"done";for(let m=0;m<h.features.length;m++)e.pagesDefinition.internal.set[u+m]=h.features[m].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let m=0;m<h.features.length;m++)this._featureCache[h.features[m].attributes[this._layer.objectIdField]]=h.features[m];return(void 0===h.exceededTransferLimit&&h.features.length!==e.pagesDefinition.resultRecordCount||!1===h.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+h.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})}catch(n){return(0,i.d1)(n)}}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let r=!1;for(const n of t)if(n.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t}_getFeatures(e,t,r,n){const u=[];try{if(-1!==t&&void 0===this._featureCache[t]&&u.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,n).then(()=>this._getFeatures(e,t,r,n));let a=0;for(let l=e._lastFetchedIndex;l<e._known.length;l++){if(e._lastFetchedIndex+=1,a++,void 0===this._featureCache[e._known[l]]){let h=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const m=this._layer._mode;if(void 0!==m._featureMap[e._known[l]]){const R=m._featureMap[e._known[l]];null!==R&&(h=!0,this._featureCache[e._known[l]]=R)}}if(!1===h&&(e._known[l]!==t&&u.push(e._known[l]),u.length>=this._maxProcessingRate()-1))break}if(a>=r&&0===u.length)break}if(0===u.length)return(0,i.DB)("success");try{const l=new H.Z;return this._requestStandardised&&(l.sqlFormat="standard"),l.objectIds=u,l.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),l.returnGeometry=!0,!0===this._removeGeometry&&(l.returnGeometry=!1),l.outSpatialReference=this.spatialReference,this.executeQuery(l,"execute").then(h=>{if(this._checkCancelled(n),void 0!==h.error)return(0,i.d1)(new Error(h.error));for(let m=0;m<h.features.length;m++)this._featureCache[h.features[m].attributes[this._layer.objectIdField]]=h.features[m];return"success"})}catch(l){return(0,i.d1)(l)}}catch(a){return(0,i.d1)(a)}}_getDistinctPages(e,t,r,n,u,a,l,h,m){return this._ensureLoaded().then(()=>this.databaseType()).then(R=>{let L=r.parseTree.column;for(let W=0;W<this._layer.fields.length;W++)if(this._layer.fields[W].name.toLowerCase()===L.toLowerCase()){L=this._layer.fields[W].name;break}const O=new H.Z;this._requestStandardised&&(O.sqlFormat="standard");let K=null===a?null===u?"1=1":"":(0,w.zR)(a,R);return this._layer.definitionExpression&&this._useDefinitionExpression&&(K=""!==K?"(("+this._layer.definitionExpression+") AND ("+K+"))":this._layer.definitionExpression),O.where=K,O.spatialRelationship=this._makeRelationshipEnum(n),O.relationParameter=this._makeRelationshipParam(n),O.geometry=null===u?null:u,O.returnDistinctValues=!0,O.returnGeometry=!1,O.outFields=[L],this.executeQuery(O,"execute").then(W=>{if(this._checkCancelled(m),!W.hasOwnProperty("features"))return(0,i.d1)(new Error("Unnexected Result querying statistics from layer"));let X=!1;for(let Z=0;Z<this._layer.fields.length;Z++)if(this._layer.fields[Z].name===L){"date"===this._layer.fields[Z].type&&(X=!0);break}for(let Z=0;Z<W.features.length;Z++){if(X){const z=W.features[Z].attributes[L];null!==z?h.push(new Date(z)):h.push(z)}else h.push(W.features[Z].attributes[L]);if(h.length>=l)break}return 0===W.features.length?h:W.features.length===this._layer.capabilities.query.maxRecordCount&&h.length<l?this._getDistinctPages(e+W.features.length,t,r,n,u,a,l,h,m).then(Z=>({calculated:!0,result:Z})):h})})}_distinctStat(e,t,r,n,u,a,l){return this._getDistinctPages(0,e,t,r,n,u,a,[],l).then(h=>({calculated:!0,result:h}))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,r,n){return this.databaseType().then(u=>{const a=new H.Z;if(this._requestStandardised&&(a.sqlFormat="standard"),this.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};let l=null===n?null===r?"1=1":"":(0,w.zR)(n,u);return this._layer.definitionExpression&&this._useDefinitionExpression&&(l=""!==l?"(("+this._layer.definitionExpression+") AND ("+l+"))":this._layer.definitionExpression),a.where=l,a.where=l,a.spatialRelationship=this._makeRelationshipEnum(t),a.relationParameter=this._makeRelationshipParam(t),a.geometry=null===r?null:r,a.returnGeometry=!1,this.executeQuery(a,"executeForCount").then(h=>({calculated:!0,result:h}))})}_stats(e,t,r,n,u,a,l){return this._ensureLoaded().then(()=>{const h=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,m=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,R=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?R?this._countstat(e,r,n,u):{calculated:!1}:!1===m||!1===(0,w.y5)(t)&&!1===h||!1===t.isStandardized?""!==r||null!==u?{calculated:!1}:this._manualStat(e,t,a,l):"distinct"===e?!1===R?""!==r||null!==u?{calculated:!1}:this._manualStat(e,t,a,l):this._distinctStat(e,t,r,n,u,a,l):this.databaseType().then(L=>{if(this.isTable()&&n&&null!==r&&""!==r)return{calculated:!0,result:null};const O=new H.Z;this._requestStandardised&&(O.sqlFormat="standard");let K=null===u?null===n?"1=1":"":(0,w.zR)(u,L);this._layer.definitionExpression&&this._useDefinitionExpression&&(K=""!==K?"(("+this._layer.definitionExpression+") AND ("+K+"))":this._layer.definitionExpression),O.where=K,O.spatialRelationship=this._makeRelationshipEnum(r),O.relationParameter=this._makeRelationshipParam(r),O.geometry=null===n?null:n;const W=new ue.Z;W.statisticType=(0,f.g3)(e),W.onStatisticField=(0,w.zR)(t,L),W.outStatisticFieldName="ARCADE_STAT_RESULT",O.returnGeometry=!1;let X="ARCADE_STAT_RESULT";return O.outStatistics=[W],this.executeQuery(O,"execute").then(Z=>{if(!Z.hasOwnProperty("features")||0===Z.features.length)return(0,i.d1)(new Error("Unnexected Result querying statistics from layer"));let z=!1;for(let Y=0;Y<Z.fields.length;Y++)if("ARCADE_STAT_RESULT"===Z.fields[Y].name.toUpperCase()){X=Z.fields[Y].name,"date"===Z.fields[Y].type&&(z=!0);break}if(z){let Y=Z.features[0].attributes[X];return null!==Y&&(Y=new Date(Z.features[0].attributes[X])),{calculated:!0,result:Y}}return{calculated:!0,result:Z.features[0].attributes[X]}})})})}_stat(e,t,r,n,u,a,l){return this._stats(e,t,r,n,u,a,l)}_canDoAggregates(e,t){return this._ensureLoaded().then(()=>{let r=!1;const n=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(r=!0),r)for(let u=0;u<t.length-1;u++)null!==t[u].workingexpr&&(!1===t[u].workingexpr.isStandardized||!1===(0,w.y5)(t[u].workingexpr)&&!1===n)&&(r=!1);return!1!==r})}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,r,n,u,a,l){return this._ensureLoaded().then(()=>this.databaseType()).then(h=>{let m="",R=!1,L=!1;null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(m=a.constructClause(),L=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(L=!1,R=!0,m=this._layer.objectIdField);const O=[];for(let Z=0;Z<t.length;Z++){const z=new ue.Z;z.onStatisticField=null!==t[Z].workingexpr?(0,w.zR)(t[Z].workingexpr,h):"",z.outStatisticFieldName=t[Z].field,z.statisticType=t[Z].toStatisticsName(),O.push(z)}""===m&&(m=e.join(","));let K=this._maxQueryRate();const W=this._layer.capabilities.query.maxRecordCount;void 0!==W&&W<K&&(K=W);let X=null===u?null===n?"1=1":"":(0,w.zR)(u,h);return this._layer.definitionExpression&&this._useDefinitionExpression&&(X=""!==X?"(("+this._layer.definitionExpression+") AND ("+X+"))":this._layer.definitionExpression),new _.Z([],["GETPAGES"],L,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(r),relationParam:this._makeRelationshipParam(r),outFields:["*"],useOIDpagination:R,generatedOid:l,resultRecordCount:K,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:O,geometry:null===n?null:n,where:X,orderByFields:m,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})}_getAgregagtePhysicalPage(e,t,r){try{let n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const u=e.pagesDefinition.internal.lastRetrieved,a=u,l=e.pagesDefinition.internal.lastPage,h=new H.Z;return this._requestStandardised&&(h.sqlFormat="standard"),h.where=n,h.spatialRelationship=e.pagesDefinition.spatialRel,h.relationParameter=e.pagesDefinition.relationParam,h.outFields=e.pagesDefinition.outFields,h.outStatistics=e.pagesDefinition.outStatistics,h.geometry=e.pagesDefinition.geometry,h.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,h.num=e.pagesDefinition.resultRecordCount,h.start=e.pagesDefinition.internal.lastPage,h.returnGeometry=e.pagesDefinition.returnGeometry,h.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&h.geometry&&h.spatialRelationship?(0,i.DB)([]):this.executeQuery(h,"execute").then(m=>{if(this._checkCancelled(r),!m.hasOwnProperty("features"))return(0,i.d1)(new Error("Unnexected Result querying aggregates from layer"));const R=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(let L=0;L<m.features.length;L++)e.pagesDefinition.internal.set[a+L]=m.features[L].attributes[e.pagesDefinition.generatedOid];for(let L=0;L<m.features.length;L++)R.push(new P.Z({attributes:m.features[L].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===m.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=m.features[m.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===m.exceededTransferLimit&&m.features.length!==e.pagesDefinition.resultRecordCount||!1===m.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=u+m.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,R})}catch(n){return(0,i.d1)(n)}}static create(e,t,r,n,u){const a=new V.default({url:e,outFields:null===t?["*"]:t});return new se({layer:a,spatialReference:r,lrucache:n,interceptor:u})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,y.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,r,n,u){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const a={objectIds:[e],returnMetadata:u};return(t&&t>0||r&&r>0)&&(a.size=[t&&t>0?t:0,r&&r>0?r:t+1]),n&&n.length>0&&(a.attachmentTypes=n),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:"attachments"}),this._layer.queryAttachments(a).then(l=>{const h=[];return l&&l[e]&&l[e].forEach(m=>{const R=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+m.id.toString();let L=null;u&&m.exifInfo&&(L=ye.Z.convertJsonToArcade(m.exifInfo,!0)),h.push(new j.Z(m.id,m.name,m.contentType,m.size,R,L))}),h})}return(0,i.DB)([])}queryRelatedFeatures(e){const t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),(0,U.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then(r=>{if(r.data){const n={},u=r.data;if(u&&u.relatedRecordGroups){const a=u.spatialReference;for(const l of u.relatedRecordGroups){const h=l.objectId,m=[];for(const R of l.relatedRecords){R.geometry&&(R.geometry.spatialReference=a);const L=new P.Z({geometry:R.geometry?(0,Q.im)(R.geometry):null,attributes:R.attributes});m.push(L)}n[h]={features:m,exceededTransferLimit:!0===u.exceededTransferLimit}}}return n}return(0,i.d1)("Invalid Request")})}getFeatureByObjectId(e,t){const r=new de.Z({url:this._layer.parsedUrl.path}),n=new H.Z;return n.outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:"execute"}),r.execute(n).then(u=>1===u.features.length?u.features[0]:null)}getIdentityUser(){return this.load().then(()=>{var e;const t=null==(e=G.id)?void 0:e.findCredential(this._layer.url);return t?t.userId:null})}getOwningSystemUrl(){return this.load().then(()=>{var e;const t=null==(e=G.id)?void 0:e.findServerInfo(this._layer.url);if(t)return(0,i.DB)(t.owningSystemUrl);let r=this._layer.url;const n=r.toLowerCase().indexOf("/rest/services");return r=n>-1?r.substring(0,n):r,r?(r+="/rest/info",(0,i.Ue)((u,a)=>{(0,U.default)(r,{query:{f:"json"}}).then(l=>{let h="";l.data&&l.data.owningSystemUrl&&(h=l.data.owningSystemUrl),u(h)},l=>{u("")})})):(0,i.DB)("")})}getDataSourceFeatureSet(){const e=new se({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}var ge=S(23956),he=S(39358);class me extends A.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return y.tI}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,i.Ue)((e,t)=>{(0,i.$6)([this._layer.load(),this.relatedLayer.load()]).then(()=>{this._initialiseFeatureSet(),e(this)},t)})),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],r=[];for(const n of this.fields)if("oid"===n.type)t.push(n),r.push(n.name);else for(const u of this._overrideFields)if(u.toLowerCase()===n.name.toLowerCase()){t.push(n),r.push(n.name);break}this.fields=t,this._overrideFields=r}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then(()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return y.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(t=>(this._wset=t,t)):(0,i.DB)(this._wset)}_changeFeature(e){const t={};for(const r of this.fields)t[r.name]=e.attributes[r.name];return new P.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,r,n,u){return this.databaseType().then(()=>{if(this.isTable()&&t&&null!==e&&""!==e)return new _.Z([],[],!0,null);const a=this._layer.nativeCapabilities();if(!1===a.canQueryRelated)return new _.Z([],[],!0,null);if(a.capabilities.queryRelated&&a.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,r,n,u);let l="",h=!1;null!==n&&a.capabilities&&a.capabilities.queryRelated&&!0===a.capabilities.queryRelated.supportsOrderBy&&(l=n.constructClause(),h=!0);const m=new he.Z;m.objectIds=[this._findObjectId];const R=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(O=>O.name):["*"]);m.outFields=R,m.relationshipId=this.relationship.id,m.where="1=1";let L=!0;return!0===this._removeGeometry&&(L=!1),m.returnGeometry=L,this._requestStandardised&&(m.sqlFormat="standard"),m.outSpatialReference=this.spatialReference,m.orderByFields=""!==l?l.split(","):null,a.source.queryRelatedFeatures(m).then(O=>{this._checkCancelled(u);const K=O[this._findObjectId]?O[this._findObjectId].features:[],W=[];for(let z=0;z<K.length;z++)this._featureCache[K[z].attributes[this._layer.objectIdField]]=K[z],W.push(K[z].attributes[this._layer.objectIdField]);const X=t&&null!==e&&""!==e,Z=null!=r;return new _.Z(X||Z?W:[],X||Z?[]:W,h,null)})})}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let r=!1;for(const n of t)if(n.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,r,n,u){try{let a="",l=!1;const h=this._layer.nativeCapabilities();return null!==n&&h&&h.capabilities.queryRelated&&!0===h.capabilities.queryRelated.supportsOrderBy&&(a=n.constructClause(),l=!0),this.databaseType().then(()=>{let R=this._maxQueryRate();const L=h.capabilities.query.maxRecordCount;void 0!==L&&L<R&&(R=L);const O=t&&null!==e&&""!==e,K=null!=r;let W=null,X=!0;!0===this._removeGeometry&&(X=!1);const Z=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(z=>z.name):["*"]);return W=new _.Z(O||K?["GETPAGES"]:[],O||K?[]:["GETPAGES"],l,{outFields:Z.join(","),resultRecordCount:R,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:a,returnGeometry:X,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(W,R,0,0,u).then(()=>W)})}catch(a){return(0,i.d1)(a)}}_expandPagedSet(e,t,r,n,u){return this._expandPagedSetFeatureSet(e,t,r,n,u)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,r){try{const n=e.pagesDefinition.internal.lastRetrieved,u=n,a=e.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),h=new he.Z;return!0===this._requestStandardised&&(h.sqlFormat="standard"),h.relationshipId=this.relationship.id,h.objectIds=e.pagesDefinition.objectIds,h.resultOffset=e.pagesDefinition.internal.lastPage,h.resultRecordCount=e.pagesDefinition.resultRecordCount,h.outFields=e.pagesDefinition.outFields.split(","),h.where=e.pagesDefinition.where,h.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,h.returnGeometry=e.pagesDefinition.returnGeometry,h.outSpatialReference=this.spatialReference,l.source.queryRelatedFeatures(h).then(m=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==a)return 0;const R=m[this._findObjectId]?m[this._findObjectId].features:[];for(let O=0;O<R.length;O++)e.pagesDefinition.internal.set[u+O]=R[O].attributes[this._layer.objectIdField];for(let O=0;O<R.length;O++)this._featureCache[R[O].attributes[this._layer.objectIdField]]=R[O];const L=!m[this._findObjectId]||!1===m[this._findObjectId].exceededTransferLimit;return R.length!==e.pagesDefinition.resultRecordCount&&L&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+R.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,R.length})}catch(n){return(0,i.d1)(n)}}_getFeatures(e,t,r,n){const u=[];-1!==t&&void 0===this._featureCache[t]&&u.push(t);const a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return this._expandPagedSet(e,a,0,0,n).then(()=>this._getFeatures(e,t,r,n));let l=0;for(let h=e._lastFetchedIndex;h<e._known.length&&(l++,l<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[h]&&void 0===this._featureCache[e._known[h]]&&(e._known[h]!==t&&u.push(e._known[h]),u.length>r)))&&!(l>=r&&0===u.length);h++);return 0===u.length?(0,i.DB)("success"):(0,i.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,t,r){return(0,i.DB)(e)}_stat(e,t,r,n,u,a,l){return(0,i.DB)({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,r,n,u){return(0,i.DB)(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,r,n,u){return this.relatedLayer.queryAttachments(e,t,r,n,u)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}var q=S(58591),Fe=S(70658),Se=S(35797);function we(){null===q.Z.applicationCache&&(q.Z.applicationCache=new q.Z)}function ne(v,e){if(q.Z.applicationCache){const t=q.Z.applicationCache.getLayerInfo(v);if(t)return t.then(u=>(0,i.DB)(new V.default({url:v,outFields:e,sourceJSON:u})));const r=new V.default({url:v,outFields:e});let n=(0,i.Ue)((u,a)=>{r.load().then(()=>{u(r.sourceJSON)},l=>{a(l)})});return q.Z.applicationCache&&(q.Z.applicationCache.setLayerInfo(v,n),n=n.catch(u=>{throw q.Z.applicationCache.clearLayerInfo(v),u})),n.then(()=>(0,i.DB)(r))}return(0,i.DB)(new V.default({url:v,outFields:e}))}function ae(v,e,t,r,n,u=null){return ne(v,["*"]).then(a=>(0,i.DB)(ee(a,e,t,r,n,u)))}function ee(v,e=null,t=null,r=!0,n=null,u=null){return!0===v._hasMemorySource()?new ge.Z({layer:v,spatialReference:e,outFields:t,includeGeometry:r,lrucache:n,interceptor:u}):new se({layer:v,spatialReference:e,outFields:t,includeGeometry:r,lrucache:n,interceptor:u})}function ce(v){if(null!==q.Z.applicationCache){const t=q.Z.applicationCache.getLayerInfo(v);if(null!==t)return t}let e=(0,U.default)(v,{responseType:"json",query:{f:"json"}}).then(t=>{if(t.data){const r=t.data;return r.layers||(r.layers=[]),r.tables||(r.tables=[]),(0,i.DB)(r)}return(0,i.DB)({layers:[],tables:[]})});return null!==q.Z.applicationCache&&(q.Z.applicationCache.setLayerInfo(v,e),e=e.catch(t=>{throw q.Z.applicationCache.clearLayerInfo(v),t})),e}function be(v,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return ce(v).then(r=>{if(t.metadata=r,r.controllerDatasetLayers&&void 0!==r.controllerDatasetLayers.utilityNetworkLayerId&&null!==r.controllerDatasetLayers.utilityNetworkLayerId){if(r.layers)for(const u of r.layers)t.layerNameLkp[u.id]=u.name;if(r.tables)for(const u of r.tables)t.layerNameLkp[u.id]=u.name;const n=r.controllerDatasetLayers.utilityNetworkLayerId;return t.networkId=n,function(v,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+v;if(null!==q.Z.applicationCache){const n=q.Z.applicationCache.getLayerInfo(t);if(null!==n)return n}let r=(0,U.default)(v+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}}).then(n=>{if(n.data){const u=n.data;if(u.layerDataElements&&u.layerDataElements[0])return u.layerDataElements[0]}throw new Error("Not Found")});return null!==q.Z.applicationCache&&(q.Z.applicationCache.setLayerInfo(t,r),r=r.catch(n=>{throw q.Z.applicationCache.clearLayerInfo(t),n})),r}(v,n).then(u=>{if(u){t.queryelem=u,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const a of t.queryelem.dataElement.domainNetworks){for(const l of a.edgeSources?a.edgeSources:[]){const h={layerId:l.layerId,sourceId:l.sourceId,className:t.layerNameLkp[l.layerId]?t.layerNameLkp[l.layerId]:null};h.className&&(t.lkp[h.className]=h)}for(const l of a.junctionSources?a.junctionSources:[]){const h={layerId:l.layerId,sourceId:l.sourceId,className:t.layerNameLkp[l.layerId]?t.layerNameLkp[l.layerId]:null};h.className&&(t.lkp[h.className]=h)}}if(t.queryelem.dataElement.terminalConfigurations)for(const a of t.queryelem.dataElement.terminalConfigurations)for(const l of a.terminals)t.terminals.push({terminalId:l.terminalId,terminalName:l.terminalName});return function(v){if(null!==q.Z.applicationCache){const t=q.Z.applicationCache.getLayerInfo(v);if(null!==t)return t}let e=(0,U.default)(v,{responseType:"json",query:{f:"json"}}).then(t=>{if(t.data){const r=t.data;return(0,i.DB)(r)}return(0,i.DB)(null)});return null!==q.Z.applicationCache&&(q.Z.applicationCache.setLayerInfo(v,e),e=e.catch(t=>{throw q.Z.applicationCache.clearLayerInfo(v),t})),e}(v+"/"+n).then(a=>{if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){const l=[];return t.unVersion>=4&&(l.push("STATUS"),l.push("PERCENTALONG")),ae(v+"/"+a.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...l],!1,null,null).then(h=>h.load()).then(h=>t.unVersion>=4?(h=h.filter(C.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",h.getFieldsIndex()))).load():h).then(h=>({lkp:t.lkp,associations:h,unVersion:t.unVersion,terminals:t.terminals}))}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}function Ce(v,e,t,r=null,n=null,u=!0,a=null,l=null){let h=v.serviceUrl();return h?(h="/"===h.charAt(h.length-1)?h+e.relatedTableId.toString():h+"/"+e.relatedTableId.toString(),ae(h,r,n,u,a,l).then(m=>new me({layer:v,relatedLayer:m,relationship:e,objectId:t,spatialReference:r,outFields:n,includeGeometry:u,lrucache:a,interceptor:l}))):null}T.Z.registerAction(),N.registerAction(),b.Z.registerAction(),B.Z.registerAction(),E.Z.registerAction();class ve extends k.Z{constructor(e,t=null,r=null,n=null){super(),this._map=e,this._overridespref=t,this.lrucache=r,this.interceptor=n,this._instantLayers=[]}makeAndAddFeatureSet(e,t=!0,r=null){const n=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}featureSetByName(e,t=!0,r=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetByName(e,t,r)}catch(a){return(0,i.d1)(a)}});null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let a=0;a<this._instantLayers.length;a++){const l=this._instantLayers[a];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}const u=this._map.layers.find(a=>a instanceof V.default&&a.title===e);if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,r));if(this._map.tables){const a=this._map.tables.find(l=>!!(l.title&&l.title===e||l.title&&l.title===e));if(a){if(a instanceof V.default)return this.resolvePromise(this.makeAndAddFeatureSet(a,t,r));if(!a._materializedTable){const l=a.outFields?a:oe(re({},a),{outFields:["*"]});a._materializedTable=new V.default(l)}return a._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(a._materializedTable,t,r)))}}return this.resolvePromise(null)}featureSetById(e,t=!0,r=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetById(e,t,r)}catch(a){return(0,i.d1)(a)}});null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let a=0;a<this._instantLayers.length;a++){const l=this._instantLayers[a];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}const u=this._map.layers.find(a=>a instanceof V.default&&a.id===e);if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,r));if(this._map.tables){const a=this._map.tables.find(l=>l.id===e);if(a){if(a instanceof V.default)return this.resolvePromise(this.makeAndAddFeatureSet(a,t,r));if(!a._materializedTable){const l=oe(re({},a),{outFields:["*"]});a._materializedTable=new V.default(l)}return a._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(a._materializedTable,t,r)))}}return this.resolvePromise(null)}}class le extends k.Z{constructor(e,t=null,r=null,n=null){super(),this._url=e,this._overridespref=t,this.lrucache=r,this.interceptor=n,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(e,t=!0,r=null){const n=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}_loadMetaData(){return ce(this._url).then(e=>(this.metadata=e,e))}load(){return this._loadMetaData()}clone(){return new le(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let u=0;u<this._instantLayers.length;u++){const a=this._instantLayers[u];if(a.opitem.title===e&&a.includeGeometry===t&&a.outFields===n)return this.resolvePromise(this._instantLayers[u].featureset)}return this._loadMetaData().then(u=>{let a=null;for(const l of u.layers?u.layers:[])l.name===e&&(a=l);if(!a)for(const l of u.tables?u.tables:[])l.name===e&&(a=l);return a?ne(this._url+"/"+a.id,["*"]).then(l=>this.makeAndAddFeatureSet(l,t,r)):this.resolvePromise(null)})}featureSetById(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let u=0;u<this._instantLayers.length;u++){const a=this._instantLayers[u];if(a.opitem.id===e&&a.includeGeometry===t&&a.outFields===n)return this.resolvePromise(this._instantLayers[u].featureset)}return this._loadMetaData().then(u=>{let a=null;for(const l of u.layers?u.layers:[])null!==l.id&&void 0!==l.id&&l.id.toString()===e&&(a=l);if(!a)for(const l of u.tables?u.tables:[])null!==l.id&&void 0!==l.id&&l.id.toString()===e&&(a=l);return a?ne(this._url+"/"+a.id,["*"]).then(l=>this.makeAndAddFeatureSet(l,t,r)):this.resolvePromise(null)})}}function Ee(v,e,t=null,r=null){return new ve(v,e,t,r)}function Re(v,e,t=null,r=null){return new le(v,e,t,r)}function Te(v,e){return null===v?e:new Fe.Z({url:v.field("url")})}function Pe(v,e,t){return G.id.findCredential(v.restUrl)?"loaded"===v.loadStatus&&""===e&&v.user&&v.user.sourceJSON&&!1===t?(0,i.DB)(v.user.sourceJSON):""===e?(0,U.default)(v.restUrl+"/community/self",{responseType:"json",query:re({f:"json"},!1===t?{}:{returnUserLicenseTypeExtensions:!0})}).then(r=>{if(r.data){const n=r.data;if(n&&n.username)return(0,i.DB)(n)}return(0,i.DB)(null)}):(0,U.default)(v.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}}).then(r=>{if(r.data){const n=r.data;return n.error?null:(0,i.DB)(n)}return(0,i.DB)(null)}):(0,i.DB)(null)}function xe(v,e,t,r,n){if(null===v)return null;if(v instanceof V.default){switch(e){case"datasource":return ee(v,n,v.outFields,!0,t,r).getDataSourceFeatureSet();case"parent":case"root":return ee(v,n,v.outFields,!0,t,r)}return null}if(v instanceof A.Z)switch(e){case"datasource":return v.getDataSourceFeatureSet();case"parent":return v;case"root":return v.getRootFeatureSet()}return null}function Oe(v,e,t,r,n,u,a,l=null){if(q.Z.applicationCache){const h=q.Z.applicationCache.getLayerInfo(v+":"+u.url);if(h)return h.then(m=>{try{const R=new V.default({url:(0,y.US)(m.url)+"/"+e,outFields:["*"]});return(0,i.DB)(ee(R,t,r,n,a,l))}catch(R){return(0,i.d1)(R)}},m=>(0,i.d1)(m))}return(0,i.Ue)((h,m)=>{const R=new Se.default({id:v,portal:u}).load();q.Z.applicationCache&&q.Z.applicationCache.setLayerInfo(v+":"+u.url,R),R.then(L=>{try{const O=new V.default({url:(0,y.US)(L.url)+"/"+e,outFields:["*"]});h(ee(O,t,r,n,a,l))}catch(O){m(O)}},L=>{q.Z.applicationCache&&q.Z.applicationCache.clearLayerInfo(v+":"+u.url),m(L)})})}},89899:(J,M,S)=>{S.d(M,{Xx:()=>C,QP:()=>y,$X:()=>F,yN:()=>f,TO:()=>w});var G=S(99326),U=S(74),k=S(66189),T=S(17695),P=S(24642),x=S(18817),I=S(7808),b=S(36403),A=S(96583);class _{constructor(s){this.field=s,this.sqlRewritable=!1}postInitialization(s,c){}}class F extends _{constructor(s){super(s),this.sqlRewritable=!0}extractValue(s){return s.attributes[this.field.name]}rewriteSql(s){return{rewritten:this.sqlRewritable,where:s}}}class y extends _{constructor(s,c,i){super((0,P.JW)(s)),this.originalField=s,this.sqlRewritable=!0,this.field.name=c,this.field.alias=i}rewriteSql(s,c){return{rewritten:this.sqlRewritable,where:(0,x.bB)(s,this.field.name,this.originalField.name,c.getFieldsIndex())}}extractValue(s){return s.attributes[this.originalField.name]}}class w extends _{constructor(s,c,i){super(s),this.codefield=c,this.lkp=i,this.reverseLkp={};for(const d in i)this.reverseLkp[i[d]]=d;this.sqlRewritable=!0}rewriteSql(s,c){const i=this.evaluateNodeToWhereClause(s.parseTree,P.Bj.Standardised,this.field.name,this.codefield instanceof b.WhereClause?(0,x.zR)(this.codefield,P.Bj.Standardised):this.codefield,s.parameters);return i.indexOf(w.BADNESS)>=0?{rewritten:!1,where:s}:{rewritten:this.sqlRewritable,where:b.WhereClause.create(i,c._parent.getFieldsIndex())}}evaluateNodeToWhereClause(s,c,i=null,d=null,o){let p,g,N,B;switch(s.type){case"interval":return(0,x.TE)(this.evaluateNodeToWhereClause(s.value,c,i,d,o),s.qualifier,s.op);case"case_expression":{let E=" CASE ";"simple"===s.format&&(E+=this.evaluateNodeToWhereClause(s.operand,c,i,w.BADNESS,o));for(let j=0;j<s.clauses.length;j++)E+=" WHEN "+this.evaluateNodeToWhereClause(s.clauses[j].operand,c,i,w.BADNESS,o)+" THEN "+this.evaluateNodeToWhereClause(s.clauses[j].value,c,i,w.BADNESS,o);return null!==s.else&&(E+=" ELSE "+this.evaluateNodeToWhereClause(s.else,c,i,w.BADNESS,o)),E+=" END ",E}case"param":{const E=o[s.value.toLowerCase()];if("string"==typeof E)return"'"+o[s.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(E instanceof Date)return(0,x.oX)(E,c);if(E instanceof Array){const j=[];for(let Q=0;Q<E.length;Q++)"string"==typeof E[Q]?j.push("'"+E[Q].toString().replace(/'/g,"''")+"'"):E[Q]instanceof Date?j.push((0,x.oX)(E[Q],c)):j.push(E[Q].toString());return j}return E.toString()}case"expr_list":g=[];for(const E of s.value)g.push(this.evaluateNodeToWhereClause(E,c,i,d,o));return g;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(s.expr,c,i,w.BADNESS,o)+" ) ";case"binary_expr":switch(s.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" AND "+this.evaluateNodeToWhereClause(s.right,c,i,d,o)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" OR "+this.evaluateNodeToWhereClause(s.right,c,i,d,o)+") ";case"IS":if("null"!==s.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" IS NULL )";case"ISNOT":if("null"!==s.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" IS NOT NULL )";case"IN":if(p=[],"expr_list"===s.right.type){if("column_ref"===s.left.type&&s.left.column.toUpperCase()===this.field.name.toUpperCase()){const E=[];let j=!0;for(const Q of s.right.value){if("string"!==Q.type){j=!1;break}if(void 0===this.lkp[Q.value]){j=!1;break}E.push(this.lkp[Q.value].toString())}if(j)return" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" IN ("+E.join(",")+")) "}return p=this.evaluateNodeToWhereClause(s.right,c,i,d,o)," ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" IN ("+p.join(",")+")) "}return B=this.evaluateNodeToWhereClause(s.right,c,i,d,o),B instanceof Array?" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" IN ("+B+")) ";case"NOT IN":if(p=[],"expr_list"===s.right.type){if("column_ref"===s.left.type&&s.left.column.toUpperCase()===this.field.name.toUpperCase()){const E=[];let j=!0;for(const Q of s.right.value){if("string"!==Q.type){j=!1;break}if(void 0===this.lkp[Q.value]){j=!1;break}E.push(this.lkp[Q.value].toString())}if(j)return" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" NOT IN ("+E.join(",")+")) "}return p=this.evaluateNodeToWhereClause(s.right,c,i,d,o)," ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" NOT IN ("+p.join(",")+")) "}return B=this.evaluateNodeToWhereClause(s.right,c,i,d,o),B instanceof Array?" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" NOT IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(s.left,c,i,d,o)+" NOT IN ("+B+")) ";case"BETWEEN":return N=this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)," ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" BETWEEN "+N[0]+" AND "+N[1]+" ) ";case"NOTBETWEEN":return N=this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)," ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" NOT BETWEEN "+N[0]+" AND "+N[1]+" ) ";case"LIKE":return""!==s.escape?" ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" LIKE "+this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)+" ESCAPE '"+s.escape+"') ":" ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" LIKE "+this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)+") ";case"NOT LIKE":return""!==s.escape?" ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" NOT LIKE "+this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)+" ESCAPE '"+s.escape+"') ":" ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" NOT LIKE "+this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)+") ";case"<>":case"=":if("column_ref"===s.left.type&&"string"===s.right.type){if(s.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[s.right.value.toString()])return" ("+d+" "+s.operator+" "+this.lkp[s.right.value.toString()].toString()+") "}else if("column_ref"===s.right.type&&"string"===s.left.type&&s.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[s.right.value.toString()].toString()+" "+s.operator+" "+d+") ";return" ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" "+s.operator+" "+this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(s.left,c,i,w.BADNESS,o)+" "+s.operator+" "+this.evaluateNodeToWhereClause(s.right,c,i,w.BADNESS,o)+") "}throw new Error("Not Supported Operator "+s.operator);case"null":return"null";case"bool":return!0===s.value?"1":"0";case"string":return"'"+s.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,x.oX)(s.value,c);case"number":return s.value.toString();case"current_time":return(0,x.vR)("date"===s.mode,c);case"column_ref":return i&&i.toLowerCase()===s.column.toLowerCase()?"("+d+")":s.column;case"function":{const E=this.evaluateNodeToWhereClause(s.args,c,i,w.BADNESS,o);return(0,x.fz)(s.name,E,c)}}throw new Error("Unsupported sql syntax "+s.type)}extractValue(s){return this.codefield instanceof b.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(s)]:this.reverseLkp[s.attributes[this.codefield]]}}w.BADNESS="_!!!_BAD_LKP_!!!!";class f extends _{constructor(s,c){super(s),this.sql=c}rewriteSql(s,c){return{rewritten:!0,where:(0,x.bB)(s,this.field.name,(0,x.zR)(this.sql,P.Bj.Standardised),c.getFieldsIndex())}}extractValue(s){return this.sql.calculateValueCompiled(s)}}class C extends k.Z{constructor(s){super(s),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=s.extraFilter,this._parent=s.parentfeatureset,this._maxProcessing=30,this.adaptedFields=s.adaptedFields}static findField(s,c){for(const i of s)if(i.name.toLowerCase()===c.toString().toLowerCase())return i;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new A.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=P.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const s of this.adaptedFields)s.postInitialization(this,this._parent),this.fields.push(s.field)}_getSet(s){return null===this._wset?this._ensureLoaded().then(()=>this._extraFilter?this._getFilteredSet("",null,null,null,s):this._parent._getSet(s)).then(c=>(this._checkCancelled(s),this._wset=new T.Z(c._candidates.slice(0),c._known.slice(0),c._ordered,this._clonePageDefinition(c.pagesDefinition)),this._wset)):(0,I.DB)(this._wset)}_isInFeatureSet(s){return this._parent._isInFeatureSet(s)}_getFeatures(s,c,i,d){const o=[];-1!==c&&void 0===this._featureCache[c]&&o.push(c);const p=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(s,p))return this._expandPagedSet(s,p,0,0,d).then(()=>this._getFeatures(s,c,i,d));let g=0;for(let B=s._lastFetchedIndex;B<s._known.length&&(g++,g<=i&&(s._lastFetchedIndex+=1),!(void 0===this._featureCache[s._known[B]]&&(s._known[B]!==c&&o.push(s._known[B]),o.length>=p)));B++);if(0===o.length)return(0,I.DB)("success");s=new T.Z([],o,s._ordered,null);const N=Math.min(o.length,i);return this._parent._getFeatures(s,-1,N,d).then(()=>{this._checkCancelled(d);const B=[];for(let E=0;E<N;E++){const j=this._parent._featureFromCache(o[E]);void 0!==j&&B.push({geometry:j.geometry,attributes:j.attributes,id:o[E]})}for(const E of B){const j=[];for(const Q of this.adaptedFields)j[Q.field.name]=Q.extractValue(E);this._featureCache[E.id]=new G.Z({attributes:j,geometry:(0,U.r1)(E.geometry)})}return"success"})}_fetchAndRefineFeatures(){return(0,I.d1)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(s,c,i,d,o){let p=!1;const g=this.reformulateWithoutAdaptions(i);p=g.cannot,i=g.where;let N=!1;if(null!==d){N=!0;const B=[];for(const E of this.adaptedFields)if(!(E instanceof F)&&!0===d.scanForField(E.field.name)){if(!(E instanceof y)){d=null,N=!1;break}B.push({field:E.field.name,newfield:E.originalField.name})}d&&B.length>0&&(d=d.replaceFields(B))}return null!==i?null!==this._extraFilter&&(i=(0,x.$e)(this._extraFilter,i)):i=this._extraFilter,this._ensureLoaded().then(()=>this._parent._getFilteredSet(s,c,i,d,o)).then(B=>{let E;return this._checkCancelled(o),E=!0===p?new T.Z(B._candidates.slice(0).concat(B._known.slice(0)),[],!0===N&&B._ordered,this._clonePageDefinition(B.pagesDefinition)):new T.Z(B._candidates.slice(0),B._known.slice(0),!0===N&&B._ordered,this._clonePageDefinition(B.pagesDefinition)),E})}reformulateWithoutAdaptions(s){const c={cannot:!1,where:s};if(null!==s)for(const i of this.adaptedFields)if(!0===(0,x.hq)(s,i.field.name)){const d=i.rewriteSql(s,this);if(!0!==d.rewritten){c.cannot=!0,c.where=null;break}c.where=d.where}return c}_stat(s,c,i,d,o,p,g){let N=!1,B=this.reformulateWithoutAdaptions(c);return N=B.cannot,c=B.where,B=this.reformulateWithoutAdaptions(o),N=N||B.cannot,null!==(o=B.where)?null!==this._extraFilter&&(o=(0,x.$e)(this._extraFilter,o)):o=this._extraFilter,!0===N?null===o&&""===i&&null===d?this._manualStat(s,c,p,g):(0,I.DB)({calculated:!1}):this._parent._stat(s,c,i,d,o,p,g).then(E=>!1===E.calculated?null===o&&""===i&&null===d?this._manualStat(s,c,p,g):{calculated:!1}:E)}_canDoAggregates(s,c,i,d,o){if(null===this._parent)return(0,I.DB)(!1);for(let N=0;N<s.length;N++)for(const B of this.adaptedFields)if(s[N].toLowerCase()===B.field.name.toLowerCase()&&!(B instanceof F))return(0,I.DB)(!1);const p=[];for(let N=0;N<c.length;N++){const B=c[N];if(null!==B.workingexpr){const E=this.reformulateWithoutAdaptions(B.workingexpr);if(E.cannot)return(0,I.DB)(!1);const j=B.clone();j.workingexpr=E.where,p.push(j)}else p.push(B)}const g=this.reformulateWithoutAdaptions(o);return g.cannot?(0,I.DB)(!1):(null!==(o=g.where)?null!==this._extraFilter&&(o=(0,x.$e)(this._extraFilter,o)):o=this._extraFilter,this._parent._canDoAggregates(s,p,i,d,o))}_getAggregatePagesDataSourceDefinition(s,c,i,d,o,p,g){if(null===this._parent)return(0,I.d1)(new Error("Should never be called"));const N=[];for(let E=0;E<c.length;E++){const j=c[E];if(null!==j.workingexpr){const Q=this.reformulateWithoutAdaptions(j.workingexpr);if(Q.cannot)return(0,I.d1)(new Error("Should never be called"));const V=j.clone();V.workingexpr=Q.where,N.push(V)}else N.push(j)}const B=this.reformulateWithoutAdaptions(o);return B.cannot?(0,I.d1)(new Error("Should never be called")):(null!==(o=B.where)?null!==this._extraFilter&&(o=(0,x.$e)(this._extraFilter,o)):o=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(s,N,i,d,o,p,g))}}},61634:(J,M,S)=>{S.d(M,{Z:()=>b});var G=S(66189),U=S(17695),k=S(24642),T=S(18817),P=S(7808),x=S(36403),I=S(96583);class b extends G.Z{constructor(_){super(_),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=_.parentfeatureset,_.whereclause instanceof x.WhereClause?(this._whereclause=_.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=_.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new I.Z({wkid:4326}),this.geometryType=k.Qk.point)}_getSet(_){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getFilteredSet("",null,this._whereclause,null,_)).then(F=>(this._checkCancelled(_),null!==this._whereClauseFunction?this._wset=new U.Z(F._candidates.slice(0).concat(F._known.slice(0)),[],F._ordered,this._clonePageDefinition(F.pagesDefinition)):this._wset=new U.Z(F._candidates.slice(0),F._known.slice(0),F._ordered,this._clonePageDefinition(F.pagesDefinition)),this._wset)):(0,P.DB)(this._wset)}_isInFeatureSet(_){let F=this._parent._isInFeatureSet(_);return F===k.dj.NotInFeatureSet?F:(F=this._idstates[_],void 0===F?k.dj.Unknown:F)}_getFeature(_,F,y){return this._parent._getFeature(_,F,y)}_getFeatures(_,F,y,w){return this._parent._getFeatures(_,F,y,w)}_featureFromCache(_){return this._parent._featureFromCache(_)}executeWhereClause(_){return this._whereclause.testFeature(_)}executeWhereClauseDeferred(_){if(null!==this._whereClauseFunction)try{const F=this._whereClauseFunction(_);return(0,P.y8)(F)?F:(0,P.DB)(F)}catch(F){return(0,P.d1)(F)}return(0,P.DB)(this.executeWhereClause(_))}_fetchAndRefineFeatures(_,F,y){const w=new U.Z([],_,!1,null),f=Math.min(F,_.length);return this._parent._getFeatures(w,-1,f,y).then(()=>{if(this._checkCancelled(y),null==this._whereClauseFunction){for(let D=0;D<f;D++){const s=this._parent._featureFromCache(_[D]);!0===this.executeWhereClause(s)?this._idstates[_[D]]=k.dj.InFeatureSet:this._idstates[_[D]]=k.dj.NotInFeatureSet}return"success"}const C=[];for(let D=0;D<f;D++){const s=this._parent._featureFromCache(_[D]);C.push(this.executeWhereClauseDeferred(s))}return(0,P.$6)(C).then(D=>{for(let s=0;s<F;s++)!0===D[s]?this._idstates[_[s]]=k.dj.InFeatureSet:this._idstates[_[s]]=k.dj.NotInFeatureSet;return"success"})})}_getFilteredSet(_,F,y,w,f){return null!==this._whereClauseFunction||(null!==y?null!==this._whereclause&&(y=(0,T.$e)(this._whereclause,y)):y=this._whereclause),this._ensureLoaded().then(()=>this._parent._getFilteredSet(_,F,y,w,f)).then(C=>{let D;return this._checkCancelled(f),D=null!==this._whereClauseFunction?new U.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],C._ordered,this._clonePageDefinition(C.pagesDefinition)):new U.Z(C._candidates.slice(0),C._known.slice(0),C._ordered,this._clonePageDefinition(C.pagesDefinition)),D})}_stat(_,F,y,w,f,C,D){if(null!==this._whereClauseFunction)return null===f&&""===y&&null===w?this._manualStat(_,F,C,D):(0,P.DB)({calculated:!1});let s=this._whereclause;return null!==f&&null!==this._whereclause&&(s=(0,T.$e)(this._whereclause,f)),this._parent._stat(_,F,y,w,s,C,D).then(c=>!1===c.calculated?null===f&&""===y&&null===w?this._manualStat(_,F,C,D):{calculated:!1}:c)}_canDoAggregates(_,F,y,w,f){return null!==this._whereClauseFunction?(0,P.DB)(!1):(null!==f?null!==this._whereclause&&(f=(0,T.$e)(this._whereclause,f)):f=this._whereclause,null===this._parent?(0,P.DB)(!1):this._parent._canDoAggregates(_,F,y,w,f))}_getAggregatePagesDataSourceDefinition(_,F,y,w,f,C,D){return null===this._parent?(0,P.d1)(new Error("Should never be called")):(null!==f?null!==this._whereclause&&(f=(0,T.$e)(this._whereclause,f)):f=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(_,F,y,w,f,C,D))}static registerAction(){G.Z._featuresetFunctions.filter=function(_){if("function"==typeof _)return new b({parentfeatureset:this,whereclause:_});let F=null;return _ instanceof x.WhereClause&&(F=_),new b({parentfeatureset:this,whereclause:F})}}}},59235:(J,M,S)=>{S.d(M,{Z:()=>x});var G=S(31863),U=S(66189),k=S(17695),T=S(30914),P=S(7808);class x extends U.Z{constructor(b){super(b),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=b.orderbyclause,this._parent=b.parentfeatureset}_getSet(b){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,this._orderbyclause,b)).then(A=>(this._checkCancelled(b),this._wset=A,this._wset)):(0,P.DB)(this._wset)}manualOrderSet(b,A){return this.getIdColumnDictionary(b,[],-1,A).then(_=>{this._orderbyclause.order(_);const F=new k.Z([],[],!0,null);for(let y=0;y<_.length;y++)F._known.push(_[y].id);return F})}getIdColumnDictionary(b,A,_,F){if(_<b._known.length-1){const y=this._maxQueryRate();if("GETPAGES"===b._known[_+1])return(0,G.U)(this._parent._expandPagedSet(b,y,0,0,F)).then(()=>this.getIdColumnDictionary(b,A,_,F));let w=_+1;const f=[];for(;w<b._known.length&&"GETPAGES"!==b._known[w];)f.push(b._known[w]),w++;return _+=f.length,(0,G.U)(this._parent._getFeatureBatch(f,F)).then(C=>{this._checkCancelled(F);for(const D of C)A.push({id:D.attributes[this.objectIdField],feature:D});return this.getIdColumnDictionary(b,A,_,F)})}return b._candidates.length>0?(0,G.U)(this._refineSetBlock(b,this._maxProcessingRate(),F)).then(()=>(this._checkCancelled(F),this.getIdColumnDictionary(b,A,_,F))):(0,P.DB)(A)}_isInFeatureSet(b){return this._parent._isInFeatureSet(b)}_getFeatures(b,A,_,F){return this._parent._getFeatures(b,A,_,F)}_featureFromCache(b){if(void 0===this._featureCache[b]){const A=this._parent._featureFromCache(b);return void 0===A?void 0:null===A?null:(this._featureCache[b]=A,A)}return this._featureCache[b]}_fetchAndRefineFeatures(){return(0,P.d1)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(b,A,_,F,y){return this._ensureLoaded().then(()=>this._parent._getFilteredSet(b,A,_,null===F?this._orderbyclause:F,y)).then(w=>{this._checkCancelled(y);const f=new k.Z(w._candidates.slice(0),w._known.slice(0),w._ordered,this._clonePageDefinition(w.pagesDefinition));let C=!0;return w._candidates.length>0&&(C=!1),!1===f._ordered?this.manualOrderSet(f,y).then(D=>(!1===C&&(null===A&&null===_||(D=new k.Z(D._candidates.slice(0).concat(D._known.slice(0)),[],D._ordered,this._clonePageDefinition(D.pagesDefinition)))),D)):f})}static registerAction(){U.Z._featuresetFunctions.orderBy=function(b){return""===b?this:new x({parentfeatureset:this,orderbyclause:new T.Z(b)})}}}},27414:(J,M,S)=>{S.d(M,{Z:()=>P});var G=S(66189),U=S(17695),k=S(24642),T=S(7808);class P extends G.Z{constructor(I){super(I),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=I.topnum,this._parent=I.parentfeatureset}_getSet(I){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getSet(I)).then(b=>(this._wset=new U.Z(b._candidates.slice(0),b._known.slice(0),!1,this._clonePageDefinition(b.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset)):(0,T.DB)(this._wset)}_setKnownLength(I){return I._known.length>0&&"GETPAGES"===I._known[I._known.length-1]?I._known.length-1:I._known.length}_isInFeatureSet(I){const b=this._parent._isInFeatureSet(I);if(b===k.dj.NotInFeatureSet)return b;const A=this._idstates[I];return A===k.dj.InFeatureSet||A===k.dj.NotInFeatureSet?A:b===k.dj.InFeatureSet&&void 0===A?this._countedin<this._topnum?(this._idstates[I]=k.dj.InFeatureSet,this._countedin++,k.dj.InFeatureSet):(this._idstates[I]=k.dj.NotInFeatureSet,k.dj.NotInFeatureSet):k.dj.Unknown}_expandPagedSet(I,b,A,_,F){if(null===this._parent)return(0,T.d1)(new Error("Parent Paging not implemented"));if(b>this._topnum&&(b=this._topnum),this._countedin>=this._topnum&&I.pagesDefinition.internal.set.length<=I.pagesDefinition.resultOffset){let y=I._known.length;return y>0&&"GETPAGES"===I._known[y-1]&&(I._known.length=y-1),y=I._candidates.length,y>0&&"GETPAGES"===I._candidates[y-1]&&(I._candidates.length=y-1),(0,T.DB)("success")}return this._parent._expandPagedSet(I,b,A,_,F).then(y=>(this._setKnownLength(I)>this._topnum&&(I._known.length=this._topnum),this._setKnownLength(I)>=this._topnum&&(I._candidates.length=0),y))}_getFeatures(I,b,A,_){const F=[],y=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(I,y))return this._expandPagedSet(I,y,0,0,_).then(()=>this._getFeatures(I,b,A,_));-1!==b&&void 0===this._featureCache[b]&&F.push(b);let w=0;for(let D=I._lastFetchedIndex;D<I._known.length&&(w++,w<=A&&(I._lastFetchedIndex+=1),!(void 0===this._featureCache[I._known[D]]&&(I._known[D]!==b&&F.push(I._known[D]),F.length>y)));D++);if(0===F.length)return(0,T.DB)("success");const f=new U.Z([],F,!1,null),C=Math.min(F.length,A);return this._parent._getFeatures(f,-1,C,_).then(()=>{for(let D=0;D<C;D++){const s=this._parent._featureFromCache(F[D]);void 0!==s&&(this._featureCache[F[D]]=s)}return"success"})}_getFilteredSet(I,b,A,_,F){return this._ensureLoaded().then(()=>this._getSet(F)).then(y=>new U.Z(y._candidates.slice(0).concat(y._known.slice(0)),[],!1,this._clonePageDefinition(y.pagesDefinition)))}_refineKnowns(I,b){let A=0,_=null;const F=[];for(let y=0;y<I._candidates.length;y++){const w=this._isInFeatureSet(I._candidates[y]);if(w===k.dj.InFeatureSet){if(I._known.push(I._candidates[y]),A+=1,null===_?_={start:y,end:y}:_.end===y-1?_.end=y:(F.push(_),_={start:y,end:y}),I._known.length>=this._topnum)break}else if(w===k.dj.NotInFeatureSet)null===_?_={start:y,end:y}:_.end===y-1?_.end=y:(F.push(_),_={start:y,end:y}),A+=1;else if(w===k.dj.Unknown)break;if(A>=b)break}null!==_&&F.push(_);for(let y=F.length-1;y>=0;y--)I._candidates.splice(F[y].start,F[y].end-F[y].start+1);this._setKnownLength(I)>this._topnum&&(I._known=I._known.slice(0,this._topnum)),this._setKnownLength(I)>=this._topnum&&(I._candidates=[])}_stat(){return(0,T.DB)({calculated:!1})}_canDoAggregates(){return(0,T.DB)(!1)}static registerAction(){G.Z._featuresetFunctions.top=function(I){return new P({parentfeatureset:this,topnum:I})}}}},23956:(J,M,S)=>{S.d(M,{Z:()=>y});var G=S(99326),U=S(66189),k=S(17695),T=S(24642),P=S(18817),x=S(7808),I=S(20119),b=S(33830),A=S(33912),_=S(66536),F=S(37995);class y extends U.Z{constructor(f){super(f),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,f.spatialReference&&(this.spatialReference=f.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=f.layer,this._wset=null,!0===f.isTable&&(this._forceIsTable=!0),void 0!==f.outFields&&(this._overrideFields=f.outFields),void 0!==f.includeGeometry&&(this._removeGeometry=!1===f.includeGeometry)}_maxQueryRate(){return T.tI}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,x.Ue)((f,C)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void f(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),f(this)}catch(D){C(D)}},C),this._layer.load()})),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const f=[];for(const C of this.fields)if("oid"===C.type)f.push(C);else for(const D of this._layer.outFields)if(D.toLowerCase()===C.name.toLowerCase()){f.push(C);break}this.fields=f}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const f=[],C=[];for(const D of this.fields)if("oid"===D.type)f.push(D),C.push(D.name);else for(const s of this._overrideFields)if(s.toLowerCase()===D.name.toLowerCase()){f.push(D),C.push(D.name);break}this.fields=f,this._overrideFields=C}this.objectIdField=this._layer.objectIdField;for(const f of this.fields)"global-id"===f.type&&(this.globalIdField=f.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=T.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return T.dj.InFeatureSet}_candidateIdTransform(f){return f}_getSet(f){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,f)).then(C=>(this._wset=C,C)):(0,x.DB)(this._wset)}_changeFeature(f){const C={};for(const D of this.fields)C[D.name]=f.attributes[D.name];return new G.Z({geometry:!0===this._removeGeometry?null:f.geometry,attributes:C})}_getFilteredSet(f,C,D,s,c){let i="",d=!1;if(null!==s&&(i=s.constructClause(),d=!0),this.isTable()&&C&&null!==f&&""!==f){const p=new k.Z([],[],!0,null);return(0,x.DB)(p)}const o=new F.Z;return o.where=null===D?null===C?"1=1":"":(0,P.zR)(D,T.Bj.Standardised),o.spatialRelationship=this._makeRelationshipEnum(f),o.outSpatialReference=this.spatialReference,o.orderByFields=""!==i?i.split(","):null,o.geometry=null===C?null:C,o.returnGeometry=!0,o.relationParameter=this._makeRelationshipParam(f),this._layer.queryFeatures(o).then(p=>{if(null===p)return new k.Z([],[],d,null);this._checkCancelled(c);const g=[];return p.features.forEach(N=>{const B=N.attributes[this._layer.objectIdField];g.push(B),this._featureCache[B]=this._changeFeature(N)}),new k.Z([],g,d,null)})}_makeRelationshipEnum(f){if(f.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(f){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return f}_makeRelationshipParam(f){return f.indexOf("esriSpatialRelRelation")>=0?f.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return(0,x.DB)(this._wset);const f=new F.Z;return f.where="1=1",this._ensureLoaded().then(()=>{if(this._layer.source&&this._layer.source.items){const C=[];return this._layer.source.items.forEach(D=>{const s=D.attributes[this._layer.objectIdField];C.push(s),this._featureCache[s]=this._changeFeature(D)}),this._wset=new k.Z([],C,!1,null),this._wset}return this._layer.queryFeatures(f).then(C=>{const D=[];return C.features.forEach(s=>{const c=s.attributes[this._layer.objectIdField];D.push(c),this._featureCache[c]=this._changeFeature(s)}),this._wset=new k.Z([],D,!1,null),this._wset})})}_getFeatures(f,C,D){const s=[];-1!==C&&void 0===this._featureCache[C]&&s.push(C);for(let c=f._lastFetchedIndex;c<f._known.length&&(f._lastFetchedIndex+=1,!(void 0===this._featureCache[f._known[c]]&&(f._known[c]!==C&&s.push(f._known[c]),s.length>D)));c++);return 0===s.length?(0,x.DB)("success"):(0,x.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(f){return(0,x.DB)(f)}_stat(){return(0,x.DB)({calculated:!1})}_canDoAggregates(){return(0,x.DB)(!1)}relationshipMetaData(){return[]}static _cloneAttr(f){const C={};for(const D in f)C[D]=f[D];return C}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(f,C){let D=f.layerDefinition.objectIdField;const s=f.layerDefinition.typeIdField?f.layerDefinition.typeIdField:"",c=[];if(f.layerDefinition.types)for(const E of f.layerDefinition.types)c.push(A.Z.fromJSON(E));let i=f.layerDefinition.geometryType;void 0===i&&(i=f.featureSet.geometryType||"");let d=f.featureSet.features;const o=C.toJSON();if(""===D||void 0===D){let E=!1;for(const j of f.layerDefinition.fields)if("oid"===j.type||"esriFieldTypeOID"===j.type){D=j.name,E=!0;break}if(!1===E){let j="FID",Q=!0,V=0;for(;Q;){let $=!0;for(const ie of f.layerDefinition.fields)if(ie.name===j){$=!1;break}!0===$?Q=!1:(V++,j="FID"+V.toString())}f.layerDefinition.fields.push({type:"esriFieldTypeOID",name:j,alias:j});const te=[];for(let $=0;$<d.length;$++)te.push({geometry:f.featureSet.features[$].geometry,attributes:f.featureSet.features[$].attributes?this._cloneAttr(f.featureSet.features[$].attributes):{}}),te[$].attributes[j]=$;d=te,D=j}}const p=[];for(const E of f.layerDefinition.fields)E instanceof _.Z?p.push(E):p.push(_.Z.fromJSON(E));let g=i;switch(g){case"esriGeometryPoint":g="point";break;case"esriGeometryPolyline":g="polyline";break;case"esriGeometryPolygon":g="polygon";break;case"esriGeometryExtent":g="extent";break;case"esriGeometryMultipoint":g="multipoint"}for(const E of d)E.geometry&&!(E.geometry instanceof I.Z)&&(E.geometry.type=g,void 0===E.geometry.spatialReference&&(E.geometry.spatialReference=o));const N={outFields:["*"],source:d,fields:p,types:c,typeIdField:s,objectIdField:D,spatialReference:C};N.geometryType=g||"point";const B=new b.default(N);return new y({layer:B,spatialReference:C,isTable:null===g||""===g})}queryAttachments(){return(0,x.DB)([])}getFeatureByObjectId(f){const C=new F.Z;return C.where=this.objectIdField+"="+f.toString(),this._layer.queryFeatures(C).then(D=>1===D.features.length?D.features[0]:null)}getOwningSystemUrl(){return(0,x.DB)("")}getIdentityUser(){return(0,x.DB)("")}}},30914:(J,M,S)=>{function G(k,T){return k===T?0:null===k?-1:null===T?1:k<T?-1:1}S.d(M,{Z:()=>U});class U{constructor(T){const P=T.split(",");this._fields=[],this._directions=[];for(let x=0;x<P.length;x++){const I=P[x].match(/\S+/g);this._fields.push(I[0]),2===I.length?"asc"===I[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let T="";for(let P=0;P<this._fields.length;P++)0!==P&&(T+=","),T+=this._fields[P],1===this._directions[P]?T+=" ASC":T+=" DESC";return T}order(T){T.sort((P,x)=>{for(let I=0;I<this._fields.length;I++){const b=this.featureValue(P.feature,this._fields[I],I),A=this.featureValue(x.feature,this._fields[I],I);let _=0;if(_=1===this._directions[I]?G(b,A):-1*G(b,A),0!==_)return _}return 0})}scanForField(T){for(let P=0;P<this._fields.length;P++)if(this._fields[P].toLowerCase().trim()===T.toLowerCase().trim())return!0;return!1}replaceFields(T){let P="";for(let x=0;x<this._fields.length;x++){0!==x&&(P+=",");let I=this._fields[x];for(const b of T)if(I.toLowerCase()===b.field.toLowerCase()){I=b.newfield;break}P+=I,1===this._directions[x]?P+=" ASC":P+=" DESC"}return new U(P)}featureValue(T,P,x){const I=T.attributes[P];if(void 0!==I)return I;for(const b in T.attributes)if(P.toLowerCase()===b.toLowerCase())return this._fields[x]=b,T.attributes[b];return null}}},22404:(J,M,S)=>{S.d(M,{F:()=>D,M:()=>G});const G={Base64:0,Hex:1,String:2,Raw:3};function T(s,c){const i=(65535&s)+(65535&c);return(s>>16)+(c>>16)+(i>>16)<<16|65535&i}function _(s,c,i,d,o,p){return T(function(s,c){return s<<c|s>>>32-c}(T(T(c,s),T(d,p)),o),i)}function F(s,c,i,d,o,p,g){return _(c&i|~c&d,s,c,o,p,g)}function y(s,c,i,d,o,p,g){return _(c&d|i&~d,s,c,o,p,g)}function w(s,c,i,d,o,p,g){return _(c^i^d,s,c,o,p,g)}function f(s,c,i,d,o,p,g){return _(i^(c|~d),s,c,o,p,g)}function D(s,c=G.Hex){const i=c||G.Base64,d=function(s,c){s[c>>5]|=128<<c%32,s[14+(c+64>>>9<<4)]=c;let i=1732584193,d=-271733879,o=-1732584194,p=271733878;for(let g=0;g<s.length;g+=16){const N=i,B=d,E=o,j=p;i=F(i,d,o,p,s[g+0],7,-680876936),p=F(p,i,d,o,s[g+1],12,-389564586),o=F(o,p,i,d,s[g+2],17,606105819),d=F(d,o,p,i,s[g+3],22,-1044525330),i=F(i,d,o,p,s[g+4],7,-176418897),p=F(p,i,d,o,s[g+5],12,1200080426),o=F(o,p,i,d,s[g+6],17,-1473231341),d=F(d,o,p,i,s[g+7],22,-45705983),i=F(i,d,o,p,s[g+8],7,1770035416),p=F(p,i,d,o,s[g+9],12,-1958414417),o=F(o,p,i,d,s[g+10],17,-42063),d=F(d,o,p,i,s[g+11],22,-1990404162),i=F(i,d,o,p,s[g+12],7,1804603682),p=F(p,i,d,o,s[g+13],12,-40341101),o=F(o,p,i,d,s[g+14],17,-1502002290),d=F(d,o,p,i,s[g+15],22,1236535329),i=y(i,d,o,p,s[g+1],5,-165796510),p=y(p,i,d,o,s[g+6],9,-1069501632),o=y(o,p,i,d,s[g+11],14,643717713),d=y(d,o,p,i,s[g+0],20,-373897302),i=y(i,d,o,p,s[g+5],5,-701558691),p=y(p,i,d,o,s[g+10],9,38016083),o=y(o,p,i,d,s[g+15],14,-660478335),d=y(d,o,p,i,s[g+4],20,-405537848),i=y(i,d,o,p,s[g+9],5,568446438),p=y(p,i,d,o,s[g+14],9,-1019803690),o=y(o,p,i,d,s[g+3],14,-187363961),d=y(d,o,p,i,s[g+8],20,1163531501),i=y(i,d,o,p,s[g+13],5,-1444681467),p=y(p,i,d,o,s[g+2],9,-51403784),o=y(o,p,i,d,s[g+7],14,1735328473),d=y(d,o,p,i,s[g+12],20,-1926607734),i=w(i,d,o,p,s[g+5],4,-378558),p=w(p,i,d,o,s[g+8],11,-2022574463),o=w(o,p,i,d,s[g+11],16,1839030562),d=w(d,o,p,i,s[g+14],23,-35309556),i=w(i,d,o,p,s[g+1],4,-1530992060),p=w(p,i,d,o,s[g+4],11,1272893353),o=w(o,p,i,d,s[g+7],16,-155497632),d=w(d,o,p,i,s[g+10],23,-1094730640),i=w(i,d,o,p,s[g+13],4,681279174),p=w(p,i,d,o,s[g+0],11,-358537222),o=w(o,p,i,d,s[g+3],16,-722521979),d=w(d,o,p,i,s[g+6],23,76029189),i=w(i,d,o,p,s[g+9],4,-640364487),p=w(p,i,d,o,s[g+12],11,-421815835),o=w(o,p,i,d,s[g+15],16,530742520),d=w(d,o,p,i,s[g+2],23,-995338651),i=f(i,d,o,p,s[g+0],6,-198630844),p=f(p,i,d,o,s[g+7],10,1126891415),o=f(o,p,i,d,s[g+14],15,-1416354905),d=f(d,o,p,i,s[g+5],21,-57434055),i=f(i,d,o,p,s[g+12],6,1700485571),p=f(p,i,d,o,s[g+3],10,-1894986606),o=f(o,p,i,d,s[g+10],15,-1051523),d=f(d,o,p,i,s[g+1],21,-2054922799),i=f(i,d,o,p,s[g+8],6,1873313359),p=f(p,i,d,o,s[g+15],10,-30611744),o=f(o,p,i,d,s[g+6],15,-1560198380),d=f(d,o,p,i,s[g+13],21,1309151649),i=f(i,d,o,p,s[g+4],6,-145523070),p=f(p,i,d,o,s[g+11],10,-1120210379),o=f(o,p,i,d,s[g+2],15,718787259),d=f(d,o,p,i,s[g+9],21,-343485551),i=T(i,N),d=T(d,B),o=T(o,E),p=T(p,j)}return[i,d,o,p]}(function(s){const c=[];for(let i=0,d=8*s.length;i<d;i+=8)c[i>>5]|=(255&s.charCodeAt(i/8))<<i%32;return c}(s),8*s.length);switch(i){case G.Raw:return d;case G.Hex:return function(s){const c="0123456789abcdef",i=[];for(let d=0,o=4*s.length;d<o;d++)i.push(c.charAt(s[d>>2]>>d%4*8+4&15)+c.charAt(s[d>>2]>>d%4*8&15));return i.join("")}(d);case G.String:return function(s){const c=[];for(let i=0,d=32*s.length;i<d;i+=8)c.push(String.fromCharCode(s[i>>5]>>>i%32&255));return c.join("")}(d);case G.Base64:return function(s){const d=[];for(let o=0,p=4*s.length;o<p;o+=3){const g=(s[o>>2]>>o%4*8&255)<<16|(s[o+1>>2]>>(o+1)%4*8&255)<<8|s[o+2>>2]>>(o+2)%4*8&255;for(let N=0;N<4;N++)8*o+6*N>32*s.length?d.push("="):d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g>>6*(3-N)&63))}return d.join("")}(d)}}}}]);
//# sourceMappingURL=9000.7608e71048638330aecb.js.map